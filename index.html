<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Pedidos ML</title>
  <meta name="theme-color" content="#06b6d4" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    /* Gradiente por defecto: Azul ‚Üí Verde */
    --primary:   #06b6d4; /* c1 */
    --primary-2: #22c55e; /* c2 */
    --primary-light: rgba(6,182,212,.22);
    --primary-rgb: 6,182,212;
    --primary-2-rgb: 34,197,94;

    /* --- TEMA CLARO (Default) --- */
    --bg: #f4f5f9;
    --text: #111827;
    --card: #ffffff;
    --muted: #6b7280;
    --border: #e5e7eb;
    --border-tint: #e5e7eb;
    --field-text: #0b0f14;
    --placeholder: rgba(11,15,20,.55);
    --bg-grad-start: #f7f9ff;
    --bg-grad-end:   #eef2ff;
    --card-grad-start:#ffffff;
    --card-grad-end:  #f3f6ff;
    --field-grad-start:#ffffff;
    --field-grad-end:  #f8f9fc;
    --success: #16a34a;
    --error: #ef4444;
    --shadow: 0 4px 12px rgba(0,0,0,0.10);
    --shadow-lg: 0 10px 30px rgba(0,0,0,0.16);

    --radius-pill: 999px;
  }

  /* --- MODO OSCURO --- */
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #0A0C10;
      --text: #f0f6fc;
      --card: #161b22;
      --muted: #8b949e;
      --border: #30363d;
      --border-tint: #30363d;
      --bg-grad-start: #0A0C10;
      --bg-grad-end:   #0d1117;
      --card-grad-start:#161b22;
      --card-grad-end:  #1a2028;
      --field-grad-start:#101419;
      --field-grad-end:  #101419;
      --shadow: 0 6px 16px rgba(0,0,0,0.35);
      --shadow-lg: 0 12px 32px rgba(0,0,0,0.45);
      --field-text: #f0f6fc;
      --placeholder: rgba(240, 246, 252, 0.45);
    }
  }

  html,body{ height: 100%; }
  body{
    font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
    margin: 0;
    padding: 0 0 180px 0;
    background:
      radial-gradient(1200px 600px at 0% -10%, rgba(var(--primary-rgb), .18), transparent 60%),
      radial-gradient(900px 500px at 110% 0%, rgba(var(--primary-2-rgb), .24), transparent 55%),
      linear-gradient(180deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    color: var(--text);
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background 300ms ease, color 300ms ease;
  }

  header{
    position: sticky; top: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
    background: linear-gradient(180deg, rgba(var(--card-grad-start),.85), rgba(var(--card-grad-end),.85));
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    color: var(--text);
    padding: 16px;
    border-bottom: 1px solid var(--border-tint);
    transition: background 300ms ease, border-color 300ms ease;
  }

  .header-title{ font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;}
  #pedidoContador{
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
    color: white;
    font-size: 12px; font-weight: 700;
    padding: 4px 8px; border-radius: 999px; min-width: 12px; text-align: center;
    box-shadow: 0 6px 18px rgba(var(--primary-rgb),.35);
  }

  #connDot{ width: 12px; height: 12px; border-radius: 50%; border: 2px solid transparent; box-shadow: 0 0 0 2px var(--border-tint); flex-shrink: 0; }
  .online{ background: #22c55e; }
  .offline{ background: #ef4444; }
  .syncing{ background: #facc15; animation:pulse 0.8s ease-in-out infinite alternate; }
  @keyframes pulse{ from{ opacity: 1; } to{ opacity: 0.4; } }

  .conn-label{ margin-left: 8px; font-size: 12px; font-style: italic; letter-spacing: .1px; opacity: .85; min-width: 96px; display: inline-block; }
  #connDot.online  + .conn-label::before{ content: "en l√≠nea";      color:#22c55e; }
  #connDot.offline + .conn-label::before{ content: "sin conexi√≥n";  color:#ef4444; }
  #connDot.syncing + .conn-label::before{ content: "sincronizando‚Ä¶"; color:#f59e0b; }

  #netBanner{ display:none; text-align:center; background:#facc15; color:#1f2937; padding: 8px; font-weight: 600; font-size: 14px; }

  main{ padding: 20px; max-width: 860px; margin: 0 auto; }
  h3 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }

  .row { margin-bottom: 18px; }
  label { display: flex; align-items: center; font-size: 14px; font-weight: 500; color: var(--muted); margin-bottom: 8px; }

  input, textarea, select {
    width: 100%; box-sizing: border-box; font-family: 'Inter', sans-serif;
    font-size: 16px; padding: 16px; border-radius: 14px;
    border: 1px solid var(--border-tint);
    background: linear-gradient(180deg, var(--field-grad-start), var(--field-grad-end));
    color: var(--field-text) !important; caret-color: var(--primary); outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background 300ms ease, color .2s ease;
    -webkit-appearance: none; background-clip: padding-box;
  }
  input::placeholder, textarea::placeholder{ color: var(--placeholder); }
  input:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
  textarea { min-height: 120px; resize: vertical; }

  .row:has(#shareWA) { display: none; }
  #btnNuevoLote { display: none; }

  /* === Botones estilo ‚Äúpill‚Äù con degradado === */
  .btn, .btn-secondary{
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    border-radius: var(--radius-pill);
    padding: 14px 18px; font-weight: 700; font-size: 15px; border: none; cursor: pointer;
    transition: transform .12s ease, filter .15s ease, box-shadow .25s ease, background .25s ease, color .2s ease;
  }
  .btn{
    color: #fff;
    background:
      linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0) 40%) ,
      linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
    box-shadow:
      0 20px 40px rgba(var(--primary-rgb), .35),
      0 6px 16px rgba(0,0,0,.12);
    filter: saturate(115%) contrast(105%);
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:active{ transform: translateY(0) scale(.98); filter: brightness(1.06) saturate(120%); }
  .btn[disabled], .btn.cooldown{ opacity:.72; cursor:not-allowed; filter: grayscale(.25); box-shadow: var(--shadow); pointer-events: none; }

  .btn-secondary{
    color: var(--text);
    background:
      linear-gradient(var(--card-grad-start), var(--card-grad-end)) padding-box,
      linear-gradient(90deg, var(--primary), var(--primary-2)) border-box;
    border: 2px solid transparent;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
  }
  .btn-secondary:hover{ transform: translateY(-1px); }
  .btn-secondary:active{
    color: #fff;
    background:
      linear-gradient(90deg, var(--primary), var(--primary-2)) padding-box,
      linear-gradient(90deg, var(--primary), var(--primary-2)) border-box;
    box-shadow: 0 12px 26px rgba(var(--primary-rgb), .28), 0 3px 10px rgba(0,0,0,.10);
  }

  /* Bot√≥n flotante principal (se angosta para dejar lugar al mic) */
  #btnEnviar {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
    z-index: 998; width: calc(80% - 80px); max-width: 410px;  /* <-- ajustado */
    display: flex; align-items: center; justify-content: center;
    padding: 18px; font-size: 16px; border-radius: var(--radius-pill);
    background:
      radial-gradient(120% 160% at 0% 0%, rgba(255,255,255,.25), rgba(255,255,255,0) 40%),
      linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
    color: #fff;
    box-shadow:
      0 28px 60px rgba(var(--primary-rgb), .45),
      0 10px 22px rgba(0,0,0,.14);
  }
  #btnEnviar:active { transform: translateX(-50%) scale(0.98); filter: brightness(1.06) saturate(120%); }

  .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .btn[disabled] .btn-text { display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* === FAB de micr√≥fono (nuevo, no rompe nada) === */
  #btnMic{
    position: fixed; right: 14px; bottom: 90px; z-index: 999;
    width: 60px; height: 60px; border-radius: 50%;
    border: none; cursor: pointer; color:#fff; font-size:24px; line-height: 0;
    display:flex; align-items:center; justify-content:center;
    background:
      linear-gradient(180deg, rgba(255,255,255,.21), rgba(255,255,255,0) 40%),
      linear-gradient(90deg, var(--primary), var(--primary-2));
    box-shadow: 0 16px 36px rgba(var(--primary-rgb), .45), 0 8px 18px rgba(0,0,0,.18);
    transition: transform .12s ease, filter .15s ease;
  }
  #btnMic:active{ transform: scale(.98); filter: brightness(1.06) saturate(120%); }
  #btnMic.rec{ animation: blip 0.8s ease-in-out infinite alternate; }
  @keyframes blip{ from{ box-shadow: 0 0 0 0 rgba(var(--primary-rgb), .55);} to{ box-shadow: 0 0 0 12px rgba(var(--primary-rgb), .0);} }

  /* Bottom nav */
  .bottom-nav{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 999;
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-top: 1px solid var(--border-tint);
    display: flex; gap: 10px; padding: 12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    transition: background 300ms ease, border-color 300ms ease;
  }
  .bottom-nav button{
    flex: 1; border-radius: 12px; padding: 14px 8px; font-weight: 600; border: none;
    background: transparent; color: var(--muted); transition: all .2s ease;
  }
  .bottom-nav button.active{
    background: linear-gradient(90deg, var(--primary), var(--primary-2));
    color: #fff; box-shadow: 0 8px 22px rgba(var(--primary-rgb),.28);
  }

  .pedido-card, .stat-card {
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    border: 1px solid var(--border-tint);
    border-radius: 16px; padding: 16px; margin-bottom: 14px; box-shadow: var(--shadow);
    transition: background 300ms ease, border-color 300ms ease;
  }
  .pedido-card hr { border: none; border-top: 1px solid var(--border-tint); margin: 12px 0; }

  .toast{
    position: fixed; left: 50%; top: 16px; transform: translateX(-50%);
    color: #fff; padding: 14px 20px; border-radius: 12px; font-size: 15px; font-weight: 500;
    box-shadow: var(--shadow-lg); z-index: 1001; opacity: 0; animation: fadeInDown .3s ease forwards;
  }
  @keyframes fadeInDown { from { top: -20px; opacity: 0; } to { top: 16px; opacity: 1; } }

  #confirmOverlay{ display: none; position: fixed; inset: 0; z-index: 1002; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; animation: fadeIn .3s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .success-box{
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    color: var(--text); border-radius: 24px; padding: 36px 28px; text-align: center; width: min(90vw, 320px);
    box-shadow: var(--shadow-lg); animation: popIn .35s cubic-bezier(0.25, 0.46, 0.45, 0.94); border: 1px solid var(--border-tint);
  }
  @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .success-box h2{ margin: 16px 0 0 0; font-size: 22px; }
  .success-box p { opacity:.7; margin:6px 0 0 0; }

  .checkmark-svg { width: 80px; height: 80px; }
  .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke: var(--success); fill: none; animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
  @keyframes stroke { 100% { stroke-dashoffset: 0; } }
  .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke-width: 4; stroke: var(--success); stroke-linecap: round; fill: none; animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; }

  .stats-grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 8px; }
  .stat-title{ font-size: 13px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
  .stat-value{ font-size: 26px; font-weight: 700; }
  .bar{ margin-top: 10px; height: 8px; border-radius: 999px; background: var(--border-tint); overflow: hidden; }
  .bar > .fill{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--primary-2)); transition: width .4s ease; }

  /* === Selector de tema moderno === */
 .theme-row{
  display:flex; align-items:center; gap:10px; margin:10px 0 22px 0; flex-wrap:wrap;
}
.theme-row span{ font-weight:700; color:var(--muted); margin-right:2px; }

.swatch{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
  border-radius: var(--radius-pill);
  color:#fff; font-weight:700; font-size:13px; letter-spacing:.2px;
  border:2px solid transparent; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.08);
  user-select:none; transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
}
.swatch:hover{ transform: translateY(-1px); box-shadow:0 12px 26px rgba(0,0,0,.12); }
.swatch:active{ transform: translateY(0) scale(.98); filter:brightness(1.04); }

  .search-row{ display: flex; gap: 8px; margin-bottom: 10px; }
  .search-row input{ flex:1; }
  .search-row .btn, .search-row .btn-secondary { width: auto; flex-shrink: 0; min-width: 72px; }

  .pend-legend{ font-size: 12px; color: var(--muted); display: grid; gap: 4px; margin: 6px 2px 14px; }
  .pend-legend b{ color: var(--text); font-weight: 600; }

  /* Que el contenedor no quede tapado por el bot√≥n fijo al hacer scroll */
  #rowObs{ scroll-margin-bottom: 140px; }
  /* Altura c√≥moda + scroll interno elegante */
  #observaciones{
    min-height: 120px; max-height: 45vh; overflow: auto; line-height: 1.35;
    scrollbar-gutter: stable; overscroll-behavior: contain;
  }
  #observaciones:focus{ max-height: 60vh; }
  #observaciones::-webkit-scrollbar{ width: 10px; }
  #observaciones::-webkit-scrollbar-track{ background: var(--card-grad-end); border-radius: 999px; }
  #observaciones::-webkit-scrollbar-thumb{
    background: linear-gradient(180deg, var(--primary), var(--primary-2)); border-radius: 999px;
  }
  #observaciones::-webkit-scrollbar-thumb:hover{ filter: brightness(1.08); }
  #observaciones{ scrollbar-width: thin; scrollbar-color: var(--primary) var(--card-grad-end); }

  /* === Modal de dictado (nuevo) === */
  #dictadoOverlay{ display:none; position:fixed; inset:0; z-index:1003;
    background: rgba(0,0,0,.55); backdrop-filter: blur(4px);
    align-items:center; justify-content:center; }
  .dictado-box{
    width:min(92vw,720px); max-height:80vh; overflow:auto;
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    border:1px solid var(--border-tint); border-radius: 18px; padding:18px;
    box-shadow: var(--shadow-lg);
  }
  .dictado-head{ display:flex; align-items:center; gap:10px; }
  .dot-rec{ width:10px; height:10px; border-radius:50%; background:#ef4444; animation:rec 1s linear infinite alternate; }
  @keyframes rec{ from{ opacity:.3 } to{ opacity:1 } }
  #dictadoPreview{
    width:100%; min-height:180px; margin:12px 0;
    border-radius:14px; border:1px solid var(--border-tint);
    background: linear-gradient(180deg, var(--field-grad-start), var(--field-grad-end));
    padding:14px; font-family:inherit; font-size:15px; line-height:1.35;
  }
  .dictado-actions{ display:flex; gap:10px; justify-content:flex-end; }
</style>
</head>
<body>
  <div id="netBanner">üì° Sin conexi√≥n ‚Äî los pedidos se guardan localmente</div>
  <header>
    <div class="header-title">
        <span>üõí Pedidos ML</span>
        <span id="pedidoContador">0</span>
    </div>
    <div id="connDot" class="offline"></div>
    <span class="conn-label"></span>
  </header>

  <main id="nuevoPedido">
    <div id="helloBanner"></div>

    <!-- === Selector de tema (solo visual) === -->
    <div class="theme-row">
      <span>üé® Tema:</span>
      <div class="swatch" data-color="#06b6d4,#22c55e"
           style="background:linear-gradient(90deg,#06b6d4,#22c55e)">Azul ‚Üí Verde</div>

      <div class="swatch" data-color="#2563eb,#06b6d4"
           style="background:linear-gradient(90deg,#2563eb,#06b6d4)">Azul ‚Üí Cian</div>

      <div class="swatch" data-color="#db2777,#f59e0b"
           style="background:linear-gradient(90deg,#db2777,#f59e0b)">Rosa ‚Üí Naranja</div>

      <div class="swatch" data-color="#8b5cf6,#ec4899"
           style="background:linear-gradient(90deg,#8b5cf6,#ec4899)">Violeta ‚Üí Magenta</div>

    </div>

    <div class="row" id="rowFecha">
      <label>üìÖ Fecha de entrega</label>
      <input type="date" id="fechaEntrega" />
    </div>
    <div class="row" id="rowCliente">
      <label>üßæ N√∫mero de cliente</label>
      <input type="tel" inputmode="numeric" pattern="[0-9]*" id="numeroCliente" placeholder="Ej: 10331" autocomplete="off" />
    </div>
    <div class="row" id="rowVendedor">
      <label>üë§ Nombre del vendedor</label>
      <input type="text" id="nombreVendedor" placeholder="Ej: Josue" />
    </div>
    <div class="row" id="rowProductos">
      <label>üì¶ Productos solicitados</label>
      <textarea id="productos" rows="4" placeholder="Detalle de productos..." autocapitalize="characters" autocorrect="off" inputmode="text"></textarea>
    </div>
    <div class="row" id="rowObs">
      <label>üóíÔ∏è Observaciones (opcional)</label>
      <textarea id="observaciones" rows="5" placeholder="Notas adicionales..."></textarea>
    </div>
    <div class="row">
        <label style="flex-direction: row; align-items: center; gap: 8px; font-weight: normal; color: var(--text);">
            <input type="checkbox" id="shareWA" style="width: auto;" />
            Enviar resumen por WhatsApp a Laura
        </label>
    </div>

    <div class="toolbar">
      <button id="btnEnviar" class="btn">
        <span class="btn-text">Enviar pedido</span>
        <div class="spinner" style="display: none;"></div>
      </button>
      <button id="btnNuevoLote" class="btn-secondary">Agregar otro (mismo d√≠a/vendedor)</button>
    </div>
  </main>

  <main id="pendientes" style="display:none;">
    <h3>üìã Pedidos pendientes</h3>
    <div class="search-row">
      <input id="searchPend" type="search" placeholder="Buscar por cliente..." />
      <button id="btnSyncHoy" class="btn-secondary" title="Reenviar solo los de hoy">Hoy</button>
      <button id="btnReintentarTodos" class="btn" title="Intentar enviar todo lo pendiente">Todos</button>
    </div>
    <div class="pend-legend">
      <div>üîé Escrib√≠ para <b>filtrar</b> por cliente.</div>
      <div>üîÑ <b>Hoy</b>: reenv√≠a solo los pedidos con fecha de hoy.</div>
      <div>üì§ <b>Todos</b>: intenta reenviar todos los pendientes.</div>
    </div>
    <div id="listaPendientes"></div>
  </main>

  <main id="estadisticas" style="display:none;">
    <h3>üìä Estad√≠sticas (este dispositivo)</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Enviados</div>
        <div id="statEnviados" class="stat-value">0</div>
        <div class="bar"><div id="barEnviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Pendientes</div>
        <div id="statPendientes" class="stat-value">0</div>
        <div class="bar"><div id="barPendientes" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Reenviados</div>
        <div id="statReenviados" class="stat-value">0</div>
        <div class="bar"><div id="barReenviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">% √âxito</div>
        <div id="statExito" class="stat-value">0%</div>
        <div class="bar"><div id="barExito" class="fill"></div></div>
      </div>
    </div>
    <div class="stat-card" style="margin-top:14px;">
      <div class="stat-title">Promedio de pedidos enviados por d√≠a</div>
      <div id="statPromedio" class="stat-value">0</div>
    </div>
  </main>

  <!-- === NUEVA PESTA√ëA: Predicciones === -->
  <main id="predicciones" style="display:none;">
    <h3>üîÆ Predicciones (√∫ltimos 60 d√≠as, local)</h3>
    <div class="stat-card">
      <div class="stat-title">Pr√≥ximas reposiciones sugeridas (7 d√≠as)</div>
      <div id="listaPredicciones"></div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Historial por cliente (√∫ltimos 60 d√≠as)</div>
      <div id="resumenClientes"></div>
    </div>
  </main>

  <div class="bottom-nav">
    <button id="btnNuevo" class="tab-btn active">Nuevo</button>
    <button id="btnVerPendientes" class="tab-btn">Pendientes</button>
    <button id="btnVerEstadisticas" class="tab-btn">Estad√≠sticas</button>
    <button id="btnVerPredicciones" class="tab-btn">Predicciones</button> <!-- nuevo -->
  </div>

  <!-- FAB micr√≥fono -->
  <button id="btnMic" title="Dictar productos" aria-label="Dictar productos">üéôÔ∏è</button>

  <!-- Modal de dictado -->
  <div id="dictadoOverlay" role="dialog" aria-modal="true">
    <div class="dictado-box">
      <div class="dictado-head">
        <div class="dot-rec"></div>
        <h3 style="margin:0;">Dictado en vivo</h3>
      </div>
      <div style="font-size:13px;color:var(--muted);margin-top:4px;">
        Habl√° natural. Sugerido: <b>‚Äú12 herm√©ticos 2300, 6 film 45cm‚Ä¶‚Äù</b>. Despu√©s pod√©s editar antes de usar.
      </div>
      <textarea id="dictadoPreview" placeholder="Escuchando‚Ä¶"></textarea>
      <div class="dictado-actions">
        <button id="btnDictadoCancelar" class="btn-secondary">Cancelar</button>
        <button id="btnDictadoEditar" class="btn-secondary">Editar</button>
        <button id="btnDictadoUsar" class="btn">Usar en Productos</button>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <div id="confirmOverlay">
    <div class="success-box">
        <svg class="checkmark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      <h2 style="margin:10px 0 0 0;">¬°Pedido enviado!</h2>
      <p style="opacity:.9;margin:6px 0 0 0;">Se guard√≥ correctamente</p>
    </div>
  </div>

<script>
  // ==== CONFIG ====
  const GF_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSfgUbkynVRveiW547pgX0AgvVDGnCd1GUoXooMTDXkiCWgdKA/formResponse";

  const GF = {
    vendedor: "entry.1003904475",
    fecha:    "entry.171879298",
    fecha_day:   "entry.171879298_day",
    fecha_month: "entry.171879298_month",
    fecha_year:  "entry.171879298_year",
    cliente:  "entry.1103049985",
    productos:"entry.1828255967",
    observaciones: "entry.897131524",
    sig: "entry.1902043730"
  };

  // === DEDUPE helpers ===
  function normalizeStr(s){
    return (s||"").toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^A-Z0-9\s\n]/g,"")
      .replace(/\s+/g," ").trim();
  }
  function normalizeProductos(s){
    const lines = (s||"").split(/\n+/).map(x=>normalizeStr(x)).filter(Boolean);
    lines.sort();
    return lines.join("|");
  }
  function fnv1a(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h = Math.imul(h ^ str.charCodeAt(i), 0x01000193);
    }
    return (h>>>0).toString(16);
  }
  function makeSignature(p){
    const base = `${(p.fechaEntrega||"").slice(0,10)}|${normalizeStr(p.numeroCliente)}|${normalizeStr(p.nombreVendedor)}|${normalizeProductos(p.productos)}`;
    return fnv1a(base);
  }
  const SIG_KEY = "signaturesEnviadas";
  function getSigMap(){ try { return JSON.parse(localStorage.getItem(SIG_KEY)||"{}"); } catch { return {}; } }
  function seenSig(sig){ return !!getSigMap()[sig]; }
  function markSig(sig){ const m = getSigMap(); m[sig]=Date.now(); localStorage.setItem(SIG_KEY, JSON.stringify(m)); }
  (function pruneSigs(days=30){
    const t = Date.now()-days*86400000, m=getSigMap(); let changed=false;
    for(const k in m){ if(m[k]<t){ delete m[k]; changed=true; } }
    if(changed) localStorage.setItem(SIG_KEY, JSON.stringify(m));
  })();

  // === Env√≠o al Google Form (no-cors) ===
  async function sendToGoogleForm(p) {
    const formData = new FormData();
    formData.append(GF.vendedor, p.nombreVendedor);
    formData.append(GF.cliente, p.numeroCliente);
    formData.append(GF.productos, p.productos);
    formData.append(GF.observaciones, p.observaciones || "");

    const fecha = (p.fechaEntrega || "").trim();
    if (fecha) {
      formData.append(GF.fecha, fecha);
      const [yyyy, mm, dd] = fecha.split("-");
      if (GF.fecha_day && GF.fecha_month && GF.fecha_year) {
        formData.append(GF.fecha_day, dd);
        formData.append(GF.fecha_month, mm);
        formData.append(GF.fecha_year, yyyy);
      }
    }

    formData.append(GF.sig, p.sig || "");

    try {
      await fetch(GF_ACTION, { method: "POST", mode: "no-cors", body: formData });
      return { status: "ok" };
    } catch (err) {
      console.error("‚ùå Error enviando pedido:", err);
      return { status: "error" };
    }
  }

  // ==== ELEMENTOS ====
  const $ = id => document.getElementById(id);
  const fechaEntrega = $("fechaEntrega"), numeroCliente = $("numeroCliente"),
        nombreVendedor = $("nombreVendedor"), productos = $("productos"),
        observaciones = $("observaciones"), btnEnviar = $("btnEnviar"),
        btnNuevoLote = $("btnNuevoLote"), toastContainer = $("toast-container"),
        connDot = $("connDot"), netBanner = $("netBanner"), helloBanner = $("helloBanner"),
        shareWA = $("shareWA"), searchPend = $("searchPend"), pedidoContador = $("pedidoContador");

  // SONIDO & VIBRA
  const sndOk = new Audio("data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA");
  function vib(ms=70){ if('vibrate' in navigator) navigator.vibrate(ms); }
  function playOk(){ try{ sndOk.currentTime=0; sndOk.play(); }catch{} }

  // TOAST
  function showToast(msg, type="info"){
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    let bgColor = "#ffcd38", color = "#1f2937";
    if (type === "error") { bgColor = "#ef4444"; color = "#fff"; }
    if (type === "ok") { bgColor = "#22c55e"; color = "#fff"; }
    toast.style.background = bgColor; toast.style.color = color;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }

  // ===== THEME din√°mico =====
  function setTheme(input){
    const root = document.documentElement;

    let c1, c2;
    if (typeof input === "string" && input.includes(",")) {
      const parts = input.split(",").map(s=>s.trim());
      c1 = parts[0]; c2 = parts[1] || parts[0];
    } else {
      c1 = input || getComputedStyle(root).getPropertyValue("--primary").trim() || "#06b6d4";
      c2 = rgbToHex(darkenRGB(hexToRgb(c1), 0.18));
    }

    const base1 = hexToRgb(c1);
    const base2 = hexToRgb(c2);

    root.style.setProperty("--primary", c1);
    root.style.setProperty("--primary-2", c2);
    root.style.setProperty("--primary-light", `rgba(${base1.r},${base1.g},${base1.b},0.22)`);
    root.style.setProperty("--primary-rgb", `${base1.r},${base1.g},${base1.b}`);
    root.style.setProperty("--primary-2-rgb", `${base2.r},${base2.g},${base2.b}`);

    const isDarkPref = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(!isDarkPref){
      const border   = rgbToHex(lightenRGB(base1, 0.78));
      const bgStart  = rgbToHex(lightenRGB(base1, 0.90));
      const bgEnd    = rgbToHex(lightenRGB(base1, 0.97));
      const cardStart= rgbToHex(lightenRGB(base1, 0.94));
      const cardEnd  = rgbToHex(lightenRGB(base1, 0.985));
      const fieldStart=rgbToHex(lightenRGB(base1, 0.965));
      const fieldEnd  = rgbToHex(lightenRGB(base1, 0.99));
      root.style.setProperty("--border-tint", border);
      root.style.setProperty("--bg-grad-start", bgStart);
      root.style.setProperty("--bg-grad-end", bgEnd);
      root.style.setProperty("--card-grad-start", cardStart);
      root.style.setProperty("--card-grad-end", cardEnd);
      root.style.setProperty("--field-grad-start", fieldStart);
      root.style.setProperty("--field-grad-end", fieldEnd);
    }

    localStorage.setItem("themeColor", `${c1},${c2}`);
  }

  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  function hexToRgb(hex){
    let h = hex.replace('#','').trim();
    if (h.length===3) h = h.split('').map(c=>c+c).join('');
    const n = parseInt(h,16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }
  function rgbToHex({r,g,b}){
    const to = v => v.toString(16).padStart(2,'0');
    return `#${to(clamp(Math.round(r),0,255))}${to(clamp(Math.round(g),0,255))}${to(clamp(Math.round(b),0,255))}`;
  }
  function mixRGB(a,b,t){ return { r:a.r+(b.r-a.r)*t, g:a.g+(b.g-a.g)*t, b:a.b+(b.b-a.b)*t }; }
  function darkenRGB(a,t){ return mixRGB(a,{r:0,g:0,b:0},t); }
  function lightenRGB(a,t){ return mixRGB(a,{r:255,g:255,b:255},t); }

  (()=>{ const stored = localStorage.getItem("themeColor"); setTheme(stored || "#06b6d4,#22c55e");
    document.querySelectorAll(".swatch").forEach(s=> s.addEventListener("click", ()=> setTheme(s.getAttribute("data-color"))) );
  })();

  // STORAGE (existentes)
  const getQueue = () => JSON.parse(localStorage.getItem("pedidosPendientes") || "[]");
  const setQueue = arr => localStorage.setItem("pedidosPendientes", JSON.stringify(arr));
  const getStats = () => JSON.parse(localStorage.getItem("statsPedidos") || '{"enviados":0,"reenviados":0}');
  const setStats = s => localStorage.setItem("statsPedidos", JSON.stringify(s));
  const getHistory = () => JSON.parse(localStorage.getItem("historialEnviados") || "[]");
  const setHistory = h => localStorage.setItem("historialEnviados", JSON.stringify(h));

  // === NUEVO: DB local para predicciones (por cliente) ===
  const PRED_DB_KEY = "historialPorClienteV1";
  const PRED_MAX_DAYS = 60;
  function getPredDB(){ try { return JSON.parse(localStorage.getItem(PRED_DB_KEY)||"{}"); } catch { return {}; } }
  function setPredDB(db){ localStorage.setItem(PRED_DB_KEY, JSON.stringify(db)); }
  function prunePredDB(){
    const db = getPredDB();
    const cutoff = Date.now() - PRED_MAX_DAYS*86400000;
    let changed = false;
    for(const cli in db){
      const arr = (db[cli]||[]).filter(it => (new Date(it.date).getTime() >= cutoff));
      if(arr.length !== (db[cli]||[]).length){ db[cli] = arr; changed = true; }
      if(arr.length===0) delete db[cli];
    }
    if(changed) setPredDB(db);
  }
  function logOrderForPrediction(p){
    const db = getPredDB();
    const cli = (p.numeroCliente||"").trim();
    if(!cli) return;
    if(!db[cli]) db[cli] = [];
    db[cli].push({ date: new Date().toISOString().slice(0,10), productos: p.productos || "" });
    setPredDB(db);
    prunePredDB();
  }
  function computePredictions(){
    prunePredDB();
    const db = getPredDB();
    const upcoming = []; // {cliente, dias, fechaEstimada, itemsTop}
    const detail = [];   // por cliente
    const today = new Date();

    for(const cli in db){
      const rows = db[cli].slice().sort((a,b)=> a.date.localeCompare(b.date)); // asc
      if(rows.length===0) continue;
      // intervalos entre compras
      const ds = rows.map(r => new Date(r.date));
      const gaps = [];
      for(let i=1;i<ds.length;i++){
        gaps.push( Math.max(1, Math.round((ds[i]-ds[i-1]) / 86400000)) );
      }
      const meanGap = gaps.length ? Math.round(gaps.reduce((a,b)=>a+b,0)/gaps.length) : null;
      const lastDate = ds[ds.length-1];
      let nextDate = null, daysLeft = null;
      if(meanGap){
        nextDate = new Date(lastDate.getTime() + meanGap*86400000);
        daysLeft = Math.ceil((nextDate - today)/86400000);
      }

      // items m√°s repetidos (conteo por l√≠nea)
      const counts = {};
      for(const r of rows){
        (r.productos||"").split(/\n+/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
          const key = line.toUpperCase();
          counts[key] = (counts[key]||0) + 1;
        });
      }
      const itemsTop = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,4).map(x=>x[0]);

      detail.push({ cliente: cli, pedidos: rows.length, ultima: rows[rows.length-1].date, freq: meanGap, itemsTop });

      if(daysLeft!==null && daysLeft<=7){
        upcoming.push({ cliente: cli, dias: daysLeft, fechaEstimada: nextDate.toISOString().slice(0,10), itemsTop });
      }
    }

    upcoming.sort((a,b)=> a.dias - b.dias);
    detail.sort((a,b)=> (a.cliente.localeCompare(b.cliente)));

    // Render
    const lp = $("listaPredicciones");
    lp.innerHTML = upcoming.length
      ? upcoming.map(u => `
        <div class="pedido-card">
          <b>Cliente ${u.cliente}</b> ‚Äî en <b>${u.dias} d√≠a${u.dias===1?"":"s"}</b> (‚âà ${u.fechaEstimada})
          ${u.itemsTop.length ? `<div style="margin-top:6px;font-size:13px;color:var(--muted)">Suele pedir: ${u.itemsTop.join(" ¬∑ ")}</div>` : ""}
        </div>`).join("")
      : `<div class="pedido-card" style="color:var(--muted)">Sin sugerencias en los pr√≥ximos 7 d√≠as.</div>`;

    const rc = $("resumenClientes");
    rc.innerHTML = detail.length
      ? detail.map(d => `
        <div class="pedido-card">
          <b>Cliente ${d.cliente}</b><br/>
          <small style="color:var(--muted)">Pedidos: ${d.pedidos}${d.freq ? ` ¬∑ Frec. media ~ ${d.freq} d√≠as` : ""} ¬∑ √öltimo: ${d.ultima}</small>
          ${d.itemsTop.length ? `<div style="margin-top:6px;font-size:13px;opacity:.85">Top √≠tems: <i>${d.itemsTop.join(" | ")}</i></div>` : ""}
        </div>`).join("")
      : `<div class="pedido-card" style="color:var(--muted)">A√∫n no hay historial suficiente.</div>`;
  }

  // DRAFT
  const DRAFT_KEY = "draftPedido";
  function saveDraft(){
    const d = { fechaEntrega: fechaEntrega.value, numeroCliente: numeroCliente.value, nombreVendedor: nombreVendedor.value, productos: productos.value, observaciones: observaciones.value };
    localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
  }
  function loadDraft(){
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      fechaEntrega.value = d.fechaEntrega || fechaEntrega.value;
      numeroCliente.value = d.numeroCliente || "";
      nombreVendedor.value = d.nombreVendedor || nombreVendedor.value;
      productos.value = d.productos || "";
      observaciones.value = d.observaciones || "";
    }catch{}
  }
  [fechaEntrega,numeroCliente,nombreVendedor,productos,observaciones].forEach(el=> el.addEventListener("input", saveDraft));

  // VALIDACI√ìN
  function validateForm(){
    let valid = true;
    [fechaEntrega, numeroCliente, nombreVendedor, productos].forEach(el => {
      el.style.borderColor = "";
      if(!el.value.trim()){
        el.style.borderColor = "var(--error)";
        valid = false;
      }
    });
    if(!valid) showToast("Por favor, complet√° todos los campos.", "error");
    return valid;
  }

  // LIMPIAR FORM
  function clearForm(full=true){
    numeroCliente.value = "";
    productos.value = "";
    observaciones.value = "";
    if(full){
      nombreVendedor.value = "";
      const today = new Date();
      const offset = today.getTimezoneOffset() * 60000;
      const localDate = new Date(today - offset);
      fechaEntrega.value = localDate.toISOString().substring(0,10);
      localStorage.removeItem(DRAFT_KEY);
    }
    numeroCliente.focus();
    updatePendingCount();
    saveDraft();
  }

  function showSuccess(opts = {}){
    const { title="¬°Pedido enviado!", subtitle="Se registr√≥ correctamente", duration=3200 } = opts;
    const ov = document.getElementById("confirmOverlay");
    ov.style.display = "flex";
    const h2 = ov.querySelector("h2");
    const p  = ov.querySelector("p");
    if (h2) h2.textContent = title;
    if (p)  p.textContent  = subtitle;

    const circle = ov.querySelector(".checkmark-circle");
    const check  = ov.querySelector(".checkmark-check");
    [circle, check].forEach(el=>{ if(!el) return; el.style.animation = "none"; void el.offsetWidth; el.style.animation = ""; });

    clearTimeout(ov._hideTimer);
    ov._hideTimer = setTimeout(()=>{ ov.style.display = "none"; }, duration);
  }

  // Anti doble-click
  window.isCooling = function(el){ return !!(el && el.classList && el.classList.contains('cooldown')); };
  window.startCooldown = function(el, ms = 1200){ if(!el) return; el.classList.add('cooldown'); setTimeout(()=> el.classList.remove('cooldown'), ms); };

  // L√ìGICA DE ENV√çO (se mantiene igual; solo AGREGAMOS logOrderForPrediction cuando se env√≠a OK)
  async function handleEnviar(){
    if (isCooling(btnEnviar)) return;
    if(!validateForm()) return;

    showSuccess({
      subtitle: navigator.onLine ? "Sincronizando con Google‚Ä¶" : "Guardado localmente, se enviar√° al reconectar",
      duration: 3400
    });
    playOk(); vib();

    btnEnviar.disabled = true;
    btnEnviar.querySelector('.spinner').style.display = 'block';
    btnEnviar.querySelector('.btn-text').style.display = 'none';

    const pedido = {
      id: "p_" + Date.now(),
      fechaEntrega: fechaEntrega.value,
      numeroCliente: numeroCliente.value,
      nombreVendedor: nombreVendedor.value.toUpperCase(),
      productos: productos.value.toUpperCase(),
      observaciones: observaciones.value,
      timestamp: Date.now()
    };
    pedido.sig = makeSignature(pedido);

    if (seenSig(pedido.sig)){
      showToast("Pedido duplicado detectado.", "error");
      btnEnviar.disabled = false;
      btnEnviar.querySelector('.spinner').style.display = 'none';
      btnEnviar.querySelector('.btn-text').style.display = 'block';
      return;
    }

    const queue = getQueue();
    queue.push(pedido);
    setQueue(queue);
    updatePendingCount();

    await syncQueue();

    const stillPending = getQueue().some(p => p.id === pedido.id);
    if (!stillPending) {
      showToast("Enviado ‚úîÔ∏è", "ok");
      markSig(pedido.sig);
      const stats = getStats();
      stats.enviados = (stats.enviados || 0) + 1;
      setStats(stats);
      const history = getHistory();
      history.push({ id: pedido.id, date: new Date().toISOString().slice(0,10) });
      if (history.length > 500) history.shift();
      setHistory(history);

      // === NUEVO: registrar para predicci√≥n (no interfiere con nada)
      logOrderForPrediction(pedido);
      computePredictions();

    } else {
      showToast("Pedido guardado localmente.", "info");
    }

    if(shareWA.checked) {
      const resumen = `*PEDIDO ML*\n\n- *Cliente:* ${pedido.numeroCliente}\n- *Vendedor:* ${pedido.nombreVendedor}\n- *Fecha Entrega:* ${pedido.fechaEntrega.split('-').reverse().join('/')}\n\n*PRODUCTOS:*\n${pedido.productos}${pedido.observaciones ? `\n\n*OBS:*\n${pedido.observaciones}`:''}`;
      window.open(`https://wa.me/5491133395487?text=${encodeURIComponent(resumen)}`, '_blank');
    }

    clearForm(false);
    btnEnviar.disabled = false;
    btnEnviar.querySelector('.spinner').style.display = 'none';
    btnEnviar.querySelector('.btn-text').style.display = 'block';
    startCooldown(btnEnviar);
  }

  btnEnviar.addEventListener("click", handleEnviar);

  // SINCRONIZACI√ìN
  let isSyncing = false;
  async function syncQueue(forceAll = false) {
    if (isSyncing || !navigator.onLine) return;
    isSyncing = true;
    connDot.classList.remove("online", "offline");
    connDot.classList.add("syncing");

    let queue = getQueue();
    let originalQueueSize = queue.length;
    let failed = [];

    for (const pedido of queue) {
      if (!navigator.onLine) { failed.push(pedido); continue; }
      try {
        const res = await sendToGoogleForm(pedido);
        if (res.status === 'ok') {
          markSig(pedido.sig);
          if (forceAll) {
            const stats = getStats();
            stats.reenviados = (stats.reenviados || 0) + 1;
            setStats(stats);
          }
        } else { failed.push(pedido); }
      } catch (error) { failed.push(pedido); }
    }

    setQueue(failed);
    isSyncing = false;
    updateConnectionStatus();
    updatePendingCount();
    if($("pendientes").style.display !== 'none') renderPendientes();

    if(forceAll && originalQueueSize > 0){
      const enviados = originalQueueSize - failed.length;
      if(enviados > 0) showToast(`${enviados} pedido${enviados>1?'s':''} reenviado${enviados>1?'s':''} con √©xito!`, 'ok');
      else showToast('No se pudieron reenviar los pedidos.', 'error');
    }
  }

  // CONEXI√ìN
  function updateConnectionStatus() {
    if (isSyncing) return;
    const online = navigator.onLine;
    connDot.className = online ? "online" : "offline";
    netBanner.style.display = online ? "none" : "block";
    if (online) { setTimeout(syncQueue, 500); }
  }

  window.addEventListener("online", updateConnectionStatus);
  window.addEventListener("offline", updateConnectionStatus);

  // INICIALIZACI√ìN
  document.addEventListener("DOMContentLoaded", () => {
    clearForm();
    loadDraft();
    updateConnectionStatus();
    setInterval(syncQueue, 60000);

    const h = new Date().getHours();
    let saludo = "¬°Buenas noches!";
    if(h >= 6 && h < 13) saludo = "¬°Buenos d√≠as!";
    if(h >= 13 && h < 20) saludo = "¬°Buenas tardes!";
    const nombreGuardado = localStorage.getItem("nombreVendedor") || "";
    if (nombreGuardado) {
        helloBanner.innerHTML = `<h3 style="margin-top:0;margin-bottom:20px;">${saludo}, <b>${nombreGuardado.split(' ')[0]}</b></h3>`;
    } else {
      helloBanner.style.display = "none";
    }
    nombreVendedor.addEventListener('change', (e) => localStorage.setItem("nombreVendedor", e.target.value));
    productos.addEventListener("input", ()=>{
      const s = productos.selectionStart, e = productos.selectionEnd;
      productos.value = productos.value.toUpperCase();
      try{ productos.setSelectionRange(s,e); }catch{}
    });

    // Cargar predicciones al abrir
    computePredictions();
  });

  // TABS (agregamos 'pred')
  const mainNuevo = $("nuevoPedido"), mainPendientes = $("pendientes"), mainStats = $("estadisticas"), mainPred = $("predicciones");
  const btnNuevo = $("btnNuevo"), btnPendientes = $("btnVerPendientes"), btnStats = $("btnVerEstadisticas"), btnPred = $("btnVerPredicciones");

  function showTab(tabName) {
    mainNuevo.style.display = 'none';
    mainPendientes.style.display = 'none';
    mainStats.style.display = 'none';
    mainPred.style.display = 'none';
    [btnNuevo, btnPendientes, btnStats, btnPred].forEach(b=>b.classList.remove('active'));
    btnEnviar.style.display = 'none';

    if (tabName === 'nuevo') {
      mainNuevo.style.display = 'block';
      btnNuevo.classList.add('active');
      btnEnviar.style.display = 'flex';
    } else if (tabName === 'pendientes') {
      mainPendientes.style.display = 'block';
      btnPendientes.classList.add('active');
      renderPendientes();
    } else if (tabName === 'stats') {
      mainStats.style.display = 'block';
      btnStats.classList.add('active');
      renderStats();
    } else if (tabName === 'pred') {
      mainPred.style.display = 'block';
      btnPred.classList.add('active');
      computePredictions();
    }
  }
  btnNuevo.addEventListener('click', () => showTab('nuevo'));
  btnPendientes.addEventListener('click', () => showTab('pendientes'));
  btnStats.addEventListener('click', () => showTab('stats'));
  btnPred.addEventListener('click', () => showTab('pred'));

  // PENDIENTES
  function renderPendientes(filter = "") {
    const queue = getQueue();
    const container = $("listaPendientes");
    container.innerHTML = "";
    const filteredQueue = queue.filter(p => p.numeroCliente.includes(filter));

    if (filteredQueue.length === 0) {
      container.innerHTML = `<div class="pedido-card" style="text-align:center; color: var(--muted);">No hay pedidos pendientes.</div>`;
      return;
    }

    filteredQueue.reverse().forEach(p => {
      const card = document.createElement("div");
      card.className = "pedido-card";
      const d = new Date(p.timestamp);
      card.innerHTML = `
        <b>Cliente: ${p.numeroCliente}</b> (Vendedor: ${p.nombreVendedor})<br>
        <small style="color:var(--muted)">Fecha entrega: ${p.fechaEntrega.split('-').reverse().join('/')} | Guardado: ${d.toLocaleDateString()} ${d.toLocaleTimeString()}</small>
        <hr>
        <pre style="white-space:pre-wrap; font-family:inherit; margin:0;">${p.productos}</pre>
        ${p.observaciones ? `<hr><pre style="white-space:pre-wrap;font-family:inherit;margin:0;opacity:.8;">${p.observaciones}</pre>` : ''}
      `;
      container.appendChild(card);
    });
  }

  searchPend.addEventListener("input", e => renderPendientes(e.target.value));
  $("btnReintentarTodos").addEventListener("click", () => syncQueue(true));
  $("btnSyncHoy").addEventListener("click", () => {
    const todayStr = new Date().toISOString().slice(0, 10);
    const queue = getQueue();
    const hoy = queue.filter(p => p.fechaEntrega === todayStr);
    if(hoy.length > 0) {
      const originalQueue = [...queue];
      setQueue(hoy);
      syncQueue(true).then(() => {
        const restantes = getQueue();
        const originalMenosHoy = originalQueue.filter(p => p.fechaEntrega !== todayStr);
        setQueue([...restantes, ...originalMenosHoy]);
        renderPendientes();
      });
    } else {
      showToast("No hay pedidos pendientes para hoy.", "info");
    }
  });

  function updatePendingCount() {
    const count = getQueue().length;
    pedidoContador.textContent = count;
    pedidoContador.style.display = count > 0 ? 'inline-block' : 'none';
    const pendBtn = $("btnVerPendientes");
    const currentCount = pendBtn.querySelector('span');
    if (count > 0) {
      if(currentCount) currentCount.textContent = count;
      else pendBtn.innerHTML = `Pendientes <span style="background:var(--error);color:#fff;font-size:10px;padding:2px 5px;border-radius:6px;margin-left:4px;">${count}</span>`;
    } else {
      if(currentCount) pendBtn.textContent = 'Pendientes';
    }
  }

  // STATS
  function renderStats(){
    const stats = getStats();
    const pendientes = getQueue().length;
    const total = (stats.enviados||0) + pendientes;

    $("statEnviados").textContent = stats.enviados || 0;
    $("statPendientes").textContent = pendientes;
    $("statReenviados").textContent = stats.reenviados || 0;

    const exito = total > 0 ? Math.round(((stats.enviados||0) / total) * 100) : 0;
    $("statExito").textContent = `${exito}%`;

    $("barEnviados").style.width = total > 0 ? `${((stats.enviados||0)/total)*100}%` : '0%';
    $("barPendientes").style.width = total > 0 ? `${(pendientes/total)*100}%` : '0%';
    $("barReenviados").style.width = (stats.enviados||0) > 0 ? `${Math.min(100, ((stats.reenviados||0)/(stats.enviados||0))*100)}%` : '0%';
    $("barExito").style.width = `${exito}%`;

    const history = getHistory();
    const days = new Set(history.map(h => h.date)).size;
    const avg = days > 0 ? (history.length / days).toFixed(1) : 0;
    $("statPromedio").textContent = avg;
  }

  // INIT
  showTab('nuevo');
  loadDraft();



const keywordMap = {
  // üîπ MARCAS
  "make": "MAKE", "maque": "MAKE", "maqe": "MAKE", "meik": "MAKE", "meic": "MAKE",
  "bio ba": "BIO BAG", "bio bak": "BIO BAG", "bio bach": "BIO BAG",
  "romil": "ROMYL", "romyl": "ROMYL", "romin": "ROMYL","fibra": "FIBRAN",
  "desepla": "DESESPLAST", "plastic house": "PLASTIC HOUSE",

  // üîπ ART√çCULOS / GEN√âRICOS
  "esponja": "ESPONJA", "esponga": "ESPONJA",
  "salva una": "SALVA U√ëA", "salva u√±as": "SALVA U√ëA", "salva una romil": "SALVA U√ëA ROMYL",
  "rejilla": "REJILLA", "rejilla trapo": "TRAPO REJILLA",
  "broche": "BROCHE", "broches": "BROCHE",
  "bowl": "BOWL", "bol": "BOWL", "taper": "TAPER", "hermetico": "HERM√âTICO", "herm√©tico": "HERM√âTICO",
  "litro": "LT", "litros": "LT", "lts": "LT", "lt": "LT",
  "por": "X"
};


// Conversi√≥n de n√∫meros hablados a d√≠gitos
const numerosMap = {
  "un": "1", "una": "1", "uno": "1",
  "dos": "2", "tres": "3", "cuatro": "4", "cinco": "5", "seis": "6", "siete": "7", "ocho": "8", "nueve": "9", "diez": "10",
  "once": "11", "doce": "12", "trece": "13", "catorce": "14", "quince": "15",
  "dieciseis": "16", "diecis√©is": "16", "diecisiete": "17", "dieciocho": "18", "diecinueve": "19",
  "veinte": "20", "veintiuno": "21", "veintidos": "22", "veintid√≥s": "22", "veintitres": "23", "veintitr√©s": "23",
  "veinticuatro": "24", "veinticinco": "25", "treinta": "30", "cuarenta": "40", "cincuenta": "50", "sesenta": "60"
};

function convertirNumerosDictado(text) {
  for (const [palabra, numero] of Object.entries(numerosMap)) {
    const regex = new RegExp(`\\b${palabra}\\b`, 'gi');
    text = text.replace(regex, numero);
  }
  return text;
}

// Limpieza avanzada del dictado
function limpiarDictadoAvanzado(text) {
  text = text.toLowerCase();
  text = convertirNumerosDictado(text);

  // Corregir sin√≥nimos y fon√©ticas
  for (const [clave, valor] of Object.entries(keywordMap)) {
    const regex = new RegExp(`\\b${clave}\\b`, 'gi');
    text = text.replace(regex, valor);
  }

  // Normalizar formato: n√∫mero al inicio + producto
  text = text.replace(/^\s*([0-9]+)\s*(.*)$/i, (_, num, prod) => `${num} ${prod.trim()}`);

  // Quitar espacios duplicados y pasar a may√∫sculas
  return text.replace(/\s+/g, ' ').trim().toUpperCase();
}


  
  

  /* =======================
     DICTADO POR VOZ (nuevo)
     ======================= */
  const btnMic = $("btnMic");
  const dictadoOverlay = $("dictadoOverlay");
  const dictadoPreview = $("dictadoPreview");
  const btnDictadoUsar = $("btnDictadoUsar");
  const btnDictadoEditar = $("btnDictadoEditar");
  const btnDictadoCancelar = $("btnDictadoCancelar");

  let recognition = null;
  let recogActive = false;
  let interimBuffer = "";
  let finalBuffer = "";

  function closeDictado(){
    dictadoOverlay.style.display = "none";
    btnMic.classList.remove('rec');
    if(recognition){
      try{ recognition.stop(); }catch{}
    }
    recogActive = false;
  }

  function openDictado(){
    dictadoOverlay.style.display = "flex";
    dictadoPreview.value = "";
  }

  // Inicia dictado
  btnMic.addEventListener("click", () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      showToast("Dictado no soportado aqu√≠. Us√° el micr√≥fono del teclado.", "error");
      try{ productos.focus(); }catch{}
      return;
    }
    // Mostrar modal
    openDictado();

    // Configurar reconocimiento
    recognition = new SR();
    recognition.lang = "es-AR";            // ajustar acento local
    recognition.interimResults = true;
    recognition.continuous = true;

    finalBuffer = ""; interimBuffer="";
    btnMic.classList.add('rec');
    recogActive = true;

    recognition.onresult = (e) => {
      interimBuffer = "";
      for(let i = e.resultIndex; i < e.results.length; i++){
        const tr = e.results[i][0].transcript;
        if(e.results[i].isFinal){
          // Regla suave: "cantidad art√≠culo ..." ‚Üí ponemos cantidad primero en may√∫scula la l√≠nea
          const line = tr.trim();
          finalBuffer += (finalBuffer ? "\n" : "") + line;
        }else{
          interimBuffer += tr;
        }
      }
    const textoBruto = (finalBuffer + (interimBuffer ? "\n" + interimBuffer : "")).toUpperCase();
// ‚úÖ Limpieza y formato multilinea
let limpio = limpiarDictadoAvanzado(textoBruto);

// ‚úÖ Insertar salto de l√≠nea solo cuando el n√∫mero indica una nueva cantidad
// (evita cortar expresiones como "X 1 L", "POR 1 L" o "DE 6 L")
limpio = limpio.replace(/(?<!^|\bX|\bPOR|\bDE|\d)(\s)(\d+)\b/gi, '\n$2');


// Quitar dobles saltos
limpio = limpio.replace(/\n+/g, '\n').trim();

// Mostrar el texto en el cuadro de vista previa
dictadoPreview.value = limpio;




    };
    recognition.onerror = (ev) => { console.warn("SR error:", ev.error); showToast("Error de dictado: "+ev.error, "error"); };
    recognition.onend = () => { btnMic.classList.remove('rec'); recogActive=false; };
    try{ recognition.start(); }catch(e){}
  });

  // Usar en Productos (append, no pisa lo existente)
  btnDictadoUsar.addEventListener("click", () => {
    const txt = (dictadoPreview.value||"").trim();
    if(txt){
      productos.value = (productos.value ? (productos.value.replace(/\s+$/,'') + "\n") : "") + txt.toUpperCase();
      saveDraft();
    }
    closeDictado();
    productos.focus();
  });

  // Dejar editando (solo cierra la escucha, mantiene modal abierto para que puedas corregir y luego "Usar")
  btnDictadoEditar.addEventListener("click", () => {
    if(recogActive && recognition){ try{ recognition.stop(); }catch{} recogActive=false; btnMic.classList.remove('rec'); }
    dictadoPreview.focus();
  });

  // Cancelar
  btnDictadoCancelar.addEventListener("click", () => closeDictado());

</script>

  <!-- === Registro de Service Worker y bot√≥n de instalaci√≥n PWA === -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('/App-Pedidos-ML/service-worker.js', { scope: '/App-Pedidos-ML/' })
      .then(r => console.log('‚úÖ SW registrado correctamente:', r.scope))
      .catch(err => console.error('‚ùå Error al registrar SW:', err));
  });
}

// üß© Evento que muestra bot√≥n ‚ÄúInstalar‚Äù en Android
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  const bar = document.querySelector('.bottom-nav');
  if (!bar || document.getElementById('btnInstall')) return;

  const btn = document.createElement('button');
  btn.id = 'btnInstall';
  btn.className = 'tab-btn active';
  btn.textContent = 'Instalar';
  btn.style.background = 'linear-gradient(90deg, var(--primary), var(--primary-2))';
  btn.style.color = '#fff';
  btn.style.boxShadow = '0 8px 22px rgba(var(--primary-rgb),.28)';
  bar.appendChild(btn);

  btn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') showToast('Instalaci√≥n iniciada', 'ok');
    deferredPrompt = null;
    btn.remove();
  });
});

window.addEventListener('appinstalled', () => {
  const b = document.getElementById('btnInstall');
  if (b) b.remove();
  showToast('App instalada ‚úîÔ∏è', 'ok');
});
</script>

</body>
</html>
