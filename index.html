<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Pedidos ML</title>
  <meta name="theme-color" content="#4f46e5" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --primary: #4f46e5;
    --primary-2: #4338ca;
    --primary-light: rgba(79,70,229,.22);

    --primary-rgb: 79,70,229;
    --primary-2-rgb: 67,56,202;

    /* --- TEMA CLARO (Default) --- */
    --bg: #f4f5f9;
    --text: #111827;
    --card: #ffffff;
    --muted: #6b7280;
    --border: #e5e7eb;
    --border-tint: #e5e7eb;
    --field-text: #0b0f14;
    --placeholder: rgba(11,15,20,.55);

    --bg-grad-start: #f7f9ff;
    --bg-grad-end:   #eef2ff;
    --card-grad-start:#ffffff;
    --card-grad-end:  #f3f6ff;
    --field-grad-start:#ffffff;
    --field-grad-end:  #f8f9fc;

    --success: #16a34a;
    --error: #ef4444;
    --shadow: 0 4px 12px rgba(0,0,0,0.10);
    --shadow-lg: 0 10px 30px rgba(0,0,0,0.16);
  }

  /* --- DEFINICIÓN DEL NUEVO TEMA OSCURO --- */
  :root {
    --dark-bg: #0A0C10;
    --dark-text: #F0F6FC;
    --dark-card: #161B22;
    --dark-muted: #84909c;
    --dark-border: #30363d;
    --dark-field-bg: #101419;
    --dark-placeholder: rgba(240, 246, 252, 0.45);
    --dark-shadow: 0 6px 16px rgba(0,0,0,0.35);
    --dark-shadow-lg: 0 12px 32px rgba(0,0,0,0.45);
  }

  /* --- MODO OSCURO (Automático por sistema) --- */
  @media (prefers-color-scheme: dark) {
    :root:not(.light) { /* Evita aplicarse si se fuerza el modo claro */
      --bg: var(--dark-bg);
      --text: var(--dark-text);
      --card: var(--dark-card);
      --muted: var(--dark-muted);
      --border: var(--dark-border);
      --border-tint: var(--dark-border);
      --shadow: var(--dark-shadow);
      --shadow-lg: var(--dark-shadow-lg);

      /* Gradientes muy sutiles para un look más premium y plano */
      --bg-grad-start: var(--dark-bg);
      --bg-grad-end: #0F131A;
      --card-grad-start: var(--dark-card);
      --card-grad-end: #1A2028;
      --field-grad-start: var(--dark-field-bg);
      --field-grad-end: var(--dark-field-bg);

      --field-text: var(--dark-text);
      --placeholder: var(--dark-placeholder);
    }
  }

  /* --- MODO OSCURO (Forzado manualmente) --- */
  html.dark {
    --bg: var(--dark-bg);
    --text: var(--dark-text);
    --card: var(--dark-card);
    --muted: var(--dark-muted);
    --border: var(--dark-border);
    --border-tint: var(--dark-border);
    --shadow: var(--dark-shadow);
    --shadow-lg: var(--dark-shadow-lg);

    --bg-grad-start: var(--dark-bg);
    --bg-grad-end: #0F131A;
    --card-grad-start: var(--dark-card);
    --card-grad-end: #1A2028;
    --field-grad-start: var(--dark-field-bg);
    --field-grad-end: var(--dark-field-bg);

    --field-text: var(--dark-text);
    --placeholder: var(--dark-placeholder);
  }

  html,body{ height: 100%; }
  body{
    font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
    margin: 0;
    padding: 0 0 180px 0;
    background:
      radial-gradient(1200px 600px at 0% -10%, rgba(var(--primary-rgb), .18), transparent 60%),
      radial-gradient(900px 500px at 110% 0%, rgba(var(--primary-2-rgb), .24), transparent 55%),
      linear-gradient(180deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    color: var(--text);
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background 300ms ease, color 300ms ease;
  }

  header{
    position: sticky; top: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: space-between;
    gap: 12px;
    background: linear-gradient(180deg, rgba(var(--card-grad-start),.85), rgba(var(--card-grad-end),.85));
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    color: var(--text);
    padding: 16px;
    border-bottom: 1px solid var(--border-tint);
    transition: background 300ms ease, border-color 300ms ease;
  }

  .header-title{ font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;}
  #pedidoContador{
    background: var(--primary);
    color: white;
    font-size: 12px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 99px;
    min-width: 12px;
    text-align: center;
  }

  #connDot{
    width: 12px; height: 12px; border-radius: 50%;
    border: 2px solid transparent;
    box-shadow: 0 0 0 2px var(--border-tint);
    flex-shrink: 0;
  }
  .online{ background: #22c55e; }
  .offline{ background: #ef4444; }
  .syncing{ background: #facc15; animation:pulse 0.8s ease-in-out infinite alternate; }
  @keyframes pulse{ from{ opacity: 1; } to{ opacity: 0.4; } }

  .conn-label{
    margin-left: 8px;
    font-size: 12px;
    font-style: italic;
    letter-spacing: .1px;
    opacity: .85;
    min-width: 96px;
    display: inline-block;
  }
  #connDot.online  + .conn-label::before{ content: "en línea";      color:#22c55e; }
  #connDot.offline + .conn-label::before{ content: "sin conexión";  color:#ef4444; }
  #connDot.syncing + .conn-label::before{ content: "sincronizando…"; color:#f59e0b; }

  #netBanner{
    display:none; text-align:center;
    background:#facc15; color:#1f2937;
    padding: 8px; font-weight: 600; font-size: 14px;
  }

  main{ padding: 20px; max-width: 860px; margin: 0 auto; }
  h3 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }

  .row { margin-bottom: 18px; }
  label {
    display: flex; align-items: center;
    font-size: 14px; font-weight: 500; color: var(--muted);
    margin-bottom: 8px;
  }
  input, textarea, select {
    width: 100%; box-sizing: border-box;
    font-family: 'Inter', sans-serif;
    font-size: 16px; padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-tint);
    background: linear-gradient(180deg, var(--field-grad-start), var(--field-grad-end));
    color: var(--field-text) !important;
    caret-color: var(--primary);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background 300ms ease, color .2s ease;
    -webkit-appearance: none;
    background-clip: padding-box;
  }
  input::placeholder, textarea::placeholder{ color: var(--placeholder); }
  input:focus, textarea:focus, select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
  }
  textarea { min-height: 120px; resize: vertical; }

  .row:has(#shareWA) { display: none; }
  #btnNuevoLote { display: none; }

  .btn, .btn-secondary{
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    border-radius: 14px;
    padding: 12px 16px;
    font-weight: 600;
    font-size: 15px;
    border: none;
    cursor: pointer;
    transition: transform .12s ease, filter .15s ease, box-shadow .25s ease, background .25s ease, color .2s ease;
  }
  .btn{
    color: #fff;
    background:
      linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0) 40%) ,
      linear-gradient(45deg, var(--primary) 0%, var(--primary) 10%, var(--primary-2) 100%);
    box-shadow:
      0 14px 36px rgba(var(--primary-rgb), .48),
      0 4px 12px rgba(0,0,0,.12);
    filter: saturate(115%) contrast(105%);
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:active{ transform: translateY(0) scale(.98); filter: brightness(1.06) saturate(120%); }
  .btn[disabled]{ opacity:.72; cursor:not-allowed; filter: grayscale(.25); box-shadow: var(--shadow); }

  .btn-secondary{
    color: var(--text);
    background:
      linear-gradient(var(--card-grad-start), var(--card-grad-end)) padding-box,
      linear-gradient(135deg, var(--primary), var(--primary-2)) border-box;
    border: 2px solid transparent;
    box-shadow: 0 2px 8px rgba(0,0,0,.04);
  }
  .btn-secondary:hover{ transform: translateY(-1px); }
  .btn-secondary:active{
    color: #fff;
    background: linear-gradient(45deg, var(--primary), var(--primary-2));
    box-shadow:
      0 10px 26px rgba(var(--primary-rgb), .38),
      0 3px 10px rgba(0,0,0,.10);
  }

  #btnEnviar {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 998;
    width: 90%;
    max-width: 420px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 18px;
    font-size: 17px;
    border-radius: 16px;
    background:
      radial-gradient(120% 160% at 0% 0%, rgba(255,255,255,.25), rgba(255,255,255,0) 40%),
      linear-gradient(45deg, var(--primary) 0%, var(--primary) 8%, var(--primary-2) 55%, rgba(var(--primary-rgb),1) 100%);
    color: #fff;
    box-shadow:
      0 18px 40px rgba(var(--primary-rgb), .55),
      0 8px 18px rgba(0,0,0,.14);
  }
  #btnEnviar:active { transform: translateX(-50%) scale(0.98); filter: brightness(1.06) saturate(120%); }
  #btnEnviar.cooldown{ pointer-events: none; filter: grayscale(.35) brightness(.95); }

  .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .btn[disabled] .btn-text { display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .bottom-nav{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 999;
    background: linear-gradient(180deg, rgba(var(--card-grad-start),.85), rgba(var(--card-grad-end),.85));
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-top: 1px solid var(--border-tint);
    display: flex; gap: 10px; padding: 12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    transition: background 300ms ease, border-color 300ms ease;
  }
  .bottom-nav button{ flex: 1; border-radius: 12px; padding: 14px 8px; font-weight: 600; border: none; background: transparent; color: var(--muted); transition: all .2s ease; }
  .bottom-nav button.active{ background: var(--primary); color: #fff; }

  .pedido-card, .stat-card {
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    border: 1px solid var(--border-tint);
    border-radius: 16px; padding: 16px;
    margin-bottom: 14px; box-shadow: var(--shadow);
    transition: background 300ms ease, border-color 300ms ease;
  }
  .pedido-card hr { border: none; border-top: 1px solid var(--border-tint); margin: 12px 0; }

  .toast{
    position: fixed; left: 50%; top: 16px; transform: translateX(-50%);
    color: #fff; padding: 14px 20px; border-radius: 12px;
    font-size: 15px; font-weight: 500;
    box-shadow: var(--shadow-lg); z-index: 1001;
    opacity: 0; animation: fadeInDown .3s ease forwards;
  }
  @keyframes fadeInDown { from { top: -20px; opacity: 0; } to { top: 16px; opacity: 1; } }

  #confirmOverlay{ display: none; position: fixed; inset: 0; z-index: 1002; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; animation: fadeIn .3s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .success-box{
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    color: var(--text); border-radius: 24px; padding: 36px 28px; text-align: center;
    width: min(90vw, 320px); box-shadow: var(--shadow-lg);
    animation: popIn .35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    border: 1px solid var(--border-tint);
  }
  @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .success-box h2{ margin: 16px 0 0 0; font-size: 22px; }
  .success-box p { opacity:.7; margin:6px 0 0 0; }

  .checkmark-svg { width: 80px; height: 80px; }
  .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke: var(--success); fill: none; animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
  .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke-width: 4; stroke: var(--success); stroke-linecap: round; fill: none; animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; }

  .stats-grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 8px; }
  .stat-title{ font-size: 13px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
  .stat-value{ font-size: 26px; font-weight: 700; }
  .bar{ margin-top: 10px; height: 8px; border-radius: 999px; background: var(--border-tint); overflow: hidden; }
  .bar > .fill{ height: 100%; width: 0%; background: var(--primary); transition: width .4s ease; }

  .theme-row{ display:flex; align-items:center; gap:12px; margin: 6px 0 20px 0; flex-wrap:wrap; }
  .theme-row span { font-weight: 600; }
  .swatch{ width: 32px; height: 32px; border-radius: 50%; border: 3px solid var(--card); cursor: pointer; box-shadow: 0 0 0 1px var(--border); transition: transform .15s ease; }
  .swatch:hover { transform: scale(1.1); }

  .search-row{ display: flex; gap: 8px; margin-bottom: 10px; }
  .search-row input{ flex:1; }
  .search-row .btn, .search-row .btn-secondary { width: auto; flex-shrink: 0; min-width: 72px; }

  .pend-legend{
    font-size: 12px;
    color: var(--muted);
    display: grid;
    gap: 4px;
    margin: 6px 2px 14px;
  }
  .pend-legend b{ color: var(--text); font-weight: 600; }

  .mode-switch{
    position: relative;
    display: inline-grid;
    grid-auto-flow: column;
    gap: 0;
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    border: 1px solid var(--border-tint);
    border-radius: 12px;
    padding: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,.04);
    user-select: none;
  }
  .mode-option{
    position: relative;
    z-index: 1;
    padding: 8px 10px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .mode-thumb{
    position: absolute;
    z-index: 0;
    top: 4px; left: 4px;
    width: calc((100% - 8px)/3);
    height: calc(100% - 8px);
    border-radius: 8px;
    background: linear-gradient(45deg, var(--primary), var(--primary-2));
    box-shadow: 0 10px 22px rgba(var(--primary-rgb),.35), 0 2px 8px rgba(0,0,0,.10);
    transition: left .25s ease;
  }
  .mode-switch[data-active="system"] .mode-thumb{ left: 4px; }
  .mode-switch[data-active="light"]  .mode-thumb{ left: calc(4px + (100% - 8px)/3); }
  .mode-switch[data-active="dark"]   .mode-thumb{ left: calc(4px + 2*(100% - 8px)/3); }
  .mode-switch[data-active="system"] .mode-option[data-mode="system"],
  .mode-switch[data-active="light"]  .mode-option[data-mode="light"],
  .mode-switch[data-active="dark"]   .mode-option[data-mode="dark"]{
    color: #fff;
  }
</style>
</head>
<body>
  <div id="netBanner">📡 Sin conexión — los pedidos se guardan localmente</div>
  <header>
    <div class="header-title">
        <span>🛒 Pedidos ML</span>
        <span id="pedidoContador">0</span>
    </div>
    <div id="connDot" class="offline"></div>
    <span class="conn-label"></span>
  </header>

  <main id="nuevoPedido">
    <div id="helloBanner"></div>
    <div class="theme-row">
      <span>🎨</span>
      <div class="swatch" data-color="#4f46e5" title="Indigo"  style="background:linear-gradient(135deg,#4f46e5,#4338ca)"></div>
      <div class="swatch" data-color="#16a34a" title="Verde"   style="background:linear-gradient(135deg,#16a34a,#3b82f6)"></div>
      <div class="swatch" data-color="#db2777" title="Rosa"    style="background:linear-gradient(135deg,#db2777,#f59e0b)"></div>
      <div class="swatch" data-color="#d97706" title="Naranja" style="background:linear-gradient(135deg,#d97706,#fb7185)"></div>
      <div class="swatch" data-color="#06b6d4" title="Cian"    style="background:linear-gradient(135deg,#06b6d4,#7c3aed)"></div>

      <div class="mode-switch" id="modeSwitch" role="tablist" aria-label="Modo de tema" style="margin-left:6px;">
        <button class="mode-option" data-mode="system" role="tab" aria-selected="true">Auto</button>
        <button class="mode-option" data-mode="light"  role="tab" aria-selected="false">Claro</button>
        <button class="mode-option" data-mode="dark"   role="tab" aria-selected="false">Oscuro</button>
        <span class="mode-thumb" aria-hidden="true"></span>
      </div>
    </div>

    <div class="row" id="rowFecha">
      <label>📅 Fecha de entrega</label>
      <input type="date" id="fechaEntrega" />
    </div>
    <div class="row" id="rowCliente">
      <label>🧾 Número de cliente</label>
      <input type="tel" inputmode="numeric" pattern="[0-9]*" id="numeroCliente" placeholder="Ej: 10331" autocomplete="off" />
    </div>
    <div class="row" id="rowVendedor">
      <label>👤 Nombre del vendedor</label>
      <input type="text" id="nombreVendedor" placeholder="Ej: MARTIN" />
    </div>
    <div class="row" id="rowProductos">
      <label>📦 Productos solicitados</label>
      <textarea id="productos" rows="4" placeholder="Detalle de productos..." autocapitalize="characters" autocorrect="off" inputmode="text" style="text-transform: uppercase;"></textarea>
    </div>
    <div class="row" id="rowObs">
      <label>🗒️ Observaciones (opcional)</label>
      <textarea id="observaciones" rows="2" placeholder="Notas adicionales..."></textarea>
    </div>
    <div class="row">
        <label style="flex-direction: row; align-items: center; gap: 8px; font-weight: normal; color: var(--text);">
            <input type="checkbox" id="shareWA" style="width: auto;" />
            Enviar resumen por WhatsApp a Laura
        </label>
    </div>

    <div class="toolbar">
      <button id="btnEnviar" class="btn">
        <span class="btn-text">Enviar pedido</span>
        <div class="spinner" style="display: none;"></div>
      </button>
      <button id="btnNuevoLote" class="btn-secondary">Agregar otro (mismo día/vendedor)</button>
    </div>
  </main>

  <main id="pendientes" style="display:none;">
    <h3>📋 Pedidos pendientes</h3>
    <div class="search-row">
      <input id="searchPend" type="search" placeholder="Buscar por cliente..." />
      <button id="btnSyncHoy" class="btn-secondary" title="Reenviar solo los de hoy">Hoy</button>
      <button id="btnReintentarTodos" class="btn" title="Intentar enviar todo lo pendiente">Todos</button>
    </div>
    <div class="pend-legend">
      <div>🔎 Escribí para <b>filtrar</b> por cliente.</div>
      <div>🔄 <b>Hoy</b>: reenvía solo los pedidos con fecha de hoy.</div>
      <div>📤 <b>Todos</b>: intenta reenviar todos los pendientes.</div>
    </div>
    <div id="listaPendientes"></div>
  </main>

  <main id="estadisticas" style="display:none;">
    <h3>📊 Estadísticas (este dispositivo)</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Enviados</div>
        <div id="statEnviados" class="stat-value">0</div>
        <div class="bar"><div id="barEnviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Pendientes</div>
        <div id="statPendientes" class="stat-value">0</div>
        <div class="bar"><div id="barPendientes" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Reenviados</div>
        <div id="statReenviados" class="stat-value">0</div>
        <div class="bar"><div id="barReenviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">% Éxito</div>
        <div id="statExito" class="stat-value">0%</div>
        <div class="bar"><div id="barExito" class="fill"></div></div>
      </div>
    </div>
    <div class="stat-card" style="margin-top:14px;">
      <div class="stat-title">Promedio de pedidos enviados por día</div>
      <div id="statPromedio" class="stat-value">0</div>
    </div>
  </main>

  <div class="bottom-nav">
    <button id="btnNuevo" class="tab-btn active">Nuevo</button>
    <button id="btnVerPendientes" class="tab-btn">Pendientes</button>
    <button id="btnVerEstadisticas" class="tab-btn">Estadísticas</button>
  </div>

  <div id="toast-container"></div>

  <div id="confirmOverlay">
    <div class="success-box">
        <svg class="checkmark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      <h2 style="margin:10px 0 0 0;">¡Pedido enviado!</h2>
      <p style="opacity:.9;margin:6px 0 0 0;">Se guardó correctamente</p>
    </div>
  </div>

<script>
  // ==== CONFIG ====
  const GF_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSfgUbkynVRveiW547pgX0AgvVDGnCd1GUoXooMTDXkiCWgdKA/formResponse";

  const GF = {
    vendedor: "entry.1003904475",
    fecha:    "entry.171879298",
    fecha_day:   "entry.171879298_day",
    fecha_month: "entry.171879298_month",
    fecha_year:  "entry.171879298_year",
    cliente:  "entry.1103049985",
    productos:"entry.1828255967",
    observaciones: "entry.897131524",
    sig: "entry.1902043730"
  };

  // === DEDUPE helpers (misma lógica) ===
  function normalizeStr(s){
    return (s||"").toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^A-Z0-9\s\n]/g,"")
      .replace(/\s+/g," ").trim();
  }
  function normalizeProductos(s){
    const lines = (s||"").split(/\n+/).map(x=>normalizeStr(x)).filter(Boolean);
    lines.sort();
    return lines.join("|");
  }
  function fnv1a(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h = Math.imul(h ^ str.charCodeAt(i), 0x01000193);
    }
    return (h>>>0).toString(16);
  }
  function makeSignature(p){
    const base = `${(p.fechaEntrega||"").slice(0,10)}|${normalizeStr(p.numeroCliente)}|${normalizeStr(p.nombreVendedor)}|${normalizeProductos(p.productos)}`;
    return fnv1a(base);
  }
  const SIG_KEY = "signaturesEnviadas";
  function getSigMap(){ try { return JSON.parse(localStorage.getItem(SIG_KEY)||"{}"); } catch { return {}; } }
  function seenSig(sig){ return !!getSigMap()[sig]; }
  function markSig(sig){ const m = getSigMap(); m[sig]=Date.now(); localStorage.setItem(SIG_KEY, JSON.stringify(m)); }
  (function pruneSigs(days=30){
    const t = Date.now()-days*86400000, m=getSigMap(); let changed=false;
    for(const k in m){ if(m[k]<t){ delete m[k]; changed=true; } }
    if(changed) localStorage.setItem(SIG_KEY, JSON.stringify(m));
  })();

  function sendToGoogleForm(p){
    return new Promise((resolve)=>{
      const iframeName = "gform_iframe_" + Date.now();
      const iframe = document.createElement("iframe");
      iframe.name = iframeName;
      iframe.style.display = "none";
      document.body.appendChild(iframe);

      const form = document.createElement("form");
      form.action = GF_ACTION;
      form.method = "POST";
      form.target = iframeName;
      form.acceptCharset = "UTF-8";
      form.style.display = "none";

      const add = (name, val)=>{
        if(!name) return;
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = name;
        input.value = val == null ? "" : String(val);
        form.appendChild(input);
      };

      add(GF.vendedor,     p.nombreVendedor);
      add(GF.cliente,      p.numeroCliente);
      add(GF.productos,    p.productos);
      add(GF.observaciones,p.observaciones || "");

      const fecha = (p.fechaEntrega || "").trim();
      if (fecha) {
        add(GF.fecha, fecha);
        const [yyyy, mm, dd] = fecha.split("-");
        if (GF.fecha_day && GF.fecha_month && GF.fecha_year && dd && mm && yyyy) {
          add(GF.fecha_day,   dd);
          add(GF.fecha_month, mm);
          add(GF.fecha_year,  yyyy);
        }
      }
      add(GF.sig, p.sig || "");
      document.body.appendChild(form);
      const cleanup = () => { try { form.remove(); iframe.remove(); } catch {} };
      const timeout = setTimeout(() => { cleanup(); resolve({ status: "ok", via: "timeout" }); }, 5000);
      iframe.addEventListener("load", ()=>{ clearTimeout(timeout); cleanup(); resolve({ status: "ok" }); });
      form.submit();
    });
  }

  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxPAwRf6K5d7xf-UfcM79wVOE1aMGfn6zT0pp_rF6Ta6qAGoCO8ZIEe2RWLlVP1WRIxEg/exec";

  // ==== ELEMENTOS ====
  const $ = id => document.getElementById(id);
  const fechaEntrega = $("fechaEntrega"), numeroCliente = $("numeroCliente"), nombreVendedor = $("nombreVendedor"), productos = $("productos"), observaciones = $("observaciones"), btnEnviar = $("btnEnviar"), btnNuevoLote = $("btnNuevoLote"), toastContainer = $("toast-container"), connDot = $("connDot"), netBanner = $("netBanner"), helloBanner = $("helloBanner"), shareWA = $("shareWA"), searchPend = $("searchPend"), pedidoContador = $("pedidoContador");

  // SONIDO & VIBRA
  const sndOk = new Audio("data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA");
  function vib(ms=70){ if('vibrate' in navigator) navigator.vibrate(ms); }
  function playOk(){ try{ sndOk.currentTime=0; sndOk.play(); }catch{} }

  // TOAST
  function showToast(msg, type="info"){
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    let bgColor = "#ffcd38", color = "#1f2937";
    if (type === "error") { bgColor = "#ef4444"; color = "#fff"; }
    if (type === "ok") { bgColor = "#22c55e"; color = "#fff"; }
    toast.style.background = bgColor; toast.style.color = color;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }

  // ===== THEME dinámico (CORREGIDO) =====
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  function hexToRgb(hex){
    let h = hex.replace('#','').trim();
    if (h.length===3) h = h.split('').map(c=>c+c).join('');
    const n = parseInt(h,16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }
  function rgbToHex({r,g,b}){
    const to = v => v.toString(16).padStart(2,'0');
    return `#${to(clamp(Math.round(r),0,255))}${to(clamp(Math.round(g),0,255))}${to(clamp(Math.round(b),0,255))}`;
  }
  function mixRGB(a,b,t){ return { r:a.r+(b.r-a.r)*t, g:a.g+(b.g-a.g)*t, b:a.b+(b.b-a.b)*t }; }
  function darkenRGB(a,t){ return mixRGB(a,{r:0,g:0,b:0},t); }
  function lightenRGB(a,t){ return mixRGB(a,{r:255,g:255,b:255},t); }
  function relLum({r,g,b}){
    const toLin = v => { v/=255; return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4); };
    return 0.2126*toLin(r)+0.7152*toLin(g)+0.0722*toLin(b);
  }

  function setTheme(hex) {
      const root = document.documentElement;
      const base = hexToRgb(hex);
      const savedMode = localStorage.getItem(MODE_KEY) || "system";
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

      // Determinar si estamos en modo oscuro de forma fiable
      const isDarkMode = root.classList.contains('dark') || (savedMode === 'system' && prefersDark);

      // Colores primarios del tema (comunes a ambos modos)
      const primary2 = rgbToHex(darkenRGB(base, 0.18));
      root.style.setProperty("--primary", hex);
      root.style.setProperty("--primary-2", primary2);
      root.style.setProperty("--primary-light", `rgba(${base.r},${base.g},${base.b},0.22)`);
      root.style.setProperty("--primary-rgb", `${base.r},${base.g},${base.b}`);

      if (isDarkMode) {
          // --- Lógica para MODO OSCURO ---
          // Genera fondos y cards oscuros derivados del color del tema
          const darkBorderBase = hexToRgb(getComputedStyle(root).getPropertyValue('--dark-border').trim());
          const border   = rgbToHex(mixRGB(base, darkBorderBase, 0.85));
          const bgStart   = rgbToHex(darkenRGB(base, 0.92));
          const bgEnd     = rgbToHex(darkenRGB(base, 0.90));
          const cardStart = rgbToHex(darkenRGB(base, 0.88));
          const cardEnd   = rgbToHex(darkenRGB(base, 0.91));
          const fieldBg   = rgbToHex(darkenRGB(base, 0.90));

          root.style.setProperty("--border-tint", border);
          root.style.setProperty("--bg-grad-start", bgStart);
          root.style.setProperty("--bg-grad-end", bgEnd);
          root.style.setProperty("--card-grad-start", cardStart);
          root.style.setProperty("--card-grad-end", cardEnd);
          root.style.setProperty("--field-grad-start", fieldBg);
          root.style.setProperty("--field-grad-end", fieldBg);
      } else {
          // --- Lógica para MODO CLARO (Original) ---
          const border   = rgbToHex(lightenRGB(base, 0.78));
          const bgStart   = rgbToHex(lightenRGB(base, 0.90));
          const bgEnd     = rgbToHex(lightenRGB(base, 0.97));
          const cardStart = rgbToHex(lightenRGB(base, 0.94));
          const cardEnd   = rgbToHex(lightenRGB(base, 0.985));
          const fieldStart= rgbToHex(lightenRGB(base, 0.965));
          const fieldEnd  = rgbToHex(lightenRGB(base, 0.99));

          root.style.setProperty("--border-tint", border);
          root.style.setProperty("--bg-grad-start", bgStart);
          root.style.setProperty("--bg-grad-end", bgEnd);
          root.style.setProperty("--card-grad-start", cardStart);
          root.style.setProperty("--card-grad-end", cardEnd);
          root.style.setProperty("--field-grad-start", fieldStart);
          root.style.setProperty("--field-grad-end", fieldEnd);
      }
      localStorage.setItem("themeColor", hex);
  }

  (()=>{
    const stored = localStorage.getItem("themeColor");
    if(stored) setTheme(stored);
    document.querySelectorAll(".swatch").forEach(s=>{
      s.addEventListener("click", ()=> setTheme(s.getAttribute("data-color")));
    });
  })();

  const MODE_KEY = "uiMode";
  const modeSwitch = document.getElementById("modeSwitch");

  function applyMode(mode){
    const root = document.documentElement;
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

    root.classList.remove('light', 'dark');
    if (mode === "dark" || (mode === "system" && prefersDark)) {
        root.classList.add('dark');
    } else {
        root.classList.add('light'); // Añadido para mayor especificidad si fuera necesario
    }

    if (modeSwitch){
      modeSwitch.dataset.active = mode;
      modeSwitch.querySelectorAll(".mode-option").forEach(btn=>{
        btn.setAttribute("aria-selected", String(btn.dataset.mode === mode));
      });
    }
    // Re-aplicar el tema de color actual para que se ajuste al nuevo modo
    const storedTheme = localStorage.getItem("themeColor");
    if (storedTheme) setTheme(storedTheme);
  }
  applyMode(localStorage.getItem(MODE_KEY) || "system");

  if (modeSwitch){
    modeSwitch.addEventListener("click", (e)=>{
      const btn = e.target.closest(".mode-option");
      if(!btn) return;
      const mode = btn.dataset.mode;
      localStorage.setItem(MODE_KEY, mode);
      applyMode(mode);
    });
  }
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ()=>{
    const saved = localStorage.getItem(MODE_KEY) || "system";
    if (saved === 'system') applyMode('system');
  });

  // STORAGE
  const getQueue = () => JSON.parse(localStorage.getItem("pedidosPendientes") || "[]");
  const setQueue = arr => localStorage.setItem("pedidosPendientes", JSON.stringify(arr));
  const getStats = () => JSON.parse(localStorage.getItem("statsPedidos") || '{"enviados":0,"reenviados":0}');
  const setStats = s => localStorage.setItem("statsPedidos", JSON.stringify(s));
  const getHistory = () => JSON.parse(localStorage.getItem("historialEnviados") || "[]");
  const setHistory = h => localStorage.setItem("historialEnviados", JSON.stringify(h));
  const getSentIds = () => new Set(JSON.parse(localStorage.getItem("idsEnviados") || "[]"));
  const addSentId = (id) => {
    const arr = JSON.parse(localStorage.getItem("idsEnviados") || "[]");
    if(!arr.includes(id)) arr.push(id);
    localStorage.setItem("idsEnviados", JSON.stringify(arr));
  }

  // DRAFT
  const DRAFT_KEY = "draftPedido";
  function saveDraft(){
    const d = {
      fechaEntrega: fechaEntrega.value,
      numeroCliente: numeroCliente.value,
      nombreVendedor: nombreVendedor.value,
      productos: productos.value,
      observaciones: observaciones.value
    };
    localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
  }
  function loadDraft(){
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    try{
      // ... el resto del código JS no necesita cambios ...
</script>
</body>
</html>
