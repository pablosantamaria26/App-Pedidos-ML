<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Pedidos ML Pro</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
  :root {
    /* COLORES DIN√ÅMICOS */
    --primary: #3b82f6;      
    --primary-dark: #1d4ed8;
    --primary-dim: rgba(59, 130, 246, 0.2);
    --accent: #f59e0b;       

    /* INTERFAZ */
    --bg-overlay: rgba(15, 23, 42, 0.98); 
    --bg-card: rgba(30, 41, 59, 0.7);
    --text-main: #f8fafc;    
    --text-muted: #94a3b8;   
    --border: rgba(148, 163, 184, 0.15);       
    --success: #10b981;      
    --danger: #ef4444;       
    
    --radius: 16px;
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --input-height: 56px;

    /* AUMENTADO: Barra superior m√°s grande */
    --top-nav-height: 100px; 
    --header-height: 55px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body {
    margin: 0; padding: 0;
    width: 100%;
    max-width: 100%;
    overflow-x: hidden; /* Clave para que no se mueva a los costados */
    overscroll-behavior: none; /* Evita el rebote el√°stico en m√≥viles */
    font-family: 'Roboto', sans-serif;
    background: radial-gradient(circle at top right, #1e293b, #0f172a);
    background-attachment: fixed;
    color: var(--text-main);
    min-height: 100vh;
  }

  body {
    /* Ajustamos padding para la nueva altura de la barra */
    padding-top: calc(var(--top-nav-height) + var(--header-height) + 15px);
    padding-bottom: 40px;
    transition: background 0.5s ease;
  }

  .hidden { display: none !important; }
  
  /* NUEVA BARRA DE NAVEGACI√ìN SUPERIOR */
  .top-nav {
    position: fixed; 
    top: 0; left: 0; right: 0;
    height: var(--top-nav-height);
    background: var(--bg-overlay); 
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    display: grid;
    /* 5 columnas: botones laterales un poco m√°s anchos para comodidad */
    grid-template-columns: 1fr 1fr 2.5fr 1fr 1fr; 
    align-items: center;
    justify-items: center;
    padding: 0 8px;
    z-index: 200;
    box-shadow: 0 4px 25px rgba(0,0,0,0.5);
  }

  .tab-btn {
    background: transparent; border: none; color: #64748b;
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    padding: 4px; border-radius: 8px; transition: 0.2s; width: 100%;
  }
  .tab-btn span:first-child { font-size: 20px; margin-bottom: 0; }
  .tab-btn.active { color: var(--primary); }

  /* ANIMACI√ìN PARTYBOX RGB */
  @keyframes partyRGB {
    0% { border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5), inset 0 0 10px rgba(239, 68, 68, 0.2); }
    25% { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5), inset 0 0 10px rgba(245, 158, 11, 0.2); }
    50% { border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5), inset 0 0 10px rgba(16, 185, 129, 0.2); }
    75% { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5), inset 0 0 10px rgba(59, 130, 246, 0.2); }
    100% { border-color: #8b5cf6; box-shadow: 0 0 15px rgba(139, 92, 246, 0.5), inset 0 0 10px rgba(139, 92, 246, 0.2); }
  }

  /* BOT√ìN "ENVIAR PEDIDO" ESTILO PARTYBOX */
  #btnEnviar {
    /* Fondo oscuro para resaltar el borde RGB */
    background: linear-gradient(145deg, #1e293b, #0f172a);
    color: white;
    
    /* Borde inicial (se sobrescribe con la animaci√≥n) */
    border: 2px solid var(--primary);
    border-radius: 14px;
    
    height: 70px; /* Un poco m√°s alto */
    width: 98%;   /* Ocupa todo su espacio */
    
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    
    font-size: 14px;
    font-weight: 900;
    line-height: 1.1;
    text-transform: uppercase;
    letter-spacing: 1px;
    
    /* Aplicar animaci√≥n RGB */
    animation: partyRGB 5s infinite alternate;
    
    cursor: pointer;
    position: relative;
    transition: transform 0.1s;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  #btnEnviar:active { transform: scale(0.95); }
  
  /* HEADER (T√çTULO Y ESTADO) - AHORA DEBAJO DE LA NAV */
  header {
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(5px);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: var(--header-height);
    position: fixed; 
    top: var(--top-nav-height); /* Pegado abajo de la nav */
    left: 0; right: 0;
    z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
  }

  .app-title { font-size: 16px; font-weight: 900; letter-spacing: -0.5px; color: white; display:flex; align-items:center; gap:8px;}
  .counter-badge { background: var(--danger); font-size: 11px; padding: 2px 6px; border-radius: 99px; font-weight: bold; }

  .status-badge { 
    font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    padding: 4px 8px; border-radius: 99px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: var(--text-muted);
    display: flex; align-items: center; gap: 6px;
  }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); transition: 0.3s; }
  .dot.online { background: var(--success); box-shadow: 0 0 6px rgba(16,185,129,0.4); }
  .dot.offline { background: var(--danger); }
  .dot.syncing { background: var(--accent); animation: pulse 1s infinite; }

  /* CONTENEDORES */
  main { padding: 10px 20px 20px 20px; max-width: 600px; margin: 0 auto; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* SELECTOR DE TEMA */
  .theme-wrapper { margin-bottom: 20px; position: relative; }
  .theme-select {
    width: 100%; appearance: none; background: var(--bg-card); border: 1px solid var(--border);
    color: white; padding: 16px; padding-left: 50px; font-size: 16px; font-weight: 700;
    border-radius: var(--radius); outline: none; cursor: pointer; box-shadow: var(--shadow);
  }
  .theme-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 20px; pointer-events: none; }
  .theme-chevron { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); pointer-events: none; opacity: 0.5; }

  /* INPUTS */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  
  /* CAMBIO: En celulares ahora se ven uno abajo del otro (100% ancho) */
  @media (max-width: 480px) {
    .form-grid { 
        grid-template-columns: 1fr; /* Columna √∫nica para que ocupen todo el ancho */
        gap: 12px; 
    } 
  }

  .input-group { display: flex; flex-direction: column; margin-bottom: 16px; position: relative; }
  .input-group label {
    font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.7);
    margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  input, textarea, select:not(.theme-select) {
    background: var(--bg-card); border: 1px solid var(--border); color: white;
    border-radius: var(--radius); padding: 16px; font-size: 17px; font-family: inherit; width: 100%;
    transition: all 0.2s; backdrop-filter: blur(5px);
  }
  input:focus, textarea:focus {
    border-color: var(--primary); outline: none;
    background: rgba(0,0,0,0.4); box-shadow: 0 0 0 2px var(--primary-dim);
  }
  /* Estilo mejorado para fecha de entrega (match con numeroCliente) */
  #fechaEntrega { 
    height: var(--input-height); 
    font-size: 18px; 
    font-weight: 700; 
    color: var(--primary);
    text-align: center;
    padding-left: 4px; padding-right: 4px; 
  }
  #numeroCliente { font-size: 22px; font-weight: 800; height: var(--input-height); letter-spacing: 1.5px; color: var(--primary); text-align: center; }
  #productos { min-height: 180px; line-height: 1.6; font-family: 'Roboto Mono', monospace; font-size: 15px; }

  /* BOTONES MAGICOS */
  .magic-toolbar { 
    display: grid; 
    grid-template-columns: 1fr 1fr 1fr; /* 3 Columnas iguales */
    gap: 8px; 
    margin-bottom: 20px; 
    margin-top: -8px; 
  }
  .btn-magic {
    background: rgba(255, 255, 255, 0.08); 
    border: 1px solid rgba(255,255,255,0.1); /* Borde base */
    color: white; padding: 12px 4px; border-radius: 12px; 
    font-size: 12px; /* Un pel√≠n m√°s chico para que entre texto */
    font-weight: 600;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; 
    transition: 0.2s; backdrop-filter: blur(4px); white-space: nowrap;
  }
  .btn-magic:active { background: var(--primary-dim); border-color: var(--primary); transform: scale(0.96); }
  .btn-magic.rec { background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; animation: pulseRed 1s infinite; }

  /* CARDS */
  .pedido-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
    box-shadow: var(--shadow); position: relative; backdrop-filter: blur(10px);
  }
  .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .card-body { font-family: 'Roboto Mono', monospace; font-size: 13px; color: #cbd5e1; white-space: pre-wrap; line-height: 1.5; }
  
  /* ESTADISTICAS */
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .stat-box { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; backdrop-filter: blur(5px); }
  .stat-val { font-size: 32px; font-weight: 900; color: white; display: block; }
  .stat-lbl { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-top: 4px; display: block; }

  /* MODALES */
  .overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000;
    display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px);
  }
  .modal-box {
    background: #1e293b; border: 1px solid var(--border);
    width: 90%; max-width: 360px; padding: 24px; border-radius: 20px;
    text-align: center; color: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    animation: modalPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex; flex-direction: column; max-height: 85vh;
  }
  @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  .btn-modal { width: 100%; padding: 16px; border-radius: 12px; font-weight: 800; margin-top: 10px; border: none; font-size: 15px; cursor: pointer; }
  .btn-yes { background: var(--success); color: white; }
  .btn-no { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
  
  /* LISTA SUGERENCIAS */
  .upsell-list {
    text-align: left; margin-top: 10px; overflow-y: auto; flex: 1; margin-bottom: 10px;
    border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
    background: rgba(0,0,0,0.2); border-radius: 8px;
  }
  .upsell-item {
    padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); 
    display: grid; grid-template-columns: 30px 1fr 60px; align-items: center; gap: 8px;
    cursor: pointer; transition: 0.2s;
  }
  .upsell-item:active { background: rgba(255,255,255,0.1); }
  .upsell-check { transform: scale(1.3); accent-color: var(--primary); }
  .upsell-name { font-size: 13px; font-weight: 500; color: #e2e8f0; line-height: 1.2; word-break: break-word;}
  .upsell-qty { 
    background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; 
    border-radius: 6px; padding: 6px; width: 100%; text-align: center; font-weight: bold;
  }

  /* LOADER */
  #magicLoader { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); }
  .spinner-magic { width: 50px; height: 50px; border: 4px solid rgba(59, 130, 246, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  /* TOAST */
  .toast {
    position: fixed; top: 150px; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: white; padding: 14px 28px;
    border-radius: 99px; font-size: 15px; z-index: 4000; font-weight: 600;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border);
    animation: slideDown 0.3s forwards; display: flex; align-items: center; gap: 8px;
  }
  @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
  
  #netBanner { position:fixed; top:135px; width:100%; z-index:90; background: var(--danger); font-size: 12px; font-weight: 700; text-align: center; padding: 8px; display:none; letter-spacing: 0.5px; }
  
  @keyframes pulseRed { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
</style>
</head>
<body>

  <!-- LOADER -->
  <div id="magicLoader">
    <div class="spinner-magic"></div>
    <div style="font-weight: 700; font-size: 18px;">Procesando...</div>
  </div>

  <!-- NUEVA BARRA DE NAVEGACI√ìN SUPERIOR -->
  <nav class="top-nav">
    <button id="btnNuevo" class="tab-btn active"><span>üìù</span>Cargar</button>
    <button id="btnVerPendientes" class="tab-btn"><span>üì§</span>Cola</button>
    
    <!-- BOT√ìN CENTRAL GIGANTE PARTYBOX -->
    <button id="btnEnviar">
      <span>ENVIAR</span>
      <span>PEDIDO</span>
      <div class="spinner" style="display: none; font-size:16px;">‚è≥</div>
    </button>
    
    <button id="btnVerPredicciones" class="tab-btn"><span>üîÆ</span>Ideas</button>
    <button id="btnVerEstadisticas" class="tab-btn"><span>üìä</span>Stats</button>
  </nav>

  <!-- HEADER INFORMACI√ìN (Debajo de la nav) -->
  <header>
    <div class="app-title">PEDIDOS ML <span id="pedidoContador" class="counter-badge hidden">0</span></div>
    <div class="status-badge">
      <div id="connDot" class="dot offline"></div>
      <span class="conn-label">RED</span>
    </div>
  </header>

  <div id="netBanner">‚ö†Ô∏è MODO SIN CONEXI√ìN</div>

  <!-- PESTA√ëA 1: NUEVO PEDIDO -->
  <main id="nuevoPedido">
    <div id="helloBanner" style="margin-bottom: 15px;"></div>
    
    <!-- SELECTOR DE TEMA -->
    <div class="theme-wrapper">
      <span class="theme-icon">üé®</span>
      <select id="themeSelector" class="theme-select" onchange="changeTheme(this.value)">
        <option value="azul">Azul Profundo (Default)</option>
        <option value="verde">Naturaleza Eco</option>
        <option value="violeta">Galaxia Violeta</option>
        <option value="naranja">Atardecer</option>
        <option value="rosa">Candy Pop</option>
      </select>
      <span class="theme-chevron">‚ñº</span>
    </div>

    <div class="form-grid">
      <div class="input-group">
        <label>Fecha Entrega</label>
        <input type="date" id="fechaEntrega" />
      </div>
      <div class="input-group">
        <label>N¬∞ Cliente</label>
        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="numeroCliente" placeholder="Numero de cliente" autocomplete="off" />
      </div>
    </div>
    
    <!-- INFO CLIENTE MEJORADA -->
    <div id="infoCliente" style="margin-bottom: 16px; min-height: 20px;"></div>

    <div class="input-group">
      <label>Vendedor</label>
      <input type="text" id="nombreVendedor" placeholder="Tu nombre..." />
    </div>

    <div class="input-group" style="margin-bottom: 8px;">
      <label>üì¶ Productos (Cant + Nombre)</label>
      <textarea id="productos" placeholder="Ej:&#10;12 Trapos estrellita&#10;24 balerinas..."></textarea>
    </div>

    <!-- BOTONES DE AYUDA / HERRAMIENTAS - CORREGIDOS -->
    <div class="magic-toolbar">
      <button id="btnMicInline" class="btn-magic" style="border-color:var(--primary)">üéôÔ∏è Dictar</button>
      <!-- CORREGIDO: Ahora usa var(--primary) para el borde -->
      <button id="btnAiOptimize" class="btn-magic" style="border-color:var(--primary)">üßπ Acomodar</button>
      <button id="btnSuggestHistory" class="btn-magic" style="background:rgba(255,255,255,0.15); border-color:var(--primary)">
        üí° Sugeridos
      </button>
    </div>

    <div class="input-group">
      <label>Notas (Opcional)</label>
      <textarea id="observaciones" rows="2" placeholder="Ej: Entregar por la tarde..."></textarea>
    </div>
    
    <div style="display:none;"><input type="checkbox" id="shareWA" /></div>
  </main>

  <!-- PESTA√ëA 2: PENDIENTES -->
  <main id="pendientes" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; font-size: 20px;">üì§ En Cola</h3>
        <button id="btnReintentarTodos" style="background:var(--primary); color:white; border:none; padding:10px 14px; border-radius:10px; font-size:13px; font-weight:bold;">Sincronizar</button>
    </div>
    <div class="input-group">
      <input id="searchPend" type="search" placeholder="Filtrar por cliente..." />
    </div>
    <div id="listaPendientes"></div>
  </main>

  <!-- PESTA√ëA 3: ESTADISTICAS -->
  <main id="estadisticas" class="hidden">
    <h3 style="margin-top:0; font-size: 20px;">üìä Rendimiento</h3>
    <div class="stat-grid">
      <div class="stat-box">
        <span class="stat-val" style="color:var(--success)" id="statEnviados">0</span>
        <span class="stat-lbl">Enviados</span>
      </div>
      <div class="stat-box" style="border-color:rgba(239,68,68,0.2)">
        <span class="stat-val" style="color:var(--danger)" id="statPendientes">0</span>
        <span class="stat-lbl">Pendientes</span>
      </div>
    </div>
    <div style="margin-top:20px; padding:20px; background:var(--bg-card); border-radius:var(--radius); border:1px solid var(--border);">
       <label style="font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:bold;">Progreso de Carga</label>
       <div style="height:8px; background:rgba(255,255,255,0.1); border-radius:4px; margin-top:12px; overflow:hidden;">
          <div id="barEnviados" style="width:0%; height:100%; background:var(--success); transition:width 0.5s;"></div>
       </div>
    </div>
  </main>

  <!-- PESTA√ëA 4: PREDICCIONES -->
  <main id="predicciones" class="hidden">
    <h3 style="margin-top:0; font-size: 20px;">üîÆ Tendencias</h3>
    <div id="listaPredicciones"></div>
    <h4 style="margin-top:30px; color:var(--text-muted); font-size:11px; text-transform:uppercase; letter-spacing: 1px;">Historial Reciente (Local)</h4>
    <div id="resumenClientes"></div>
  </main>

  <!-- MODAL: SUGERENCIAS (UPSELL MEJORADO) -->
  <div id="upsellOverlay" class="overlay">
    <div class="modal-box" style="max-height:90vh;">
      <h3 style="margin:0 0 5px 0;">üí° Historial del Cliente</h3>
      <p style="font-size:13px; color:var(--text-muted); margin:0 0 10px 0;">Seleccion√° lo que le falta pedir hoy:</p>
      
      <div style="display:flex; justify-content:flex-end; margin-bottom:5px;">
        <button id="btnSelectAllUpsell" style="background:transparent; border:none; color:var(--primary); font-size:12px; font-weight:bold; cursor:pointer;">Seleccionar Todos</button>
      </div>

      <div id="upsellList" class="upsell-list"></div>
      
      <button id="btnAddSelectedUpsell" class="btn-modal btn-yes" style="margin-bottom:8px;">Agregar Seleccionados</button>
      <button id="btnCloseUpsell" class="btn-modal btn-no">Cerrar</button>
    </div>
  </div>

  <!-- MODAL: CONFIRMACI√ìN (CON DETALLES DE CLIENTE) -->
  <div id="preConfirmOverlay" class="overlay">
    <div class="modal-box">
      <h3 style="margin-top:0">¬øConfirm√°s el pedido?</h3>
      
      <!-- Contenedor para el nombre y detalles en el modal -->
      <div id="modalClientName" style="margin-bottom:10px; min-height:40px;"></div>

      <input type="tel" id="modalClientId" style="text-align:center; font-size:22px; font-weight:bold; background:rgba(0,0,0,0.2); width:140px; margin:0 auto; display:block; border:1px solid var(--border); border-radius:8px; padding:10px; color:white;" />
      <div style="font-size:11px; color:var(--text-muted); margin-top:5px;">Pod√©s cambiar el N¬∞ de cliente aqu√≠</div>
      
      <button id="btnConfirmYes" class="btn-modal btn-yes">S√ç, MANDALE</button>
      <button id="btnConfirmNo" class="btn-modal btn-no">NO, ESPER√Å</button>
      
      <button id="btnAiSummary" class="btn-modal" style="margin-top:15px; background:transparent; border:1px dashed var(--text-muted); color:var(--text-muted); font-size: 13px;">
        üí¨ Armar WhatsApp
      </button>
    </div>
  </div>

  <!-- MODAL: √âXITO -->
  <div id="confirmOverlay" class="overlay">
    <div class="modal-box" style="border-color:var(--success)">
      <div style="font-size:50px; margin-bottom:10px;">‚úÖ</div>
      <h2 style="color:var(--success); margin:0; font-size: 24px;">¬°LISTO!</h2>
      <p style="color:var(--text-muted); margin-top: 5px;">Pedido guardado.</p>
    </div>
  </div>

  <!-- MODAL: LATE -->
  <div id="lateModalOverlay" class="overlay">
    <div class="modal-box" style="border-color:var(--danger);">
      <div style="font-size:40px; margin-bottom:10px;">‚ö†Ô∏è</div>
      <h3 style="color:var(--danger); margin:0; font-size: 18px;">HORARIO L√çMITE</h3>
      <p style="margin:10px 0; font-size:14px; color:#cbd5e1;">Ya es tarde. Seguramente esto salga ma√±ana.</p>
      <button id="btnLateCerrar" class="btn-modal btn-yes">ENTENDIDO</button>
    </div>
  </div>

  <!-- MODAL: DICTADO -->
  <div id="dictadoOverlay" class="overlay">
    <div class="modal-box">
      <h3 style="font-size: 18px;">üéôÔ∏è Te escucho...</h3>
      <div id="dictadoPreview" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:12px; margin:15px 0; min-height:80px; text-align:left; font-style:italic; font-size:16px; color:#e2e8f0; border: 1px solid var(--border);"></div>
      <div style="display:flex; gap:10px;">
        <button id="btnDictadoCancelar" class="btn-modal btn-no" style="margin:0">Borrar</button>
        <button id="btnDictadoUsar" class="btn-modal btn-yes" style="margin:0">Usar</button>
      </div>
    </div>
  </div>

<script>
  // ==========================================
  // CONFIGURACI√ìN
  // ==========================================
  const GF_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSfgUbkynVRveiW547pgX0AgvVDGnCd1GUoXooMTDXkiCWgdKA/formResponse";
  const GF = { vendedor: "entry.1003904475", fecha: "entry.171879298", fecha_day: "entry.171879298_day", fecha_month: "entry.171879298_month", fecha_year: "entry.171879298_year", cliente: "entry.1103049985", productos: "entry.1828255967", observaciones: "entry.897131524", sig: "entry.1902043730" };
  const $ = id => document.getElementById(id);
  // LA API KEY YA NO EST√Å AQU√ç. SE GESTIONA EN EL WORKER.

  // URL HISTORIAL
  const SHEET_KEY = "1ZwO_E94WfhKOgRO99fqW_-bM6WyVhvYNCvjfUb33JWI";
  const GID = "1408509216";

  // ==========================================
  // TEMAS DIN√ÅMICOS
  // ==========================================
  const themes = {
    azul: { primary: '#3b82f6', dark: '#1d4ed8', bg: 'radial-gradient(circle at top right, #1e293b, #0f172a)' },
    verde: { primary: '#10b981', dark: '#047857', bg: 'linear-gradient(to bottom right, #064e3b, #022c22)' },
    violeta: { primary: '#8b5cf6', dark: '#6d28d9', bg: 'radial-gradient(ellipse at center, #2e1065, #0f172a)' },
    naranja: { primary: '#f97316', dark: '#c2410c', bg: 'linear-gradient(to bottom, #7c2d12, #451a03)' },
    rosa: { primary: '#ec4899', dark: '#be185d', bg: 'linear-gradient(45deg, #831843, #500724)' }
  };

  function changeTheme(themeName) {
    const t = themes[themeName] || themes.azul;
    document.documentElement.style.setProperty('--primary', t.primary);
    document.documentElement.style.setProperty('--primary-dark', t.dark); 
    document.documentElement.style.setProperty('--primary-dim', t.primary + '30');
    document.body.style.background = t.bg;
    localStorage.setItem('themePref', themeName);
  }

  // ==========================================
  // PARSEO Y CARGA
  // ==========================================
  function parseCSV(str) {
      const arr = [];
      let quote = false;  
      let col = 0, row = 0;
      for (let c = 0; c < str.length; c++) {
          let cc = str[c], nc = str[c+1];        
          arr[row] = arr[row] || [];             
          arr[row][col] = arr[row][col] || '';   
          if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; }
          else if (cc == '"') { quote = !quote; }
          else if (cc == ',' && !quote) { ++col; }
          else if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; }
          else if (cc == '\n' && !quote) { ++row; col = 0; }
          else { arr[row][col] += cc; }
      }
      return arr;
  }

  let globalHistorial = [];
  let clientNames = {}; // Ahora guardar√° objetos {name, desc}

  async function loadCli(){ 
    try{
      // SHEET_KEY ya est√° definida arriba. GID de BaseClientes: 2117683454
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_KEY}/export?format=csv&gid=2117683454&t=${Date.now()}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("Error fetching sheet");
      const txt = await r.text();
      const rows = parseCSV(txt);
      
      clientNames = {};
      
      // Asumiendo: Col A=ID, B=Nombre, C=Apellido, D=Domicilio, E=Localidad
      rows.forEach((r, idx) => {
          if (idx === 0) return; // Skip headers
          if(r.length >= 5) {
              const id = r[0].trim();
              const nombre = r[1].trim();
              const apellido = r[2].trim();
              const domicilio = r[3].trim();
              const localidad = r[4].trim();
              
              if(id) {
                  // Guardamos el objeto completo
                  clientNames[id] = {
                      name: `${nombre} ${apellido}`.trim(),
                      desc: `${domicilio}, ${localidad}`.trim()
                  };
              }
          }
      });
      
      // Actualizamos UI si ya hay algo escrito
      if($("numeroCliente").value) updateClientUI($("numeroCliente").value);
      
    }catch(e){ console.log("Error cargando clientes:", e); } 
  }

  function updateClientUI(id) {
    const c = clientNames[id]; 
    if (c) {
      $("infoCliente").innerHTML = `
        <div style="line-height:1.2; animation: slideUp 0.3s;">
          <div style="color:var(--success); font-weight:800; font-size:16px;">‚úÖ ${c.name}</div>
          <div style="color:var(--text-muted); font-size:12px; font-weight:400; margin-top:2px;">üìç ${c.desc}</div>
        </div>`;
    } else {
      $("infoCliente").innerHTML = "";
    }
  }
  
  $("numeroCliente").oninput = (e) => { 
    saveDraft(); 
    updateClientUI(e.target.value); 
  };

  async function loadHistorialVentas() {
    const urls = [
      `https://docs.google.com/spreadsheets/d/${SHEET_KEY}/gviz/tq?tqx=out:csv&gid=${GID}`, 
      `https://docs.google.com/spreadsheets/d/${SHEET_KEY}/pub?gid=${GID}&single=true&output=csv`,
      `https://docs.google.com/spreadsheets/d/${SHEET_KEY}/export?format=csv&gid=${GID}`
    ];
    let success = false;
    for (const url of urls) {
      if (success) break;
      try {
        const res = await fetch(url, { cache: 'no-store' }); 
        if (res.ok) {
           const txt = await res.text();
           if(txt.trim().startsWith("<")) continue;
           const rows = parseCSV(txt);
           globalHistorial = rows.slice(1).map(r => ({
              cliente: (r[3] || "").trim(),
              vendedor: (r[2] || "").trim(),
              productos: (r[6] || "")
           })).filter(x => x.cliente && x.productos);
           success = true;
        }
      } catch(e) {}
    }
  }

  // ==========================================
  // L√ìGICA UPSELL
  // ==========================================
  $("btnSuggestHistory").onclick = () => {
    const cli = $("numeroCliente").value.trim();
    if(!cli) return showToast("Pon√© el n√∫mero de cliente primero", "error");
    
    const ventasCliente = globalHistorial.filter(v => v.cliente === cli);
    if(ventasCliente.length === 0) return showToast("No encontr√© historial reciente para este cliente.", "info");

    const productosHistoricos = new Set();
    ventasCliente.forEach(v => {
       v.productos.split('\n').forEach(line => {
           let cleanName = line.toUpperCase().replace(/^[0-9\s.,-]+/, '').trim();
           if(cleanName.length > 3) productosHistoricos.add(cleanName);
       });
    });

    const textoActual = $("productos").value.toUpperCase();
    const faltantes = [...productosHistoricos].filter(item => !textoActual.includes(item)).slice(0, 15);

    if(faltantes.length === 0) return showToast("¬°Ya pidi√≥ todo lo que suele llevar!", "info");

    const listHtml = faltantes.map((item, idx) => `
      <div class="upsell-item">
         <input type="checkbox" class="upsell-check" id="chk_${idx}" value="${item}">
         <label for="chk_${idx}" class="upsell-name">${item}</label>
         <input type="number" class="upsell-qty" id="qty_${idx}" value="" placeholder="Cant.">
      </div>
    `).join("");
    
    $("upsellList").innerHTML = listHtml;
    $("upsellOverlay").style.display = "flex";
  };

  $("btnCloseUpsell").onclick = () => $("upsellOverlay").style.display = "none";

  $("btnSelectAllUpsell").onclick = () => {
     const checkboxes = document.querySelectorAll(".upsell-check");
     const allChecked = Array.from(checkboxes).every(c => c.checked);
     checkboxes.forEach(c => c.checked = !allChecked);
  };

  $("btnAddSelectedUpsell").onclick = () => {
      const checks = document.querySelectorAll(".upsell-check");
      let addedCount = 0;
      let textToAdd = "";

      checks.forEach((chk, idx) => {
          if(chk.checked) {
              const qtyInput = document.getElementById(`qty_${idx}`);
              const qty = qtyInput.value.trim() || "1"; 
              // FIX: Se agrega newline SOLO si el texto anterior no termina en newline
              textToAdd += (textToAdd ? "\n" : "") + `${qty} ${chk.value}`;
              addedCount++;
          }
      });

      if(addedCount > 0) {
          let currentVal = $("productos").value.trimEnd(); // Sacar espacios/newlines del final
          if (currentVal) currentVal += "\n"; // Si habia algo, agregar UN enter
          $("productos").value = currentVal + textToAdd;
          
          saveDraft();
          showToast(`Se agregaron ${addedCount} productos`);
          $("upsellOverlay").style.display = "none";
      } else {
          showToast("No seleccionaste nada", "error");
      }
  };


  // ==========================================
  // IA & HERRAMIENTAS - AHORA V√çA WORKER
  // ==========================================
  async function callMagic(prompt, sys) {
    const workerUrl = "https://frosty-term-20ea.santamariapablodaniel.workers.dev/";
    
    try {
      const res = await fetch(workerUrl, { 
        method: "POST", 
        headers: { "Content-Type": "application/json" }, 
        body: JSON.stringify({ prompt, sys }) // Enviamos datos simples al worker
      });
      
      if (!res.ok) throw new Error("Error en el Worker");

      const data = await res.json();
      return data.text; // El worker devuelve { text: "..." }

    } catch(e) { 
      console.error(e);
      return null; 
    }
  }

  // Helper para sacar productos conocidos
  function getKnownProducts() {
     const allProds = new Set();
     globalHistorial.forEach(h => {
        const lines = h.productos.split('\n');
        lines.forEach(l => {
           // Limpiar numeros iniciales
           let p = l.replace(/^\d+\s*/, '').trim().toUpperCase();
           if(p.length > 3) allProds.add(p);
        });
     });
     // Retornar solo los primeros 100 para no saturar el prompt
     return Array.from(allProds).slice(0, 100).join(", ");
  }

  $("btnAiOptimize").onclick = async () => {
    const txt = $("productos").value; 
    if(!txt) return showToast("Anot√° algo antes...", "error");
    $("magicLoader").style.display = "flex";
    
    const known = getKnownProducts();
    const sys = `Act√∫a como experto en log√≠stica. Tu tarea es organizar una lista de pedidos.
    Reglas CR√çTICAS:
    1. Detecta el patr√≥n "CANTIDAD ART√çCULO". Si el usuario escribe todo junto (ej: "12 lavandina 24 trapos"), SEPARALOS en l√≠neas nuevas.
    2. CUIDADO con los decimales: "2.5" NO se debe separar. "2.5L" es una unidad.
    3. Si encuentras palabras que no conoces, NO las borres. Trata de corregir la ortograf√≠a bas√°ndote en esta lista de productos conocidos: [${known}]. Si no est√° en la lista, d√©jalo como est√° pero bien formateado.
    4. Formato de salida: "CANTIDAD NOMBRE_DEL_ARTICULO" (un item por l√≠nea).
    5. Solo devuelve la lista final, sin texto extra.`;

    const resp = await callMagic(txt, sys);
    $("magicLoader").style.display = "none";
    if(resp) { $("productos").value = resp.trim(); showToast("¬°Lista acomodada! üßπ"); }
    else showToast("Error al procesar", "error");
  };

  // BOT√ìN WHATSAPP
  $("btnAiSummary").onclick = async () => {
    // Recuperar datos limpios del objeto si existe
    const clientData = clientNames[$("numeroCliente").value];
    const clientName = clientData ? clientData.name : "Cliente";
    
    const vendedor = $("nombreVendedor").value || "Vendedor";
    const productos = $("productos").value;

    const mensaje = `Hola *${clientName}*! üëã\n\nConfirmamos tu pedido:\n\n*Detalle:*\n${productos}\n\n¬°Todo confirmado! Gracias por confiar en Mercado limpio. Vas a recibir tu pedido muy pronto, cualquier cosa ten√©s mi contacto en WhatsApp, soy ${vendedor}.`;

    const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    window.open(url, '_blank');
  };

  // ==========================================
  // BASE DE DATOS LOCAL
  // ==========================================
  function normalizeStr(s){ return (s||"").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Z0-9\s\n]/g,"").replace(/\s+/g," ").trim(); }
  function normalizeProductos(s){ const lines = (s||"").split(/\n+/).map(x=>normalizeStr(x)).filter(Boolean); lines.sort(); return lines.join("|"); }
  function fnv1a(str){ let h=0x811c9dc5; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),0x01000193); } return (h>>>0).toString(16); }
  function makeSignature(p){ const base = `${(p.fechaEntrega||"").slice(0,10)}|${normalizeStr(p.numeroCliente)}|${normalizeStr(p.nombreVendedor)}|${normalizeProductos(p.productos)}`; return fnv1a(base); }
  
  const SIG_KEY = "signaturesEnviadas";
  function getSigMap(){ try{return JSON.parse(localStorage.getItem(SIG_KEY)||"{}")}catch{return{}} }
  function seenSig(sig){ return !!getSigMap()[sig]; }
  function markSig(sig){ const m=getSigMap(); m[sig]=Date.now(); localStorage.setItem(SIG_KEY, JSON.stringify(m)); }

  const getQueue = () => JSON.parse(localStorage.getItem("pedidosPendientes") || "[]");
  const setQueue = arr => { localStorage.setItem("pedidosPendientes", JSON.stringify(arr)); updatePendingCount(); };
  const getStats = () => JSON.parse(localStorage.getItem("statsPedidos") || '{"enviados":0,"reenviados":0}');
  const setStats = s => localStorage.setItem("statsPedidos", JSON.stringify(s));

  async function sendToGoogleForm(p) {
    const fd = new FormData();
    fd.append(GF.vendedor, p.nombreVendedor); fd.append(GF.cliente, p.numeroCliente); fd.append(GF.productos, p.productos); fd.append(GF.observaciones, p.observaciones || "");
    const f = (p.fechaEntrega || "").trim(); if(f){ fd.append(GF.fecha, f); const [y, m, d] = f.split("-"); if(GF.fecha_day) { fd.append(GF.fecha_day, d); fd.append(GF.fecha_month, m); fd.append(GF.fecha_year, y); } }
    fd.append(GF.sig, p.sig || "");
    try { await fetch(GF_ACTION, { method: "POST", mode: "no-cors", body: fd }); return { status: "ok" }; } 
    catch(e) { return { status: "error" }; }
  }

  // ==========================================
  // NAVEGACI√ìN
  // ==========================================
  const tabs = {
    nuevo: { main: $("nuevoPedido"), btn: $("btnNuevo") },
    pendientes: { main: $("pendientes"), btn: $("btnVerPendientes"), init: renderPendientes },
    stats: { main: $("estadisticas"), btn: $("btnVerEstadisticas"), init: renderStats },
    pred: { main: $("predicciones"), btn: $("btnVerPredicciones"), init: computePredictions }
  };

  function switchTab(target) {
    Object.values(tabs).forEach(t => { t.main.classList.add("hidden"); t.btn.classList.remove("active"); });
    const t = tabs[target]; t.main.classList.remove("hidden"); t.btn.classList.add("active");
    if(t.init) t.init();
  }

  $("btnNuevo").onclick = () => switchTab("nuevo");
  $("btnVerPendientes").onclick = () => switchTab("pendientes");
  $("btnVerEstadisticas").onclick = () => switchTab("stats");
  $("btnVerPredicciones").onclick = () => switchTab("pred");

  const PRED_DB_KEY = "historialPorClienteV1";
  function getPredDB(){ try{return JSON.parse(localStorage.getItem(PRED_DB_KEY)||"{}")}catch{return{}} }
  function logOrder(p){ 
    const db = getPredDB(); const k = p.numeroCliente.trim(); if(!k) return; 
    if(!db[k]) db[k] = []; 
    db[k].push({date: ymdLocal(new Date()), prod: p.productos}); 
    localStorage.setItem(PRED_DB_KEY, JSON.stringify(db)); 
  }
  
  function computePredictions(){
    const db = getPredDB(); const list = [];
    for(const k in db) {
      const last = db[k][db[k].length-1]; const days = Math.floor((new Date() - new Date(last.date))/(86400000));
      if(days > 7 && days < 40) list.push({k, days});
    }
    list.sort((a,b)=>b.days-a.days);
    $("listaPredicciones").innerHTML = list.length ? list.map(i=>`<div class="pedido-card">Cliente <b>${i.k}</b> pidi√≥ hace ${i.days} d√≠as.</div>`).join("") : `<div style="text-align:center; color:var(--text-muted)">Nada para sugerir hoy.</div>`;
  }

  // ==========================================
  // FLUJO DE ENV√çO Y CONFIRMACI√ìN
  // ==========================================
  $("btnEnviar").onclick = () => {
    if(!$("numeroCliente").value || !$("productos").value) return showToast("Faltan datos che...", "error");
    const currentId = $("numeroCliente").value;
    
    // Preparar el modal con los datos ricos
    $("modalClientId").value = currentId;
    updateModalClientInfo(currentId);
    
    $("preConfirmOverlay").style.display = "flex";
  };

  $("modalClientId").oninput = (e) => {
     updateModalClientInfo(e.target.value);
  };
  
  function updateModalClientInfo(id) {
     const c = clientNames[id];
     if (c) {
       $("modalClientName").innerHTML = `
         <div style="font-size:18px; color:var(--primary); font-weight:800;">${c.name}</div>
         <div style="font-size:13px; color:var(--text-muted); margin-top:4px;">${c.desc}</div>
       `;
     } else {
       $("modalClientName").innerHTML = `<div style="font-size:18px; color:var(--text-muted);">Cliente Nuevo</div>`;
     }
  }

  // FIX 1: HELPER PARA FECHA LOCAL
  function ymdLocal(date = new Date()) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  // FIX 2: LOGICA DE HORARIO L√çMITE CORREGIDA
  function verificarHorarioLimite(fechaEntregaStr) {
    const ahora = new Date();
    // Hora corte: 20:30
    const esTarde = (ahora.getHours() > 20) || (ahora.getHours() === 20 && ahora.getMinutes() >= 30);
    
    // Si es temprano, no pasa nada
    if (!esTarde) return false;

    const hoyStr = ymdLocal(ahora);
    
    const manana = new Date(ahora);
    manana.setDate(ahora.getDate() + 1);
    const mananaStr = ymdLocal(manana); 
    
    // Disparar si la entrega es HOY (ya es tarde) o MA√ëANA
    return (fechaEntregaStr === mananaStr || fechaEntregaStr === hoyStr);
  }

  function mostrarModalHorarioLimite(fechaEntregaStr) {
      // CALCULAR SIEMPRE FECHA DE MA√ëANA PARA EL MENSAJE
      const manana = new Date();
      manana.setDate(manana.getDate() + 1);
      
      const dia = String(manana.getDate()).padStart(2, '0');
      const mes = String(manana.getMonth() + 1).padStart(2, '0');
      const anio = manana.getFullYear();
      
      // Fecha formateada para el mensaje (siempre es "ma√±ana" real)
      const fechaArg = `${dia}-${mes}-${anio}`;

      const vendedor = $("nombreVendedor").value || "Vendedor";
      const mensaje = `Hola, soy ${vendedor}. Acabo de cargar pedidos para ma√±ana (${fechaArg}) fuera de horario. Por favor sacarlo con el reparto de ma√±ana. Gracias!`;
      
      const modal = $("lateModalOverlay");
      const p = modal.querySelector("p");
      const btn = modal.querySelector("button");
      
      p.innerHTML = `Son pasadas las 20:30hs.<br>Para que salga ma√±ana, avis√° al dep√≥sito ya.`;
      btn.textContent = "üì≤ AVISAR A DEP√ìSITO";
      btn.style.background = "#25D366"; 
      
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.onclick = () => {
          window.open(`https://wa.me/5491125781293?text=${encodeURIComponent(mensaje)}`, '_blank');
          modal.style.display = 'none';
      };
      
      modal.style.display = 'flex';
  }

  $("btnConfirmYes").onclick = () => {
    const finalId = $("modalClientId").value;
    $("numeroCliente").value = finalId; 
    updateClientUI(finalId);
    saveDraft();

    const p = { 
        id: "p"+Date.now(), 
        fechaEntrega: $("fechaEntrega").value, 
        numeroCliente: finalId, 
        nombreVendedor: $("nombreVendedor").value.toUpperCase(), 
        productos: $("productos").value.toUpperCase(), 
        observaciones: $("observaciones").value, 
        timestamp: Date.now() 
    };

    p.sig = makeSignature(p);
    if(seenSig(p.sig)) { showToast("¬°Ese ya lo mandaste!", "error"); $("preConfirmOverlay").style.display="none"; return; }
    
    const q = getQueue(); q.push(p); setQueue(q); logOrder(p);
    
    $("preConfirmOverlay").style.display = "none"; 
    $("confirmOverlay").style.display = "flex";
    
    if (verificarHorarioLimite(p.fechaEntrega)) {
        setTimeout(() => mostrarModalHorarioLimite(p.fechaEntrega), 500);
    }
    
    setTimeout(() => { $("confirmOverlay").style.display = "none"; clearForm(); }, 1500);
    syncQueue();
  };

  $("btnConfirmNo").onclick = () => $("preConfirmOverlay").style.display = "none";
  $("btnLateCerrar").onclick = () => $("lateModalOverlay").style.display = "none";

  function saveDraft(){ localStorage.setItem("draft", JSON.stringify({f:$("fechaEntrega").value, c:$("numeroCliente").value, p:$("productos").value, o:$("observaciones").value})); }
  function clearForm(){ $("productos").value=""; $("numeroCliente").value=""; $("observaciones").value=""; saveDraft(); $("numeroCliente").focus(); $("infoCliente").textContent=""; }
  $("productos").oninput = saveDraft; 

  // DICTADO INTEGRADO (INLINE)
  const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(Recognition){
    const rec = new Recognition(); rec.lang = "es-AR";
    rec.onresult = e => $("dictadoPreview").textContent = e.results[0][0].transcript;
    
    $("btnMicInline").onclick = () => { 
      $("dictadoOverlay").style.display = "flex"; 
      $("dictadoPreview").textContent="Te escucho..."; 
      rec.start(); 
    };
    
    $("btnDictadoUsar").onclick = () => { 
      const txt = $("dictadoPreview").textContent.toUpperCase();
      $("productos").value += ($("productos").value ? "\n" : "") + txt; 
      closeMic(); 
      saveDraft(); 
    };
    
    $("btnDictadoCancelar").onclick = closeMic;
    
    function closeMic(){ 
      rec.stop(); 
      $("dictadoOverlay").style.display="none"; 
    }
  } else { 
    $("btnMicInline").style.display="none"; 
  }

  let isSyncing = false;
  async function syncQueue() {
    if(isSyncing || !navigator.onLine) return;
    const q = getQueue(); if(!q.length) return;
    isSyncing = true; $("connDot").className = "dot syncing";
    let failed = [], successCount = 0;
    for(const p of q){
      const res = await sendToGoogleForm(p);
      if(res.status === 'ok') { markSig(p.sig); successCount++; } else failed.push(p);
    }
    setQueue(failed);
    const s = getStats(); s.enviados += successCount; setStats(s);
    isSyncing = false; updateConn();
    if($("pendientes").style.display !== "none") renderPendientes();
  }

  function updateConn(){
    const on = navigator.onLine; $("connDot").className = on ? "dot online" : "dot offline";
    $("netBanner").style.display = on ? "none" : "block";
    if(on) {
       setTimeout(syncQueue, 1000);
       loadHistorialVentas(); // Recargar historial al conectar
    }
  }
  window.addEventListener("online", updateConn); window.addEventListener("offline", updateConn);

  function updatePendingCount(){
    const c = getQueue().length; const el = $("pedidoContador"); el.textContent = c;
    if(c > 0) el.classList.remove("hidden"); else el.classList.add("hidden");
  }

  function renderPendientes(){
    const q = getQueue(); const filter = $("searchPend").value.toLowerCase(); const box = $("listaPendientes"); box.innerHTML = "";
    const list = q.filter(p => p.numeroCliente.includes(filter));
    if(!list.length) { box.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted)">Todo limpio por ac√°.</div>`; return; }
    list.reverse().forEach(p => {
      box.innerHTML += `<div class="pedido-card"><div class="card-header"><strong>${p.numeroCliente}</strong><span style="font-size:10px; color:var(--accent)">EN COLA</span></div><div class="card-body">${p.productos}</div></div>`;
    });
  }
  $("searchPend").oninput = renderPendientes; $("btnReintentarTodos").onclick = syncQueue;

  function renderStats(){
    const s = getStats(); const pen = getQueue().length;
    $("statEnviados").textContent = s.enviados; $("statPendientes").textContent = pen;
    const total = s.enviados + pen; $("barEnviados").style.width = total ? ((s.enviados/total)*100)+"%" : "0%";
  }

  function showToast(m, t="info"){ const el = document.createElement("div"); el.className="toast"; el.innerHTML = (t==="error"?"‚ö†Ô∏è ":"‚úÖ ") + m; if(t==="error") el.style.border="1px solid #ef4444"; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); }

  window.onload = () => {
    loadCli(); 
    loadHistorialVentas(); 
    updateConn(); 
    updatePendingCount();
    
    const d = JSON.parse(localStorage.getItem("draft")||"{}");
    if(d.c) { $("numeroCliente").value = d.c; updateClientUI(d.c); }
    if(d.p) $("productos").value = d.p; 
    if(d.o) $("observaciones").value = d.o;
    $("fechaEntrega").value = d.f || ymdLocal(new Date());
    
    const savedTheme = localStorage.getItem('themePref');
    if(savedTheme) { $("themeSelector").value = savedTheme; changeTheme(savedTheme); }

    const v = localStorage.getItem("nombreVendedor");
    if(v) { $("nombreVendedor").value = v; $("helloBanner").innerHTML = `<h3 style='margin:0 0 10px 0; color:var(--text-main); font-weight:500'>Hola, <span style="color:var(--primary); font-weight:800">${v.split(" ")[0]}</span> üëã</h3>`; }
    $("nombreVendedor").onchange = (e) => localStorage.setItem("nombreVendedor", e.target.value.toUpperCase());
    switchTab("nuevo");
  };

  if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js', { scope: './' })
        .then(reg => {
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showToast("üîÑ Actualizando App...", "ok");
                setTimeout(() => window.location.reload(), 1500);
              }
            });
          });
        })
        .catch(err => console.log('SW failed:', err));
    });
    let refreshing;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (refreshing) return;
      window.location.reload();
      refreshing = true;
    });
  }

  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const bar = document.querySelector('.top-nav'); 
    if (!bar || document.getElementById('btnInstall')) return;
    const btn = document.createElement('button');
    btn.id = 'btnInstall'; btn.className = 'tab-btn'; btn.innerHTML = '<span>üì≤</span>Instalar'; btn.style.color = 'var(--primary)';
    
    btn.style.position = 'fixed'; 
    btn.style.bottom = '20px'; 
    btn.style.right = '20px';
    btn.style.background = 'var(--bg-card)';
    btn.style.border = '1px solid var(--border)';
    btn.style.width = 'auto';
    btn.style.padding = '10px';
    document.body.appendChild(btn);

    btn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') showToast('Instalaci√≥n iniciada', 'ok');
      deferredPrompt = null; btn.remove();
    });
  });
  window.addEventListener('appinstalled', () => {
    const b = document.getElementById('btnInstall'); if (b) b.remove();
    showToast('App instalada ‚úîÔ∏è', 'ok');
  });
</script>
</body>
</html>
