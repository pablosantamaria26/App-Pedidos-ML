<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Pedidos ML</title>
  <meta name="theme-color" content="#06b6d4" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    /* Gradiente por defecto: Azul ‚Üí Verde */
    --primary:   #06b6d4; /* c1 */
    --primary-2: #22c55e; /* c2 */
    --primary-light: rgba(6,182,212,.22);
    --primary-rgb: 6,182,212;
    --primary-2-rgb: 34,197,94;

    /* --- TEMA CLARO (Default) --- */
    --bg: #f4f5f9;
    --text: #111827;
    --card: #ffffff;
    --muted: #6b7280;
    --border: #e5e7eb;
    --border-tint: #e5e7eb;
    --field-text: #0b0f14;
    --placeholder: rgba(11,15,20,.55);
    --bg-grad-start: #f7f9ff;
    --bg-grad-end:   #eef2ff;
    --card-grad-start:#ffffff;
    --card-grad-end:  #f3f6ff;
    --field-grad-start:#ffffff;
    --field-grad-end:  #f8f9fc;
    --success: #16a34a;
    --error: #ef4444;
    --shadow: 0 4px 12px rgba(0,0,0,0.10);
    --shadow-lg: 0 10px 30px rgba(0,0,0,0.16);

    --radius-pill: 999px;
  }

  /* --- MODO OSCURO --- */
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #0A0C10;
      --text: #f0f6fc;
      --card: #161b22;
      --muted: #8b949e;
      --border: #30363d;
      --border-tint: #30363d;
      --bg-grad-start: #0A0C10;
      --bg-grad-end:   #0d1117;
      --card-grad-start:#161b22;
      --card-grad-end:  #1a2028;
      --field-grad-start:#101419;
      --field-grad-end:  #101419;
      --shadow: 0 6px 16px rgba(0,0,0,0.35);
      --shadow-lg: 0 12px 32px rgba(0,0,0,0.45);
      --field-text: #f0f6fc;
      --placeholder: rgba(240, 246, 252, 0.45);
    }
  }

  html,body{ height: 100%; }
  body{
    font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
    margin: 0;
    padding: 0 0 180px 0;
    background:
      radial-gradient(1200px 600px at 0% -10%, rgba(var(--primary-rgb), .18), transparent 60%),
      radial-gradient(900px 500px at 110% 0%, rgba(var(--primary-2-rgb), .24), transparent 55%),
      linear-gradient(180deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    color: var(--text);
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background 300ms ease, color 300ms ease;
  }

  header{
    position: sticky; top: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
    background: linear-gradient(180deg, rgba(var(--card-grad-start),.85), rgba(var(--card-grad-end),.85));
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    color: var(--text);
    padding: 16px;
    border-bottom: 1px solid var(--border-tint);
    transition: background 300ms ease, border-color 300ms ease;
  }

  .header-title{ font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;}
  #pedidoContador{
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
    color: white;
    font-size: 12px; font-weight: 700;
    padding: 4px 8px; border-radius: 999px; min-width: 12px; text-align: center;
    box-shadow: 0 6px 18px rgba(var(--primary-rgb),.35);
  }

  #connDot{ width: 12px; height: 12px; border-radius: 50%; border: 2px solid transparent; box-shadow: 0 0 0 2px var(--border-tint); flex-shrink: 0; }
  .online{ background: #22c55e; }
  .offline{ background: #ef4444; }
  .syncing{ background: #facc15; animation:pulse 0.8s ease-in-out infinite alternate; }
  @keyframes pulse{ from{ opacity: 1; } to{ opacity: 0.4; } }

  .conn-label{ margin-left: 8px; font-size: 12px; font-style: italic; letter-spacing: .1px; opacity: .85; min-width: 96px; display: inline-block; }
  #connDot.online  + .conn-label::before{ content: "en l√≠nea";      color:#22c55e; }
  #connDot.offline + .conn-label::before{ content: "sin conexi√≥n";  color:#ef4444; }
  #connDot.syncing + .conn-label::before{ content: "sincronizando‚Ä¶"; color:#f59e0b; }

  #netBanner{ display:none; text-align:center; background:#facc15; color:#1f2937; padding: 8px; font-weight: 600; font-size: 14px; }

  main{ padding: 20px; max-width: 860px; margin: 0 auto; }
  h3 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }

  .row { margin-bottom: 18px; }
  label { display: flex; align-items: center; font-size: 14px; font-weight: 500; color: var(--muted); margin-bottom: 8px; }

  input, textarea, select {
    width: 100%; box-sizing: border-box; font-family: 'Inter', sans-serif;
    font-size: 16px; padding: 16px; border-radius: 14px;
    border: 1px solid var(--border-tint);
    background: linear-gradient(180deg, var(--field-grad-start), var(--field-grad-end));
    color: var(--field-text) !important; caret-color: var(--primary); outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background 300ms ease, color .2s ease;
    -webkit-appearance: none; background-clip: padding-box;
  }
  input::placeholder, textarea::placeholder{ color: var(--placeholder); }
  input:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
  textarea { min-height: 120px; resize: vertical; }

  .row:has(#shareWA) { display: none; }
  #btnNuevoLote { display: none; }

  /* === Botones estilo ‚Äúpill‚Äù con degradado === */
  .btn, .btn-secondary{
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    border-radius: var(--radius-pill);
    padding: 14px 18px; font-weight: 700; font-size: 15px; border: none; cursor: pointer;
    transition: transform .12s ease, filter .15s ease, box-shadow .25s ease, background .25s ease, color .2s ease;
  }
  .btn{
    color: #fff;
    background:
      linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0) 40%) ,
      linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
    box-shadow:
      0 20px 40px rgba(var(--primary-rgb), .35),
      0 6px 16px rgba(0,0,0,.12);
    filter: saturate(115%) contrast(105%);
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:active{ transform: translateY(0) scale(.98); filter: brightness(1.06) saturate(120%); }
  .btn[disabled], .btn.cooldown{ opacity:.72; cursor:not-allowed; filter: grayscale(.25); box-shadow: var(--shadow); pointer-events: none; }

  .btn-secondary{
    color: var(--text);
    background:
      linear-gradient(var(--card-grad-start), var(--card-grad-end)) padding-box,
      linear-gradient(90deg, var(--primary), var(--primary-2)) border-box;
    border: 2px solid transparent;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
  }
  .btn-secondary:hover{ transform: translateY(-1px); }
  .btn-secondary:active{
    color: #fff;
    background:
      linear-gradient(90deg, var(--primary), var(--primary-2)) padding-box,
      linear-gradient(90deg, var(--primary), var(--primary-2)) border-box;
    box-shadow: 0 12px 26px rgba(var(--primary-rgb), .28), 0 3px 10px rgba(0,0,0,.10);
  }

  /* Bot√≥n flotante principal */
  #btnEnviar {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
    z-index: 998; width: 90%; max-width: 420px;
    display: flex; align-items: center; justify-content: center;
    padding: 18px; font-size: 17px; border-radius: var(--radius-pill);
    background:
      radial-gradient(120% 160% at 0% 0%, rgba(255,255,255,.25), rgba(255,255,255,0) 40%),
      linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
    color: #fff;
    box-shadow:
      0 28px 60px rgba(var(--primary-rgb), .45),
      0 10px 22px rgba(0,0,0,.14);
  }
  #btnEnviar:active { transform: translateX(-50%) scale(0.98); filter: brightness(1.06) saturate(120%); }

  .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .btn[disabled] .btn-text { display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Bottom nav */
  .bottom-nav{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 999;
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-top: 1px solid var(--border-tint);
    display: flex; gap: 10px; padding: 12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    transition: background 300ms ease, border-color 300ms ease;
  }
  .bottom-nav button{
    flex: 1; border-radius: 12px; padding: 14px 8px; font-weight: 600; border: none;
    background: transparent; color: var(--muted); transition: all .2s ease;
  }
  .bottom-nav button.active{
    background: linear-gradient(90deg, var(--primary), var(--primary-2));
    color: #fff; box-shadow: 0 8px 22px rgba(var(--primary-rgb),.28);
  }

  .pedido-card, .stat-card {
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    border: 1px solid var(--border-tint);
    border-radius: 16px; padding: 16px; margin-bottom: 14px; box-shadow: var(--shadow);
    transition: background 300ms ease, border-color 300ms ease;
  }
  .pedido-card hr { border: none; border-top: 1px solid var(--border-tint); margin: 12px 0; }

  .toast{
    position: fixed; left: 50%; top: 16px; transform: translateX(-50%);
    color: #fff; padding: 14px 20px; border-radius: 12px; font-size: 15px; font-weight: 500;
    box-shadow: var(--shadow-lg); z-index: 1001; opacity: 0; animation: fadeInDown .3s ease forwards;
  }
  @keyframes fadeInDown { from { top: -20px; opacity: 0; } to { top: 16px; opacity: 1; } }

  #confirmOverlay{ display: none; position: fixed; inset: 0; z-index: 1002; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; animation: fadeIn .3s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .success-box{
    background: linear-gradient(180deg, var(--card-grad-start), var(--card-grad-end));
    color: var(--text); border-radius: 24px; padding: 36px 28px; text-align: center; width: min(90vw, 320px);
    box-shadow: var(--shadow-lg); animation: popIn .35s cubic-bezier(0.25, 0.46, 0.45, 0.94); border: 1px solid var(--border-tint);
  }
  @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .success-box h2{ margin: 16px 0 0 0; font-size: 22px; }
  .success-box p { opacity:.7; margin:6px 0 0 0; }

  .checkmark-svg { width: 80px; height: 80px; }
  .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke: var(--success); fill: none; animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
  @keyframes stroke { 100% { stroke-dashoffset: 0; } }
  .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke-width: 4; stroke: var(--success); stroke-linecap: round; fill: none; animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; }

  .stats-grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 8px; }
  .stat-title{ font-size: 13px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
  .stat-value{ font-size: 26px; font-weight: 700; }
  .bar{ margin-top: 10px; height: 8px; border-radius: 999px; background: var(--border-tint); overflow: hidden; }
  .bar > .fill{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--primary-2)); transition: width .4s ease; }

  /* === Selector de tema moderno === */
 .theme-row{
  display:flex; align-items:center; gap:10px; margin:10px 0 22px 0; flex-wrap:wrap;
}
.theme-row span{ font-weight:700; color:var(--muted); margin-right:2px; }

.swatch{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
  border-radius: var(--radius-pill);
  color:#fff; font-weight:700; font-size:13px; letter-spacing:.2px;
  border:2px solid transparent; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.08);
  user-select:none; transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
}
.swatch:hover{ transform: translateY(-1px); box-shadow:0 12px 26px rgba(0,0,0,.12); }
.swatch:active{ transform: translateY(0) scale(.98); filter:brightness(1.04); }


  .search-row{ display: flex; gap: 8px; margin-bottom: 10px; }
  .search-row input{ flex:1; }
  .search-row .btn, .search-row .btn-secondary { width: auto; flex-shrink: 0; min-width: 72px; }

  .pend-legend{ font-size: 12px; color: var(--muted); display: grid; gap: 4px; margin: 6px 2px 14px; }
  .pend-legend b{ color: var(--text); font-weight: 600; }


  /* Que el contenedor no quede tapado por el bot√≥n fijo al hacer scroll */
#rowObs{ scroll-margin-bottom: 140px; }

/* Altura c√≥moda + scroll interno elegante */
#observaciones{
  min-height: 120px;     /* altura base */
  max-height: 45vh;      /* no ocupa toda la pantalla */
  overflow: auto;        /* scroll dentro del campo */
  line-height: 1.35;
  scrollbar-gutter: stable;   /* evita saltos al aparecer la barra */
  overscroll-behavior: contain; /* no arrastra el body al llegar al borde */
}

/* Al enfocar, permit√≠ un poquito m√°s de alto (opcional) */
#observaciones:focus{ max-height: 60vh; }

/* Scrollbar linda (Chrome/Edge) */
#observaciones::-webkit-scrollbar{ width: 10px; }
#observaciones::-webkit-scrollbar-track{
  background: var(--card-grad-end);
  border-radius: 999px;
}
#observaciones::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, var(--primary), var(--primary-2));
  border-radius: 999px;
}
#observaciones::-webkit-scrollbar-thumb:hover{ filter: brightness(1.08); }

/* Scrollbar en Firefox */
#observaciones{
  scrollbar-width: thin;
  scrollbar-color: var(--primary) var(--card-grad-end);
}

  
</style>
</head>
<body>
  <div id="netBanner">üì° Sin conexi√≥n ‚Äî los pedidos se guardan localmente</div>
  <header>
    <div class="header-title">
        <span>üõí Pedidos ML</span>
        <span id="pedidoContador">0</span>
    </div>
    <div id="connDot" class="offline"></div>
    <span class="conn-label"></span>
  </header>

  <main id="nuevoPedido">
    <div id="helloBanner"></div>

    <!-- === Selector de tema (solo visual) === -->
    <div class="theme-row">
      <span>üé® Tema:</span>
      <div class="swatch" data-color="#06b6d4,#22c55e"
           style="background:linear-gradient(90deg,#06b6d4,#22c55e)">Azul ‚Üí Verde</div>

      <div class="swatch" data-color="#2563eb,#06b6d4"
           style="background:linear-gradient(90deg,#2563eb,#06b6d4)">Azul ‚Üí Cian</div>

      <div class="swatch" data-color="#db2777,#f59e0b"
           style="background:linear-gradient(90deg,#db2777,#f59e0b)">Rosa ‚Üí Naranja</div>

      <div class="swatch" data-color="#8b5cf6,#ec4899"
           style="background:linear-gradient(90deg,#8b5cf6,#ec4899)">Violeta ‚Üí Magenta</div>

    </div>

    <div class="row" id="rowFecha">
      <label>üìÖ Fecha de entrega</label>
      <input type="date" id="fechaEntrega" />
    </div>
    <div class="row" id="rowCliente">
      <label>üßæ N√∫mero de cliente</label>
      <input type="tel" inputmode="numeric" pattern="[0-9]*" id="numeroCliente" placeholder="Ej: 10331" autocomplete="off" />
    </div>
    <div class="row" id="rowVendedor">
      <label>üë§ Nombre del vendedor</label>
      <input type="text" id="nombreVendedor" placeholder="Ej: Josue" />
    </div>
    <div class="row" id="rowProductos">
      <label>üì¶ Productos solicitados</label>
      <textarea id="productos" rows="4" placeholder="Detalle de productos..." autocapitalize="characters" autocorrect="off" inputmode="text"></textarea>
    </div>
    <div class="row" id="rowObs">
      <label>üóíÔ∏è Observaciones (opcional)</label>
      <textarea id="observaciones" rows="5" placeholder="Notas adicionales..."></textarea>
    </div>
    <div class="row">
        <label style="flex-direction: row; align-items: center; gap: 8px; font-weight: normal; color: var(--text);">
            <input type="checkbox" id="shareWA" style="width: auto;" />
            Enviar resumen por WhatsApp a Laura
        </label>
    </div>

    <div class="toolbar">
      <button id="btnEnviar" class="btn">
        <span class="btn-text">Enviar pedido</span>
        <div class="spinner" style="display: none;"></div>
      </button>
      <button id="btnNuevoLote" class="btn-secondary">Agregar otro (mismo d√≠a/vendedor)</button>
    </div>
  </main>

  <main id="pendientes" style="display:none;">
    <h3>üìã Pedidos pendientes</h3>
    <div class="search-row">
      <input id="searchPend" type="search" placeholder="Buscar por cliente..." />
      <button id="btnSyncHoy" class="btn-secondary" title="Reenviar solo los de hoy">Hoy</button>
      <button id="btnReintentarTodos" class="btn" title="Intentar enviar todo lo pendiente">Todos</button>
    </div>
    <div class="pend-legend">
      <div>üîé Escrib√≠ para <b>filtrar</b> por cliente.</div>
      <div>üîÑ <b>Hoy</b>: reenv√≠a solo los pedidos con fecha de hoy.</div>
      <div>üì§ <b>Todos</b>: intenta reenviar todos los pendientes.</div>
    </div>
    <div id="listaPendientes"></div>
  </main>

  <main id="estadisticas" style="display:none;">
    <h3>üìä Estad√≠sticas (este dispositivo)</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Enviados</div>
        <div id="statEnviados" class="stat-value">0</div>
        <div class="bar"><div id="barEnviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Pendientes</div>
        <div id="statPendientes" class="stat-value">0</div>
        <div class="bar"><div id="barPendientes" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Reenviados</div>
        <div id="statReenviados" class="stat-value">0</div>
        <div class="bar"><div id="barReenviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">% √âxito</div>
        <div id="statExito" class="stat-value">0%</div>
        <div class="bar"><div id="barExito" class="fill"></div></div>
      </div>
    </div>
    <div class="stat-card" style="margin-top:14px;">
      <div class="stat-title">Promedio de pedidos enviados por d√≠a</div>
      <div id="statPromedio" class="stat-value">0</div>
    </div>
  </main>

  <div class="bottom-nav">
    <button id="btnNuevo" class="tab-btn active">Nuevo</button>
    <button id="btnVerPendientes" class="tab-btn">Pendientes</button>
    <button id="btnVerEstadisticas" class="tab-btn">Estad√≠sticas</button>
  </div>

  <div id="toast-container"></div>

  <div id="confirmOverlay">
    <div class="success-box">
        <svg class="checkmark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      <h2 style="margin:10px 0 0 0;">¬°Pedido enviado!</h2>
      <p style="opacity:.9;margin:6px 0 0 0;">Se guard√≥ correctamente</p>
    </div>
  </div>

<script>
  // ==== CONFIG ====
  const GF_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSfgUbkynVRveiW547pgX0AgvVDGnCd1GUoXooMTDXkiCWgdKA/formResponse";

  const GF = {
    vendedor: "entry.1003904475",
    fecha:    "entry.171879298",
    fecha_day:   "entry.171879298_day",
    fecha_month: "entry.171879298_month",
    fecha_year:  "entry.171879298_year",
    cliente:  "entry.1103049985",
    productos:"entry.1828255967",
    observaciones: "entry.897131524",
    sig: "entry.1902043730"
  };

  // === DEDUPE helpers (misma l√≥gica) ===
  function normalizeStr(s){
    return (s||"").toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^A-Z0-9\s\n]/g,"")
      .replace(/\s+/g," ").trim();
  }
  function normalizeProductos(s){
    const lines = (s||"").split(/\n+/).map(x=>normalizeStr(x)).filter(Boolean);
    lines.sort();
    return lines.join("|");
  }
  function fnv1a(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h = Math.imul(h ^ str.charCodeAt(i), 0x01000193);
    }
    return (h>>>0).toString(16);
  }
  function makeSignature(p){
    const base = `${(p.fechaEntrega||"").slice(0,10)}|${normalizeStr(p.numeroCliente)}|${normalizeStr(p.nombreVendedor)}|${normalizeProductos(p.productos)}`;
    return fnv1a(base);
  }
  const SIG_KEY = "signaturesEnviadas";
  function getSigMap(){ try { return JSON.parse(localStorage.getItem(SIG_KEY)||"{}"); } catch { return {}; } }
  function seenSig(sig){ return !!getSigMap()[sig]; }
  function markSig(sig){ const m = getSigMap(); m[sig]=Date.now(); localStorage.setItem(SIG_KEY, JSON.stringify(m)); }
  (function pruneSigs(days=30){
    const t = Date.now()-days*86400000, m=getSigMap(); let changed=false;
    for(const k in m){ if(m[k]<t){ delete m[k]; changed=true; } }
    if(changed) localStorage.setItem(SIG_KEY, JSON.stringify(m));
  })();

  // === Env√≠o al Google Form (versi√≥n con fetch y no-cors) ===
  async function sendToGoogleForm(p) {
    const formData = new FormData();
    formData.append(GF.vendedor, p.nombreVendedor);
    formData.append(GF.cliente, p.numeroCliente);
    formData.append(GF.productos, p.productos);
    formData.append(GF.observaciones, p.observaciones || "");

    const fecha = (p.fechaEntrega || "").trim();
    if (fecha) {
      formData.append(GF.fecha, fecha);
      const [yyyy, mm, dd] = fecha.split("-");
      if (GF.fecha_day && GF.fecha_month && GF.fecha_year) {
        formData.append(GF.fecha_day, dd);
        formData.append(GF.fecha_month, mm);
        formData.append(GF.fecha_year, yyyy);
      }
    }

    formData.append(GF.sig, p.sig || "");

    try {
      await fetch(GF_ACTION, {
        method: "POST",
        mode: "no-cors",
        body: formData
      });
      return { status: "ok" };
    } catch (err) {
      console.error("‚ùå Error enviando pedido:", err);
      return { status: "error" };
    }
  }

  // ==== ELEMENTOS ====
  const $ = id => document.getElementById(id);
  const fechaEntrega = $("fechaEntrega"), numeroCliente = $("numeroCliente"),
        nombreVendedor = $("nombreVendedor"), productos = $("productos"),
        observaciones = $("observaciones"), btnEnviar = $("btnEnviar"),
        btnNuevoLote = $("btnNuevoLote"), toastContainer = $("toast-container"),
        connDot = $("connDot"), netBanner = $("netBanner"), helloBanner = $("helloBanner"),
        shareWA = $("shareWA"), searchPend = $("searchPend"), pedidoContador = $("pedidoContador");

  // SONIDO & VIBRA
  const sndOk = new Audio("data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA");
  function vib(ms=70){ if('vibrate' in navigator) navigator.vibrate(ms); }
  function playOk(){ try{ sndOk.currentTime=0; sndOk.play(); }catch{} }

  // TOAST (sin cambios funcionales)
  function showToast(msg, type="info"){
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    let bgColor = "#ffcd38", color = "#1f2937";
    if (type === "error") { bgColor = "#ef4444"; color = "#fff"; }
    if (type === "ok") { bgColor = "#22c55e"; color = "#fff"; }
    toast.style.background = bgColor; toast.style.color = color;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }

  // ===== THEME din√°mico (ahora acepta 1 √≥ 2 colores) =====
  function setTheme(input){
    const root = document.documentElement;

    let c1, c2;
    if (typeof input === "string" && input.includes(",")) {
      const parts = input.split(",").map(s=>s.trim());
      c1 = parts[0]; c2 = parts[1] || parts[0];
    } else {
      c1 = input || getComputedStyle(root).getPropertyValue("--primary").trim() || "#06b6d4";
      // si viene solo 1 color, se oscurece para el 2do
      c2 = rgbToHex(darkenRGB(hexToRgb(c1), 0.18));
    }

    const base1 = hexToRgb(c1);
    const base2 = hexToRgb(c2);

    root.style.setProperty("--primary", c1);
    root.style.setProperty("--primary-2", c2);
    root.style.setProperty("--primary-light", `rgba(${base1.r},${base1.g},${base1.b},0.22)`);
    root.style.setProperty("--primary-rgb", `${base1.r},${base1.g},${base1.b}`);
    root.style.setProperty("--primary-2-rgb", `${base2.r},${base2.g},${base2.b}`);

    // Ajustes suaves del tema claro basados en c1
    const isDarkPref = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(!isDarkPref){
      const border   = rgbToHex(lightenRGB(base1, 0.78));
      const bgStart  = rgbToHex(lightenRGB(base1, 0.90));
      const bgEnd    = rgbToHex(lightenRGB(base1, 0.97));
      const cardStart= rgbToHex(lightenRGB(base1, 0.94));
      const cardEnd  = rgbToHex(lightenRGB(base1, 0.985));
      const fieldStart=rgbToHex(lightenRGB(base1, 0.965));
      const fieldEnd  = rgbToHex(lightenRGB(base1, 0.99));
      root.style.setProperty("--border-tint", border);
      root.style.setProperty("--bg-grad-start", bgStart);
      root.style.setProperty("--bg-grad-end", bgEnd);
      root.style.setProperty("--card-grad-start", cardStart);
      root.style.setProperty("--card-grad-end", cardEnd);
      root.style.setProperty("--field-grad-start", fieldStart);
      root.style.setProperty("--field-grad-end", fieldEnd);
    }

    localStorage.setItem("themeColor", `${c1},${c2}`);
  }

  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  function hexToRgb(hex){
    let h = hex.replace('#','').trim();
    if (h.length===3) h = h.split('').map(c=>c+c).join('');
    const n = parseInt(h,16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }
  function rgbToHex({r,g,b}){
    const to = v => v.toString(16).padStart(2,'0');
    return `#${to(clamp(Math.round(r),0,255))}${to(clamp(Math.round(g),0,255))}${to(clamp(Math.round(b),0,255))}`;
  }
  function mixRGB(a,b,t){ return { r:a.r+(b.r-a.r)*t, g:a.g+(b.g-a.g)*t, b:a.b+(b.b-a.b)*t }; }
  function darkenRGB(a,t){ return mixRGB(a,{r:0,g:0,b:0},t); }
  function lightenRGB(a,t){ return mixRGB(a,{r:255,g:255,b:255},t); }

  // Init tema + clicks del selector (sin romper compatibilidad)
  (()=>{
    const stored = localStorage.getItem("themeColor");
    setTheme(stored || "#06b6d4,#22c55e");
    document.querySelectorAll(".swatch").forEach(s=>{
      s.addEventListener("click", ()=> setTheme(s.getAttribute("data-color")));
    });
  })();

  // STORAGE
  const getQueue = () => JSON.parse(localStorage.getItem("pedidosPendientes") || "[]");
  const setQueue = arr => localStorage.setItem("pedidosPendientes", JSON.stringify(arr));
  const getStats = () => JSON.parse(localStorage.getItem("statsPedidos") || '{"enviados":0,"reenviados":0}');
  const setStats = s => localStorage.setItem("statsPedidos", JSON.stringify(s));
  const getHistory = () => JSON.parse(localStorage.getItem("historialEnviados") || "[]");
  const setHistory = h => localStorage.setItem("historialEnviados", JSON.stringify(h));

  // DRAFT
  const DRAFT_KEY = "draftPedido";
  function saveDraft(){
    const d = { fechaEntrega: fechaEntrega.value, numeroCliente: numeroCliente.value, nombreVendedor: nombreVendedor.value, productos: productos.value, observaciones: observaciones.value };
    localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
  }
  function loadDraft(){
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      fechaEntrega.value = d.fechaEntrega || fechaEntrega.value;
      numeroCliente.value = d.numeroCliente || "";
      nombreVendedor.value = d.nombreVendedor || nombreVendedor.value;
      productos.value = d.productos || "";
      observaciones.value = d.observaciones || "";
    }catch{}
  }
  [fechaEntrega,numeroCliente,nombreVendedor,productos,observaciones].forEach(el=> el.addEventListener("input", saveDraft));

  // VALIDACI√ìN y L√ìGICA DE FORMULARIO (sin cambios)
  function validateForm(){
    let valid = true;
    [fechaEntrega, numeroCliente, nombreVendedor, productos].forEach(el => {
      el.style.borderColor = "";
      if(!el.value.trim()){
        el.style.borderColor = "var(--error)";
        valid = false;
      }
    });
    if(!valid) showToast("Por favor, complet√° todos los campos.", "error");
    return valid;
  }

  // LIMPIAR FORM (sin cambios)
  function clearForm(full=true){
    numeroCliente.value = "";
    productos.value = "";
    observaciones.value = "";
    if(full){
      nombreVendedor.value = "";
      const today = new Date();
      const offset = today.getTimezoneOffset() * 60000;
      const localDate = new Date(today - offset);
      fechaEntrega.value = localDate.toISOString().substring(0,10);
      localStorage.removeItem(DRAFT_KEY);
    }
    numeroCliente.focus();
    updatePendingCount();
    saveDraft();
  }

  function showSuccess(opts = {}){
    const { title="¬°Pedido enviado!", subtitle="Se registr√≥ correctamente", duration=3200 } = opts;
    const ov = document.getElementById("confirmOverlay");
    ov.style.display = "flex";
    const h2 = ov.querySelector("h2");
    const p  = ov.querySelector("p");
    if (h2) h2.textContent = title;
    if (p)  p.textContent  = subtitle;

    const circle = ov.querySelector(".checkmark-circle");
    const check  = ov.querySelector(".checkmark-check");
    [circle, check].forEach(el=>{ if(!el) return; el.style.animation = "none"; void el.offsetWidth; el.style.animation = ""; });

    clearTimeout(ov._hideTimer);
    ov._hideTimer = setTimeout(()=>{ ov.style.display = "none"; }, duration);
  }

  // Anti doble-click (sin cambios)
  window.isCooling = function(el){ return !!(el && el.classList && el.classList.contains('cooldown')); };
  window.startCooldown = function(el, ms = 1200){ if(!el) return; el.classList.add('cooldown'); setTimeout(()=> el.classList.remove('cooldown'), ms); };

  // L√ìGICA DE ENV√çO (sin cambios funcionales)
  async function handleEnviar(){
    if (isCooling(btnEnviar)) return;
    if(!validateForm()) return;

    showSuccess({
      subtitle: navigator.onLine ? "Sincronizando con Google‚Ä¶" : "Guardado localmente, se enviar√° al reconectar",
      duration: 3400
    });
    playOk(); vib();

    btnEnviar.disabled = true;
    btnEnviar.querySelector('.spinner').style.display = 'block';
    btnEnviar.querySelector('.btn-text').style.display = 'none';

    const pedido = {
      id: "p_" + Date.now(),
      fechaEntrega: fechaEntrega.value,
      numeroCliente: numeroCliente.value,
      nombreVendedor: nombreVendedor.value.toUpperCase(),
      productos: productos.value.toUpperCase(),
      observaciones: observaciones.value,
      timestamp: Date.now()
    };
    pedido.sig = makeSignature(pedido);

    if (seenSig(pedido.sig)){
      showToast("Pedido duplicado detectado.", "error");
      btnEnviar.disabled = false;
      btnEnviar.querySelector('.spinner').style.display = 'none';
      btnEnviar.querySelector('.btn-text').style.display = 'block';
      return;
    }

    const queue = getQueue();
    queue.push(pedido);
    setQueue(queue);
    updatePendingCount();

    await syncQueue();

    const stillPending = getQueue().some(p => p.id === pedido.id);
    if (!stillPending) {
      showToast("Enviado ‚úîÔ∏è", "ok");
      markSig(pedido.sig);
      const stats = getStats();
      stats.enviados = (stats.enviados || 0) + 1;
      setStats(stats);
      const history = getHistory();
      history.push({ id: pedido.id, date: new Date().toISOString().slice(0,10) });
      if (history.length > 500) history.shift();
      setHistory(history);
    } else {
      showToast("Pedido guardado localmente.", "info");
    }

    if(shareWA.checked) {
      const resumen = `*PEDIDO ML*\n\n- *Cliente:* ${pedido.numeroCliente}\n- *Vendedor:* ${pedido.nombreVendedor}\n- *Fecha Entrega:* ${pedido.fechaEntrega.split('-').reverse().join('/')}\n\n*PRODUCTOS:*\n${pedido.productos}${pedido.observaciones ? `\n\n*OBS:*\n${pedido.observaciones}`:''}`;
      window.open(`https://wa.me/5491133395487?text=${encodeURIComponent(resumen)}`, '_blank');
    }

    clearForm(false);
    btnEnviar.disabled = false;
    btnEnviar.querySelector('.spinner').style.display = 'none';
    btnEnviar.querySelector('.btn-text').style.display = 'block';
    startCooldown(btnEnviar);
  }

  btnEnviar.addEventListener("click", handleEnviar);

  // L√ìGICA DE SINCRONIZACI√ìN (sin cambios)
  let isSyncing = false;
  async function syncQueue(forceAll = false) {
    if (isSyncing || !navigator.onLine) return;
    isSyncing = true;
    connDot.classList.remove("online", "offline");
    connDot.classList.add("syncing");

    let queue = getQueue();
    let originalQueueSize = queue.length;
    let failed = [];

    for (const pedido of queue) {
      if (!navigator.onLine) { failed.push(pedido); continue; }
      try {
        const res = await sendToGoogleForm(pedido);
        if (res.status === 'ok') {
          markSig(pedido.sig);
          if (forceAll) {
            const stats = getStats();
            stats.reenviados = (stats.reenviados || 0) + 1;
            setStats(stats);
          }
        } else { failed.push(pedido); }
      } catch (error) { failed.push(pedido); }
    }

    setQueue(failed);
    isSyncing = false;
    updateConnectionStatus();
    updatePendingCount();
    if($("pendientes").style.display !== 'none') renderPendientes();

    if(forceAll && originalQueueSize > 0){
      const enviados = originalQueueSize - failed.length;
      if(enviados > 0) showToast(`${enviados} pedido${enviados>1?'s':''} reenviado${enviados>1?'s':''} con √©xito!`, 'ok');
      else showToast('No se pudieron reenviar los pedidos.', 'error');
    }
  }

  // MANEJO DE CONEXI√ìN (sin cambios)
  function updateConnectionStatus() {
    if (isSyncing) return;
    const online = navigator.onLine;
    connDot.className = online ? "online" : "offline";
    netBanner.style.display = online ? "none" : "block";
    if (online) { setTimeout(syncQueue, 500); }
  }

  window.addEventListener("online", updateConnectionStatus);
  window.addEventListener("offline", updateConnectionStatus);

  // INICIALIZACI√ìN (sin cambios funcionales)
  document.addEventListener("DOMContentLoaded", () => {
    clearForm();
    loadDraft();
    updateConnectionStatus();
    setInterval(syncQueue, 60000);

    const h = new Date().getHours();
    let saludo = "¬°Buenas noches!";
    if(h >= 6 && h < 13) saludo = "¬°Buenos d√≠as!";
    if(h >= 13 && h < 20) saludo = "¬°Buenas tardes!";
    const nombreGuardado = localStorage.getItem("nombreVendedor") || "";
    if (nombreGuardado) {
        helloBanner.innerHTML = `<h3 style="margin-top:0;margin-bottom:20px;">${saludo}, <b>${nombreGuardado.split(' ')[0]}</b></h3>`;
    } else {
      helloBanner.style.display = "none";
    }
    nombreVendedor.addEventListener('change', (e) => localStorage.setItem("nombreVendedor", e.target.value));
    productos.addEventListener("input", ()=>{
      const s = productos.selectionStart, e = productos.selectionEnd;
      productos.value = productos.value.toUpperCase();
      try{ productos.setSelectionRange(s,e); }catch{}
    });
  });

  // TABS (sin cambios)
  const mainNuevo = $("nuevoPedido"), mainPendientes = $("pendientes"), mainStats = $("estadisticas");
  const btnNuevo = $("btnNuevo"), btnPendientes = $("btnVerPendientes"), btnStats = $("btnVerEstadisticas");

  function showTab(tabName) {
    mainNuevo.style.display = 'none';
    mainPendientes.style.display = 'none';
    mainStats.style.display = 'none';
    [btnNuevo, btnPendientes, btnStats].forEach(b=>b.classList.remove('active'));
    btnEnviar.style.display = 'none';

    if (tabName === 'nuevo') {
      mainNuevo.style.display = 'block';
      btnNuevo.classList.add('active');
      btnEnviar.style.display = 'flex';
    } else if (tabName === 'pendientes') {
      mainPendientes.style.display = 'block';
      btnPendientes.classList.add('active');
      renderPendientes();
    } else if (tabName === 'stats') {
      mainStats.style.display = 'block';
      btnStats.classList.add('active');
      renderStats();
    }
  }
  btnNuevo.addEventListener('click', () => showTab('nuevo'));
  btnPendientes.addEventListener('click', () => showTab('pendientes'));
  btnStats.addEventListener('click', () => showTab('stats'));

  // PENDIENTES (sin cambios)
  function renderPendientes(filter = "") {
    const queue = getQueue();
    const container = $("listaPendientes");
    container.innerHTML = "";
    const filteredQueue = queue.filter(p => p.numeroCliente.includes(filter));

    if (filteredQueue.length === 0) {
      container.innerHTML = `<div class="pedido-card" style="text-align:center; color: var(--muted);">No hay pedidos pendientes.</div>`;
      return;
    }

    filteredQueue.reverse().forEach(p => {
      const card = document.createElement("div");
      card.className = "pedido-card";
      const d = new Date(p.timestamp);
      card.innerHTML = `
        <b>Cliente: ${p.numeroCliente}</b> (Vendedor: ${p.nombreVendedor})<br>
        <small style="color:var(--muted)">Fecha entrega: ${p.fechaEntrega.split('-').reverse().join('/')} | Guardado: ${d.toLocaleDateString()} ${d.toLocaleTimeString()}</small>
        <hr>
        <pre style="white-space:pre-wrap; font-family:inherit; margin:0;">${p.productos}</pre>
        ${p.observaciones ? `<hr><pre style="white-space:pre-wrap;font-family:inherit;margin:0;opacity:.8;">${p.observaciones}</pre>` : ''}
      `;
      container.appendChild(card);
    });
  }

  searchPend.addEventListener("input", e => renderPendientes(e.target.value));
  $("btnReintentarTodos").addEventListener("click", () => syncQueue(true));
  $("btnSyncHoy").addEventListener("click", () => {
    const todayStr = new Date().toISOString().slice(0, 10);
    const queue = getQueue();
    const hoy = queue.filter(p => p.fechaEntrega === todayStr);
    if(hoy.length > 0) {
      const originalQueue = [...queue];
      setQueue(hoy);
      syncQueue(true).then(() => {
        const restantes = getQueue();
        const originalMenosHoy = originalQueue.filter(p => p.fechaEntrega !== todayStr);
        setQueue([...restantes, ...originalMenosHoy]);
        renderPendientes();
      });
    } else {
      showToast("No hay pedidos pendientes para hoy.", "info");
    }
  });

  function updatePendingCount() {
    const count = getQueue().length;
    pedidoContador.textContent = count;
    pedidoContador.style.display = count > 0 ? 'inline-block' : 'none';
    const pendBtn = $("btnVerPendientes");
    const currentCount = pendBtn.querySelector('span');
    if (count > 0) {
      if(currentCount) currentCount.textContent = count;
      else pendBtn.innerHTML = `Pendientes <span style="background:var(--error);color:#fff;font-size:10px;padding:2px 5px;border-radius:6px;margin-left:4px;">${count}</span>`;
    } else {
      if(currentCount) pendBtn.textContent = 'Pendientes';
    }
  }

  // STATS (sin cambios)
  function renderStats(){
    const stats = getStats();
    const pendientes = getQueue().length;
    const total = (stats.enviados||0) + pendientes;

    $("statEnviados").textContent = stats.enviados || 0;
    $("statPendientes").textContent = pendientes;
    $("statReenviados").textContent = stats.reenviados || 0;

    const exito = total > 0 ? Math.round(((stats.enviados||0) / total) * 100) : 0;
    $("statExito").textContent = `${exito}%`;

    $("barEnviados").style.width = total > 0 ? `${((stats.enviados||0)/total)*100}%` : '0%';
    $("barPendientes").style.width = total > 0 ? `${(pendientes/total)*100}%` : '0%';
    $("barReenviados").style.width = (stats.enviados||0) > 0 ? `${Math.min(100, ((stats.reenviados||0)/(stats.enviados||0))*100)}%` : '0%';
    $("barExito").style.width = `${exito}%`;

    const history = getHistory();
    const days = new Set(history.map(h => h.date)).size;
    const avg = days > 0 ? (history.length / days).toFixed(1) : 0;
    $("statPromedio").textContent = avg;
  }

  // INIT
  showTab('nuevo');
  loadDraft();
</script>

  
  <!-- === Registro de Service Worker y bot√≥n de instalaci√≥n PWA === -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('/App-Pedidos-ML/service-worker.js', { scope: '/App-Pedidos-ML/' })
      .then(r => console.log('‚úÖ SW registrado correctamente:', r.scope))
      .catch(err => console.error('‚ùå Error al registrar SW:', err));
  });
}

// üß© Evento que muestra bot√≥n ‚ÄúInstalar‚Äù en Android
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  const bar = document.querySelector('.bottom-nav');
  if (!bar || document.getElementById('btnInstall')) return;

  const btn = document.createElement('button');
  btn.id = 'btnInstall';
  btn.className = 'tab-btn active';
  btn.textContent = 'Instalar';
  btn.style.background = 'linear-gradient(90deg, var(--primary), var(--primary-2))';
  btn.style.color = '#fff';
  btn.style.boxShadow = '0 8px 22px rgba(var(--primary-rgb),.28)';
  bar.appendChild(btn);

  btn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') showToast('Instalaci√≥n iniciada', 'ok');
    deferredPrompt = null;
    btn.remove();
  });
});

window.addEventListener('appinstalled', () => {
  const b = document.getElementById('btnInstall');
  if (b) b.remove();
  showToast('App instalada ‚úîÔ∏è', 'ok');
});
</script>

  
</body>
</html>
