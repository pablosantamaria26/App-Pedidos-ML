<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos ML</title>
  <meta name="theme-color" content="#0d6efd">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    body{font-family:'Segoe UI',Roboto,Arial,sans-serif;background:#f2f5f8;margin:0;padding:0;overflow-x:hidden;color:#1f2937}
    #netBanner{display:none;background:#fde047;color:#1f2937;text-align:center;padding:8px;font-weight:600;font-size:14px}
    header{background:#0d6efd;color:white;text-align:center;padding:15px;font-size:20px;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
    main{padding:20px}
    label{font-size:14px;color:#374151}
    input,textarea{width:100%;font-size:16px;padding:10px;border-radius:10px;border:1px solid #ccc;margin-bottom:15px;box-sizing:border-box}
    button{background:#0d6efd;color:white;border:none;border-radius:12px;padding:16px;width:100%;font-size:18px;font-weight:600;cursor:pointer;transition:transform .1s ease,background .2s ease;box-shadow:0 4px 10px rgba(0,0,0,0.15)}
    button:active{transform:scale(0.97);background:#0b5ed7}
    .btn-secondary{background:#e0e7ff;color:#0d6efd;box-shadow:none}
    .btn-secondary:active{background:#c7d2fe}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#ffcd38;padding:12px 18px;border-radius:10px;font-size:15px;display:none;box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:9998}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ccc;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 -2px 6px rgba(0,0,0,0.15);z-index:9999}
    .bottom-nav button{flex:1;margin:0 6px;border-radius:8px;background:#e0e7ff;color:#0d6efd;font-weight:600;font-size:16px}
    .bottom-nav button.active{background:#0d6efd;color:white}
    .pedido-card{background:white;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    #confirmOverlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999}
    #confirmOverlay div{background:white;border-radius:20px;padding:40px;text-align:center;animation:popIn .4s ease}
    @keyframes popIn{0%{transform:scale(.7);opacity:0}70%{transform:scale(1.05);opacity:1}100%{transform:scale(1);opacity:1}}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px}
    .stat-card{background:white;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);text-align:center}
    .stat-title{font-size:13px;color:#6b7280;margin-bottom:6px}
    .stat-value{font-size:24px;font-weight:700}
    .stat-ok{color:#16a34a}.stat-warn{color:#d97706}.stat-info{color:#0ea5e9}.stat-gray{color:#6b7280}
  </style>
</head>

<body>
  <div id="netBanner">üì° Sin conexi√≥n ‚Äî los pedidos se guardan localmente</div>
  <header>üõí Pedidos ML</header>

  <!-- NUEVO PEDIDO -->
  <main id="nuevoPedido">
    <label>üìÖ Fecha de entrega</label>
    <input type="date" id="fechaEntrega">
    <label>üßæ N√∫mero de cliente</label>
    <input type="text" id="numeroCliente" placeholder="Ej: 10331">
    <label>üë§ Nombre del vendedor</label>
    <input type="text" id="nombreVendedor" placeholder="Ej: MARTIN">
    <label>üì¶ Productos solicitados</label>
    <textarea id="productos" rows="4" placeholder="Detalle de productos..."></textarea>
    <label>üóíÔ∏è Observaciones</label>
    <textarea id="observaciones" rows="2" placeholder="Notas adicionales..."></textarea>
    <button id="btnEnviar">Enviar pedido</button>
  </main>

  <!-- PENDIENTES -->
  <main id="pendientes" style="display:none;">
    <h3>üìã Pedidos pendientes</h3>
    <div id="listaPendientes"></div>
  </main>

  <!-- ESTAD√çSTICAS -->
  <main id="estadisticas" style="display:none;">
    <h3>üìä Estad√≠sticas (este dispositivo)</h3>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-title">Enviados</div><div class="stat-value stat-ok" id="statEnviados">0</div></div>
      <div class="stat-card"><div class="stat-title">Pendientes</div><div class="stat-value stat-warn" id="statPendientes">0</div></div>
      <div class="stat-card"><div class="stat-title">Reenviados</div><div class="stat-value stat-info" id="statReenviados">0</div></div>
      <div class="stat-card"><div class="stat-title">% √âxito</div><div class="stat-value stat-gray" id="statExito">0%</div></div>
    </div>
  </main>

  <div class="bottom-nav">
    <button id="btnNuevo" class="active">Nuevo</button>
    <button id="btnVerPendientes">Pendientes</button>
    <button id="btnVerEstadisticas">Estad√≠sticas</button>
  </div>

  <div class="toast" id="toast"></div>

  <div id="confirmOverlay">
    <div>
      <div style="font-size:80px;color:#22c55e;">‚úÖ</div>
      <h2 style="margin-top:10px;color:#333;">¬°Pedido enviado!</h2>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxPAwRf6K5d7xf-UfcM79wVOE1aMGfn6zT0pp_rF6Ta6qAGoCO8ZIEe2RWLlVP1WRIxEg/exec";

    // === UTILIDADES ===
    function vibrar(ms=50){if('vibrate' in navigator)navigator.vibrate(ms);}
    function mostrarToast(msg,error=false){
      const t=document.getElementById("toast");
      t.textContent=msg;
      t.style.background=error?"#f87171":"#ffcd38";
      t.style.display="block";
      setTimeout(()=>t.style.display="none",4000);
    }
    function mostrarConfirmacion(){
      const o=document.getElementById("confirmOverlay");
      o.style.display="flex"; vibrar(150);
      setTimeout(()=>o.style.display="none",1800);
    }

    // === LOCAL STORAGE ===
    const getQueue=()=>JSON.parse(localStorage.getItem("pedidosPendientes")||"[]");
    const setQueue=a=>localStorage.setItem("pedidosPendientes",JSON.stringify(a));
    const getStats=()=>JSON.parse(localStorage.getItem("statsPedidos")||'{"enviados":0,"reenviados":0}');
    const setStats=s=>localStorage.setItem("statsPedidos",JSON.stringify(s));
    const getEnviados=()=>JSON.parse(localStorage.getItem("pedidosEnviados")||"[]");
    const setEnviados=a=>localStorage.setItem("pedidosEnviados",JSON.stringify(a));

    function incStat(k){const s=getStats();s[k]=(s[k]||0)+1;setStats(s);renderStats();}
    function renderStats(){
      const s=getStats(),pend=getQueue().length;
      const total=(s.enviados||0)+(s.reenviados||0)+pend;
      const exito=total>0?Math.round(((s.enviados||0)+(s.reenviados||0))*100/total):0;
      document.getElementById("statEnviados").textContent=s.enviados||0;
      document.getElementById("statPendientes").textContent=pend;
      document.getElementById("statReenviados").textContent=s.reenviados||0;
      document.getElementById("statExito").textContent=exito+"%";
    }

    // === ENV√çO AL BACKEND ===
    async function postPedido(pedido){
      await fetch(BACKEND_URL,{
        method:"POST", mode:"no-cors",
        headers:{"Content-Type":"text/plain"},
        body:JSON.stringify(pedido)
      });
    }

    // === GUARDAR LOCAL Y DESCARTAR DUPLICADOS ===
    function guardarLocal(pedido){
      const q=getQueue();
      if(q.some(p=>p.id===pedido.id)){ // ya existe
        console.warn("Pedido duplicado no guardado localmente:",pedido.id);
        return;
      }
      q.push(pedido);
      setQueue(q); renderStats();
      mostrarToast("üì° Sin conexi√≥n. Pedido guardado localmente.");
    }

    // === ENV√çO PRINCIPAL CON BLOQUEO ===
    const btnEnviar=document.getElementById("btnEnviar");
    let enviando=false;

    btnEnviar.addEventListener("click",async()=>{
      if(enviando) return;
      enviando=true; btnEnviar.disabled=true; btnEnviar.textContent="Enviando...";
      vibrar();

      const pedido={
        id:Date.now(),
        fechaEntrega:fechaEntrega.value,
        numeroCliente:numeroCliente.value.trim(),
        nombreVendedor:nombreVendedor.value.trim(),
        productos:productos.value.trim(),
        observaciones:observaciones.value.trim()
      };
      if(!pedido.fechaEntrega||!pedido.numeroCliente||!pedido.nombreVendedor||!pedido.productos){
        mostrarToast("‚ö†Ô∏è Complet√° todos los campos obligatorios",true);
        enviando=false; btnEnviar.disabled=false; btnEnviar.textContent="Enviar pedido";
        return;
      }

      // evitar reenv√≠o del mismo ID
      const enviados=getEnviados();
      if(enviados.includes(pedido.id)){
        mostrarToast("‚ö†Ô∏è Pedido ya enviado. Evitado duplicado.",true);
        enviando=false; btnEnviar.disabled=false; btnEnviar.textContent="Enviar pedido";
        return;
      }

      if(!navigator.onLine){guardarLocal(pedido);}
      else{
        try{
          await postPedido(pedido);
          incStat("enviados"); mostrarConfirmacion();
          enviados.push(pedido.id); setEnviados(enviados);
          fechaEntrega.value=numeroCliente.value=nombreVendedor.value=productos.value=observaciones.value="";
        }catch(e){console.error(e); guardarLocal(pedido);}
      }

      enviando=false; btnEnviar.disabled=false; btnEnviar.textContent="Enviar pedido";
    });

    // === AUTO-SYNC AUTOM√ÅTICO AL VOLVER CONEXI√ìN ===
    async function syncPendientes(){
      const q=[...getQueue()];
      if(!q.length||!navigator.onLine) return;
      for(const p of q){
        try{
          await postPedido(p);
          const enviados=getEnviados(); if(!enviados.includes(p.id)) enviados.push(p.id);
          setEnviados(enviados);
          setQueue(getQueue().filter(x=>x.id!==p.id));
          incStat("reenviados");
        }catch(e){console.error("‚ùå Falla al reenviar",e);}
      }
      cargarPendientes();
      mostrarToast("üîÑ Pendientes sincronizados");
    }
    window.addEventListener("online",syncPendientes);

    // === PENDIENTES ===
    async function reenviarPedido(id){
      vibrar();
      const q=getQueue();
      const pedido=q.find(p=>String(p.id)===String(id));
      if(!pedido)return;
      if(!navigator.onLine){mostrarToast("‚ö†Ô∏è Sin conexi√≥n",true);return;}
      try{
        await postPedido(pedido);
        setQueue(q.filter(p=>p.id!==pedido.id));
        const enviados=getEnviados(); enviados.push(pedido.id); setEnviados(enviados);
        incStat("reenviados"); cargarPendientes();
        mostrarToast("‚úÖ Pedido reenviado");
      }catch(e){console.error(e);mostrarToast("‚ùå Error al reenviar",true);}
    }

    function cargarPendientes(){
      const c=document.getElementById("listaPendientes");
      c.innerHTML="";
      const q=getQueue();
      if(!q.length){c.innerHTML="<p>No hay pedidos pendientes.</p>";}
      else q.forEach(p=>{
        const d=document.createElement("div");
        d.className="pedido-card";
        d.innerHTML=`<b>Cliente:</b> ${p.numeroCliente}<br>
        <b>Vendedor:</b> ${p.nombreVendedor}<br>
        <b>Fecha:</b> ${p.fechaEntrega}<br><hr>
        <button onclick="reenviarPedido('${p.id}')">üîÑ Reenviar</button>`;
        c.appendChild(d);
      });
      renderStats();
    }

    // === NAVEGACI√ìN ===
    const secciones={nuevo:nuevoPedido,pend:pendientes,stats:estadisticas};
    const botones={nuevo:btnNuevo,pend:btnVerPendientes,stats:btnVerEstadisticas};
    function cambiarSeccion(n){
      vibrar();
      Object.values(botones).forEach(b=>b.classList.remove("active"));
      Object.values(secciones).forEach(s=>s.style.display="none");
      botones[n].classList.add("active");
      secciones[n].style.display="block";
      if(n==="pend")cargarPendientes();
      if(n==="stats")renderStats();
    }
    botones.nuevo.onclick=()=>cambiarSeccion("nuevo");
    botones.pend.onclick=()=>cambiarSeccion("pend");
    botones.stats.onclick=()=>cambiarSeccion("stats");

    // === CONEXI√ìN Y SW ===
    function setOnlineStatus(on){document.getElementById("netBanner").style.display=on?"none":"block";}
    window.addEventListener("online",()=>setOnlineStatus(true));
    window.addEventListener("offline",()=>setOnlineStatus(false));
    setOnlineStatus(navigator.onLine);

    if("serviceWorker" in navigator)
      navigator.serviceWorker.register("service-worker.js").then(()=>console.log("‚úÖ SW OK")).catch(e=>console.error("SW err",e));

    renderStats();
  </script>
</body>
</html>
