<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Pedidos ML</title>
  <meta name="theme-color" content="#4f46e5" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #4f46e5;
      --primary-light: rgba(79, 70, 229, 0.2);
      --bg: #f4f5f9;
      --text: #111827;
      --card: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
      --success: #16a34a;
      --error: #ef4444;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0d1117;
        --text: #e6edf3;
        --card: #161b22;
        --muted: #8b949e;
        --border: #30363d;
        --shadow: 0 4px 12px rgba(0,0,0,0.2);
        --shadow-lg: 0 10px 30px rgba(0,0,0,0.3);
      }
    }

    html,body{ height: 100%; }
    body{
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      /* Ajuste clave: AÃ±ade padding inferior para que el contenido no quede oculto por el botÃ³n fijo y la barra de nav */
      padding: 0 0 180px 0;
      background: var(--bg); color: var(--text);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* --- Header --- */
    header{
      position: sticky; top: 0; z-index: 1000;
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--text);
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    @media (prefers-color-scheme: dark){
      header{ background: rgba(22, 27, 34, 0.7); }
    }
    .header-title{ font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;}
    #pedidoContador{
      background: var(--primary);
      color: white;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 99px;
      min-width: 12px;
      text-align: center;
    }
    #connDot{
      width: 12px; height: 12px; border-radius: 50%;
      border: 2px solid var(--bg);
      box-shadow: 0 0 0 2px var(--border);
    }
    .online{ background: #22c55e; }
    .offline{ background: #ef4444; }
    .syncing{ background: #facc15; animation:pulse 0.8s ease-in-out infinite alternate; }
    @keyframes pulse{ from{ opacity: 1; } to{ opacity: 0.4; } }

    #netBanner{
      display:none; text-align:center;
      background:#facc15; color:#1f2937;
      padding: 8px; font-weight: 600; font-size: 14px;
    }

    /* --- Main Layout --- */
    main{ padding: 20px; max-width: 860px; margin: 0 auto; }
    h3 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }

    /* --- Form Elements --- */
    .row { margin-bottom: 18px; }
    label {
        display: flex; align-items: center;
        font-size: 14px; font-weight: 500; color: var(--muted);
        margin-bottom: 8px;
    }
    input, textarea, select {
      width: 100%; box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      font-size: 16px; padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card); color: var(--text);
      outline: none;
      transition: all .2s ease;
      -webkit-appearance: none;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    textarea { min-height: 120px; resize: vertical; }

    /* === NUEVOS CAMBIOS: Ocultar elementos visualmente === */
    .row:has(#shareWA) {
        display: none;
    }
    #btnNuevoLote {
        display: none;
    }

    /* === NUEVOS CAMBIOS: BotÃ³n de Enviar Flotante === */
    #btnEnviar {
        position: fixed;
        bottom: 90px; /* Altura para quedar justo sobre la barra de navegaciÃ³n */
        left: 50%;
        transform: translateX(-50%);
        z-index: 998;

        width: 90%;
        max-width: 420px; /* Un mÃ¡ximo para pantallas mÃ¡s grandes */
        
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 16px;
        padding: 18px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        transition: transform .1s ease, filter .15s ease, background .2s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;

        background: linear-gradient(45deg, var(--primary), #6366f1);
        color: #fff;
    }
    #btnEnviar:active {
        transform: translateX(-50%) scale(0.97);
        filter: brightness(1.1);
    }
    #btnEnviar[disabled] {
        opacity: .7;
        cursor: not-allowed;
        filter: grayscale(.2);
        box-shadow: var(--shadow);
    }

    /* --- Spinner --- */
    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .btn[disabled] .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- Bottom Navigation --- */
    .bottom-nav{
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 999;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      display: flex; gap: 10px; padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    @media (prefers-color-scheme: dark){ .bottom-nav{ background: rgba(22, 27, 34, 0.7); } }
    .bottom-nav button{
      flex: 1; border-radius: 12px; padding: 14px 8px; font-weight: 600;
      border: none; background: transparent; color: var(--muted);
      transition: all .2s ease;
    }
    .bottom-nav button.active{ background: var(--primary); color: #fff; }

    /* --- Pending & Stats Cards --- */
    .pedido-card, .stat-card {
      background: var(--card); border-radius: 16px; padding: 16px;
      margin-bottom: 14px; box-shadow: var(--shadow);
    }
    .pedido-card hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }

    /* --- Toast Notifications --- */
    .toast{
      position: fixed; left: 50%; top: 16px; transform: translateX(-50%);
      color: #fff; padding: 14px 20px; border-radius: 12px;
      font-size: 15px; font-weight: 500;
      box-shadow: var(--shadow-lg); z-index: 1001;
      opacity: 0; animation: fadeInDown .3s ease forwards;
    }
    @keyframes fadeInDown {
      from { top: -20px; opacity: 0; }
      to { top: 16px; opacity: 1; }
    }

    /* --- Success Overlay --- */
    #confirmOverlay{
      display: none; position: fixed; inset: 0; z-index: 1002;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      align-items: center; justify-content: center;
      animation: fadeIn .3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .success-box{
      background: var(--card);
      color: var(--text); border-radius: 24px; padding: 36px 28px; text-align: center;
      width: min(90vw, 320px); box-shadow: var(--shadow-lg);
      animation: popIn .35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .success-box h2{ margin: 16px 0 0 0; font-size: 22px; }
    .success-box p { opacity:.7; margin:6px 0 0 0; }

    /* Animated Checkmark SVG */
    .checkmark-svg { width: 80px; height: 80px; }
    .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke: var(--success); fill: none; animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
    .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke-width: 4; stroke: var(--success); stroke-linecap: round; fill: none; animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }

    /* --- Stats Section --- */
    .stats-grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 8px; }
    .stat-title{ font-size: 13px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
    .stat-value{ font-size: 26px; font-weight: 700; }
    .bar{ margin-top: 10px; height: 8px; border-radius: 999px; background: var(--border); overflow: hidden; }
    .bar > .fill{ height: 100%; width: 0%; background: var(--primary); transition: width .4s ease; }

    /* --- Theme Selector --- */
    .theme-row{ display:flex; align-items:center; gap:12px; margin: 6px 0 20px 0; flex-wrap:wrap; }
    .theme-row span { font-weight: 600; }
    .swatch{
      width: 32px; height: 32px; border-radius: 50%;
      border: 3px solid var(--card);
      cursor: pointer; box-shadow: 0 0 0 1px var(--border);
      transition: transform .15s ease;
    }
    .swatch:hover { transform: scale(1.1); }

    /* --- Search --- */
    .search-row{ display: flex; gap: 8px; margin-bottom: 16px; }
    .search-row input{ flex:1; }
    .search-row .btn, .search-row .btn-secondary {
        width: auto; flex-shrink: 0; padding: 14px; min-width: 60px;
    }
  </style>
</head>
<body>
  <div id="netBanner">ğŸ“¡ Sin conexiÃ³n â€” los pedidos se guardan localmente</div>
  <header>
    <div class="header-title">
        <span>ğŸ›’ Pedidos ML</span>
        <span id="pedidoContador">0</span>
    </div>
    <div id="connDot" class="offline"></div>
  </header>

  <main id="nuevoPedido">
    <div id="helloBanner"></div>
    <div class="theme-row">
      <span>ğŸ¨</span>
      <div class="swatch" data-color="#4f46e5" title="Indigo" style="background:#4f46e5"></div>
      <div class="swatch" data-color="#16a34a" title="Verde" style="background:#16a34a"></div>
      <div class="swatch" data-color="#db2777" title="Rosa" style="background:#db2777"></div>
      <div class="swatch" data-color="#d97706" title="Naranja" style="background:#d97706"></div>
    </div>

    <div class="row" id="rowFecha">
      <label>ğŸ“… Fecha de entrega</label>
      <input type="date" id="fechaEntrega" />
    </div>
    <div class="row" id="rowCliente">
      <label>ğŸ§¾ NÃºmero de cliente</label>
      <input type="number" inputmode="numeric" id="numeroCliente" placeholder="Ej: 10331" />
    </div>
    <div class="row" id="rowVendedor">
      <label>ğŸ‘¤ Nombre del vendedor</label>
      <input type="text" id="nombreVendedor" placeholder="Ej: MARTIN" />
    </div>
    <div class="row" id="rowProductos">
      <label>ğŸ“¦ Productos solicitados</label>
      <textarea id="productos" rows="4" placeholder="Detalle de productos..."></textarea>
    </div>
    <div class="row" id="rowObs">
      <label>ğŸ—’ï¸ Observaciones (opcional)</label>
      <textarea id="observaciones" rows="2" placeholder="Notas adicionales..."></textarea>
    </div>
    <div class="row">
        <label style="flex-direction: row; align-items: center; gap: 8px; font-weight: normal; color: var(--text);">
            <input type="checkbox" id="shareWA" style="width: auto;" />
            Enviar resumen por WhatsApp a Laura
        </label>
    </div>

    <div class="toolbar">
      <button id="btnEnviar" class="btn">
        <span class="btn-text">Enviar pedido</span>
        <div class="spinner" style="display: none;"></div>
      </button>
      <button id="btnNuevoLote" class="btn-secondary">Agregar otro (mismo dÃ­a/vendedor)</button>
    </div>
  </main>

  <main id="pendientes" style="display:none;">
    <h3>ğŸ“‹ Pedidos pendientes</h3>
    <div class="search-row">
      <input id="searchPend" type="search" placeholder="Buscar por cliente o vendedor..." />
      <button id="btnSyncHoy" class="btn-secondary" title="Reenviar solo los de hoy">Hoy</button>
      <button id="btnReintentarTodos" class="btn">Todos</button>
    </div>
    <div id="listaPendientes"></div>
  </main>

  <main id="estadisticas" style="display:none;">
    <h3>ğŸ“Š EstadÃ­sticas (este dispositivo)</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Enviados</div>
        <div id="statEnviados" class="stat-value">0</div>
        <div class="bar"><div id="barEnviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Pendientes</div>
        <div id="statPendientes" class="stat-value">0</div>
        <div class="bar"><div id="barPendientes" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Reenviados</div>
        <div id="statReenviados" class="stat-value">0</div>
        <div class="bar"><div id="barReenviados" class="fill"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-title">% Ã‰xito</div>
        <div id="statExito" class="stat-value">0%</div>
        <div class="bar"><div id="barExito" class="fill"></div></div>
      </div>
    </div>
    <div class="stat-card" style="margin-top:14px;">
      <div class="stat-title">Promedio de pedidos enviados por dÃ­a</div>
      <div id="statPromedio" class="stat-value">0</div>
    </div>
  </main>

  <div class="bottom-nav">
    <button id="btnNuevo" class="tab-btn active">Nuevo</button>
    <button id="btnVerPendientes" class="tab-btn">Pendientes</button>
    <button id="btnVerEstadisticas" class="tab-btn">EstadÃ­sticas</button>
  </div>

  <div id="toast-container"></div>

  <div id="confirmOverlay">
    <div class="success-box">
        <svg class="checkmark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      <h2 style="margin:10px 0 0 0;">Â¡Pedido enviado!</h2>
      <p style="opacity:.9;margin:6px 0 0 0;">Se guardÃ³ correctamente</p>
    </div>
  </div>

<script>
    // ==== CONFIG ====
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxPAwRf6K5d7xf-UfcM79wVOE1aMGfn6zT0pp_rF6Ta6qAGoCO8ZIEe2RWLlVP1WRIxEg/exec";

    // ==== ELEMENTOS ====
    const $ = id => document.getElementById(id);
    const fechaEntrega = $("fechaEntrega");
    const numeroCliente = $("numeroCliente");
    const nombreVendedor = $("nombreVendedor");
    const productos = $("productos");
    const observaciones = $("observaciones");
    const btnEnviar = $("btnEnviar");
    const btnNuevoLote = $("btnNuevoLote");
    const toastContainer = $("toast-container");
    const connDot = $("connDot");
    const netBanner = $("netBanner");
    const helloBanner = $("helloBanner");
    const shareWA = $("shareWA");
    const searchPend = $("searchPend");
    const pedidoContador = $("pedidoContador"); // Nuevo elemento contador

    // ==== SONIDO & VIBRACIÃ“N ====
    const sndOk = new Audio("data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA");
    function vib(ms=70){ if('vibrate' in navigator) navigator.vibrate(ms); }
    function playOk(){ try{ sndOk.currentTime=0; sndOk.play(); }catch{} }

    // ==== TOAST NOTIFICATION ====
    function showToast(msg, type="info"){
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      let bgColor = "#ffcd38";
      let color = "#1f2937";
      if (type === "error") { bgColor = "#ef4444"; color = "#fff"; }
      if (type === "ok") { bgColor = "#22c55e"; color = "#fff"; }
      toast.style.background = bgColor;
      toast.style.color = color;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    // ==== THEME ====
    (()=>{
      const stored = localStorage.getItem("themeColor");
      if(stored) document.documentElement.style.setProperty("--primary", stored);
      document.querySelectorAll(".swatch").forEach(s=>{
        s.addEventListener("click", ()=>{
          const c = s.getAttribute("data-color");
          document.documentElement.style.setProperty("--primary", c);
          localStorage.setItem("themeColor", c);
        });
      });
    })();

    // ==== STORAGE ====
    const getQueue = () => JSON.parse(localStorage.getItem("pedidosPendientes") || "[]");
    const setQueue = arr => localStorage.setItem("pedidosPendientes", JSON.stringify(arr));
    const getStats = () => JSON.parse(localStorage.getItem("statsPedidos") || '{"enviados":0,"reenviados":0}');
    const setStats = s => localStorage.setItem("statsPedidos", JSON.stringify(s));
    const getHistory = () => JSON.parse(localStorage.getItem("historialEnviados") || "[]");
    const setHistory = h => localStorage.setItem("historialEnviados", JSON.stringify(h));
    const getSentIds = () => new Set(JSON.parse(localStorage.getItem("idsEnviados") || "[]"));
    const addSentId = (id) => {
      const arr = JSON.parse(localStorage.getItem("idsEnviados") || "[]");
      if(!arr.includes(id)) arr.push(id);
      localStorage.setItem("idsEnviados", JSON.stringify(arr));
    }

    // ==== DRAFT ====
    const DRAFT_KEY = "draftPedido";
    function saveDraft(){
      const d = {
        fechaEntrega: fechaEntrega.value,
        numeroCliente: numeroCliente.value,
        nombreVendedor: nombreVendedor.value,
        productos: productos.value,
        observaciones: observaciones.value
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
    }
    function loadDraft(){
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        fechaEntrega.value = d.fechaEntrega || fechaEntrega.value;
        numeroCliente.value = d.numeroCliente || "";
        nombreVendedor.value = d.nombreVendedor || nombreVendedor.value;
        productos.value = d.productos || "";
        observaciones.value = d.observaciones || "";
      }catch{}
    }
    [fechaEntrega,numeroCliente,nombreVendedor,productos,observaciones].forEach(el=> el.addEventListener("input", saveDraft));

    // ==== PREFILL & GREETING ====
    (function prefill(){
      const vend = localStorage.getItem("vendedorNombre");
      if(vend) nombreVendedor.value = vend;
      const today = new Date().toISOString().slice(0,10);
      if(!fechaEntrega.value) fechaEntrega.value = today;
      helloBanner.style.display = vend ? "block" : "none";
      if(vend) helloBanner.textContent = `Hola ${vend} ğŸ‘‹`;
    })();
    numeroCliente.addEventListener("input", ()=> numeroCliente.value = numeroCliente.value.replace(/[^\d]/g,""));

    // ==== DAILY COUNTER ====
    function actualizarContadorDiario(increment = false) {
        const key = 'dailyCounter';
        const today = new Date().toISOString().slice(0, 10);
        let data = { date: today, count: 0 };
        try {
            const stored = JSON.parse(localStorage.getItem(key));
            if (stored && stored.date === today) {
                data = stored;
            }
        } catch {}

        if (increment) {
            data.count++;
        }
        localStorage.setItem(key, JSON.stringify(data));
        pedidoContador.textContent = data.count;
    }

    // ==== STATS ====
    function renderStats(){
      const s = getStats();
      const pend = getQueue().length;
      const enviados = s.enviados||0, reenviados = s.reenviados||0;
      const total = enviados + reenviados + pend;
      const ok = enviados + reenviados;
      const exito = total>0 ? Math.round(ok*100/total) : 0;

      $("statEnviados").textContent = enviados;
      $("statPendientes").textContent = pend;
      $("statReenviados").textContent = reenviados;
      $("statExito").textContent = exito + "%";
      $("barEnviados").style.width = total>0 ? (enviados*100/total)+"%" : "0%";
      $("barPendientes").style.width = total>0 ? (pend*100/total)+"%" : "0%";
      $("barReenviados").style.width = total>0 ? (reenviados*100/total)+"%" : "0%";
      $("barExito").style.width = exito+"%";
      
      const hist = getHistory();
      const byDay = {};
      hist.forEach(h=>{
        const day = (new Date(h.timestamp)).toISOString().slice(0,10);
        byDay[day] = (byDay[day]||0)+1;
      });
      const days = Object.keys(byDay).length || 1;
      const totalEnv = hist.length;
      $("statPromedio").textContent = (totalEnv/days).toFixed(1);
    }
    function incStat(k){ const s = getStats(); s[k]=(s[k]||0)+1; setStats(s); renderStats(); }

    // ==== PENDING ====
    function cardHtml(p){
      return `<div class="pedido-card">
        <b>Cliente:</b> ${p.numeroCliente||"â€”"}<br>
        <b>Vendedor:</b> ${p.nombreVendedor||"â€”"}<br>
        <b>Fecha:</b> ${p.fechaEntrega||"â€”"}<br>
        <hr>
        <div class="toolbar" style="gap:8px; margin-top: 12px; flex-direction: row;">
          <button class="btn" onclick="reenviarPedido('${p.id}')">ğŸ”„ Reenviar</button>
          <button class="btn-secondary" onclick="eliminarPendiente('${p.id}')">ğŸ—‘ï¸ Eliminar</button>
        </div>
      </div>`;
    }
    function cargarPendientes(){
      const cont = $("listaPendientes");
      const q = getQueue();
      const qf = searchPend.value.trim().toLowerCase();
      let filtered = q;
      if(qf){
        filtered = q.filter(p =>
          String(p.numeroCliente||"").toLowerCase().includes(qf) ||
          String(p.nombreVendedor||"").toLowerCase().includes(qf)
        );
      }
      cont.innerHTML = filtered.length ? filtered.map(cardHtml).join("") : "<p>No hay pedidos pendientes.</p>";
      renderStats();
      if(q.length>10) showToast("âš ï¸ Hay muchos pendientes (>10). Recomendado sincronizar.", "info");
    }
    searchPend.addEventListener("input", cargarPendientes);

    // ==== CONNECTION ====
    function setOnlineStatus(on){
      netBanner.style.display = on ? "none" : "block";
      connDot.className = on ? "online" : "offline";
    }
    window.addEventListener("online", async ()=>{
      setOnlineStatus(true);
      await syncPendientes(true);
    });
    window.addEventListener("offline", ()=> setOnlineStatus(false));
    setOnlineStatus(navigator.onLine);

    // ==== NOTIFICATIONS ====
    async function ensureNotiPerm(){
      try{
        if(!("Notification" in window)) return;
        if(Notification.permission==="granted") return;
        if(Notification.permission!=="denied") await Notification.requestPermission();
      }catch{}
    }
    function notify(title, body){
      try{
        if(("Notification" in window) && Notification.permission==="granted"){
          new Notification(title, { body });
        }
      }catch{}
    }

    // ==== BACKEND POST ====
    async function postPedido(pedido) {
      try {
        await fetch(BACKEND_URL, {
          method: "POST", mode: "no-cors",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(pedido)
        });
        console.log("âœ… Pedido enviado (modo no-cors)");
        return { status: "ok" };
      } catch (e) {
        console.error("âŒ Error en fetch:", e);
        throw e;
      }
    }

    // ==== QUEUE & RETRY ====
    async function reenviarPedido(id){
      vib();
      if(!navigator.onLine){ showToast("Sin conexiÃ³n para reenviar", "error"); return; }
      const q = getQueue();
      const p = q.find(x => String(x.id)===String(id));
      if(!p) return;
      try{
        const data = await postPedido(p);
        setQueue(q.filter(x => String(x.id)!==String(id)));
        incStat("reenviados");
        cargarPendientes();
        showToast(data.status==="duplicate" ? "Duplicado detectado (descartado)" : "Pedido reenviado", data.status==="duplicate"?"info":"ok");
        connDot.className = "syncing"; setTimeout(()=>setOnlineStatus(true), 700);
        notify("ReenvÃ­o OK","El pedido fue reenviado correctamente");
      }catch(e){
        console.error(e); showToast("Error al reenviar", "error");
      }
    }
    window.reenviarPedido = reenviarPedido;

    function eliminarPendiente(id){
      const q = getQueue().filter(x => String(x.id)!==String(id));
      setQueue(q);
      cargarPendientes();
      showToast("Pedido eliminado de pendientes", "info");
    }
    window.eliminarPendiente = eliminarPendiente;

    async function reintentarTodos(filterToday=false){
      if(!navigator.onLine){ showToast("Sin conexiÃ³n", "error"); return; }
      const q = getQueue();
      if(!q.length){ showToast("No hay pendientes", "info"); return; }
      const today = new Date().toISOString().slice(0,10);
      let toSend = filterToday ? q.filter(p => (p.fechaEntrega||"").slice(0,10)===today) : q;
      if(!toSend.length){ showToast(filterToday ? "No hay pendientes de hoy" : "No hay pendientes", "info"); return; }
      for(const p of [...toSend]){
        try{
          await postPedido(p);
          setQueue(getQueue().filter(x => String(x.id)!==String(p.id)));
          incStat("reenviados");
        }catch{}
      }
      cargarPendientes();
      showToast(filterToday ? "Reenviados los de hoy" : "Reintento completo", "ok");
      connDot.className = "syncing"; setTimeout(()=>setOnlineStatus(true), 700);
      notify("SincronizaciÃ³n","Se reenviaron pedidos pendientes");
    }
    $("btnReintentarTodos").addEventListener("click", ()=> reintentarTodos(false));
    $("btnSyncHoy").addEventListener("click", ()=> reintentarTodos(true));

    // ==== SEND NEW ORDER ====
    let sending = false;
    const lastSent = getSentIds();
    function buildPedido(){
      return {
        id: Date.now(),
        fechaEntrega: fechaEntrega.value,
        numeroCliente: (numeroCliente.value||"").trim(),
        nombreVendedor: (nombreVendedor.value||"").trim(),
        productos: (productos.value||"").trim(),
        observaciones: (observaciones.value||"").trim()
      };
    }
    function validPedido(p){ return p.fechaEntrega && p.numeroCliente && p.nombreVendedor && p.productos; }
    function guardarLocal(p){
      const q = getQueue(); q.push(p); setQueue(q);
      renderStats();
      showToast("ğŸ“¡ Guardado local por conexiÃ³n", "info");
    }

    async function enviarPedido(p, options = { mass: false }) {
        if (sending) return;
        if (lastSent.has(p.id)) { showToast("Duplicado detectado (id repetido)", "info"); return; }

        sending = true;
        btnEnviar.disabled = true;
        btnEnviar.querySelector('.spinner').style.display = 'block';

        try {
            if (!navigator.onLine) throw new Error("offline");
            postPedido(p);

            addSentId(p.id);
            lastSent.add(p.id);
            if (p.nombreVendedor) localStorage.setItem("vendedorNombre", p.nombreVendedor);
            helloBanner.style.display = "block";
            helloBanner.textContent = `Hola ${p.nombreVendedor} ğŸ‘‹`;

            const hist = getHistory();
            hist.push({ id: p.id, timestamp: Date.now(), numeroCliente: p.numeroCliente, vendedor: p.nombreVendedor });
            setHistory(hist);
            
            incStat("enviados");
            actualizarContadorDiario(true); // Incrementar contador
            playOk();
            vib(140);
            showSuccess();
            notify("Pedido enviado", "Se registrÃ³ correctamente");

            if (shareWA.checked) {
                const txt = `Pedido ML%0ACliente: ${encodeURIComponent(p.numeroCliente)}%0AVendedor: ${encodeURIComponent(p.nombreVendedor)}%0AFecha: ${encodeURIComponent(p.fechaEntrega)}%0AProductos:%0A${encodeURIComponent(p.productos)}`;
                window.open(`https://wa.me/5491133395487?text=${txt}`, "_blank");
            }

            if (options.mass) {
                numeroCliente.value = ""; productos.value = ""; observaciones.value = "";
                productos.focus();
            } else {
                fechaEntrega.value = new Date().toISOString().slice(0,10);
                numeroCliente.value = ""; productos.value = ""; observaciones.value = "";
            }
            saveDraft();
        } catch (e) {
            console.error("âŒ Error en envÃ­o:", e);
            guardarLocal(p);
        } finally {
            sending = false;
            btnEnviar.disabled = false;
            btnEnviar.querySelector('.spinner').style.display = 'none';
        }
    }

    function showSuccess(){
      const ov = $("confirmOverlay");
      ov.style.display = "flex";
      setTimeout(()=> ov.style.display = "none", 1800);
    }

    btnEnviar.addEventListener("click", ()=>{
      vib();
      const p = buildPedido();
      if(!validPedido(p)){ showToast("CompletÃ¡ todos los campos obligatorios","error"); return; }
      enviarPedido(p, {mass:false});
    });

    btnNuevoLote.addEventListener("click", ()=>{
      vib();
      const p = buildPedido();
      if(!validPedido(p)){ showToast("CompletÃ¡ todos los campos obligatorios","error"); return; }
      enviarPedido(p, {mass:true});
    });

    // ==== AUTO-SYNC ====
    async function syncPendientes(animate=false){
      if(!navigator.onLine) return;
      const q = getQueue(); if(!q.length) return;
      if(animate){ connDot.className = "syncing"; }
      for(const p of [...q]){
        try{
          await postPedido(p);
          setQueue(getQueue().filter(x => x.id!==p.id));
          incStat("reenviados");
        }catch{}
      }
      cargarPendientes();
      if(animate){ setTimeout(()=> setOnlineStatus(true), 700); }
      notify("Sincronizado","Se reenviaron pedidos pendientes");
    }

    // ==== TABS ====
    const sections = {nuevo:$("nuevoPedido"), pend:$("pendientes"), stats:$("estadisticas")};
    const tabs = {nuevo:$("btnNuevo"), pend:$("btnVerPendientes"), stats:$("btnVerEstadisticas")};
    function setTab(name){
      vib(40);
      Object.values(tabs).forEach(b=> b.classList.remove("active"));
      Object.values(sections).forEach(s=> s.style.display="none");
      tabs[name].classList.add("active");
      sections[name].style.display="block";

      // Mostrar u ocultar el botÃ³n flotante segÃºn la pestaÃ±a
      if (name === 'nuevo') {
        btnEnviar.style.display = 'flex';
      } else {
        btnEnviar.style.display = 'none';
      }

      if(name==="pend") cargarPendientes();
      if(name==="stats") renderStats();
    }
    tabs.nuevo.onclick = ()=> setTab("nuevo");
    tabs.pend.onclick = ()=> setTab("pend");
    tabs.stats.onclick = ()=> setTab("stats");

    // ==== INIT & MISC ====
    window.addEventListener("beforeunload", (e)=>{
      if(getQueue().length>0){ e.preventDefault(); e.returnValue = ""; }
    });
    (function dailyReminder(){
      const key = "reminderDate", today = new Date().toISOString().slice(0,10);
      const last = localStorage.getItem(key);
      if(last!==today && getQueue().length>0){
        showToast("â° Tienes pedidos sin enviar. Recordatorio diario.", "info");
        localStorage.setItem(key, today);
      }
    })();

    loadDraft();
    renderStats();
    ensureNotiPerm();
    setTab("nuevo");
    actualizarContadorDiario(); // Inicializar contador

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js')
        .then(()=>console.log('âœ… Service Worker registrado'))
        .catch(err=>console.log('âŒ SW error',err));
    }
</script>
</body>
</html>
